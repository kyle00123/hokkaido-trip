<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>北緯43°の約定 2025</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #F0F9FF; 
            color: #334155;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            overflow-x: hidden;
            padding-bottom: 110px;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Banner */
        .banner-container {
            height: 280px; 
            width: 100%;
            position: relative;
            z-index: 0;
            overflow: hidden;
        }
        .banner-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            filter: brightness(0.9); 
        }

        /* Main Content */
        .main-content {
            position: relative;
            z-index: 10;
            margin-top: -40px; 
            background: #F0F9FF; 
            border-top-left-radius: 32px;
            border-top-right-radius: 32px;
            min-height: calc(100vh - 240px);
            padding-top: 24px; 
            padding-bottom: 40px;
            box-shadow: 0 -10px 25px rgba(14, 165, 233, 0.15);
        }

        /* Apple Style Dock */
        .apple-dock-container {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            justify-content: center;
            width: auto;
        }

        .apple-dock {
            display: flex;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.5) inset;
        }

        .dock-item {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #94A3B8;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
        }

        .dock-item.active {
            background: #0EA5E9;
            color: white;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
            transform: translateY(-6px);
        }

        /* FAB */
        .fab-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #FCD34D 0%, #F59E0B 100%);
            border-radius: 50%;
            color: #78350F;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
            z-index: 50;
            transition: transform 0.2s;
            border: 2px solid rgba(255,255,255,0.4);
        }
        .fab-btn:active { transform: scale(0.9); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Travel Time Connector */
        .travel-connector {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: -6px 0;
            z-index: 0;
            padding: 8px 0;
        }
        .travel-line { height: 18px; width: 0; border-left: 2px dashed #cbd5e1; }
        .travel-badge {
            background: #f8fafc; color: #64748b; font-size: 10px; padding: 4px 12px;
            border-radius: 12px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 6px; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Drag Handle */
        .drag-handle { cursor: grab; touch-action: none; }
        .sortable-ghost { opacity: 0.4; background: #e0f2fe; }

        /* Booking Sub-nav */
        .booking-nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 8px 12px; border-radius: 12px; transition: all 0.2s;
            min-width: 60px; text-align: center;
        }
        .booking-nav-item.active { background: #E0F2FE; color: #0284C7; }
        .booking-nav-item i { font-size: 18px; margin-bottom: 4px; }
        .booking-nav-item span { font-size: 10px; font-weight: bold; }

        /* Transport Mode Selector */
        .transport-option {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 50px; border-radius: 10px; border: 1px solid #e2e8f0;
            color: #94a3b8; cursor: pointer; transition: all 0.2s;
        }
        .transport-option.active { background: #0ea5e9; color: white; border-color: #0ea5e9; box-shadow: 0 4px 10px rgba(14,165,233,0.3); }
        
        /* Snow Effect */
        #snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden; }
        .snowflake { position: absolute; top: -10px; background: white; border-radius: 50%; opacity: 0.8; animation: fall linear infinite; }
        @keyframes fall {
            0% { transform: translateY(-10px) translateX(0) rotate(0deg); opacity: 0.8; }
            100% { transform: translateY(100vh) translateX(20px) rotate(360deg); opacity: 0.2; }
        }

        /* Custom Radio for Currency/Payment */
        .custom-radio-group { display: flex; background: #F1F5F9; padding: 4px; border-radius: 12px; }
        .custom-radio-item { flex: 1; text-align: center; padding: 8px 0; font-size: 13px; font-weight: bold; color: #64748B; border-radius: 8px; transition: all 0.2s; cursor: pointer; }
        .custom-radio-item.active { background: white; color: #0EA5E9; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* Flight Card Styles */
        .flight-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            overflow: hidden;
            margin-bottom: 24px;
            border: 1px solid #F1F5F9;
        }
        .flight-header {
            background: #F8FAFC;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #E2E8F0;
        }
        .flight-body {
            padding: 24px 20px;
        }
        .airport-code {
            font-size: 32px;
            font-weight: 800;
            color: #334155;
            line-height: 1;
        }
        .flight-time {
            font-size: 18px;
            font-weight: 700;
            color: #475569;
        }
        .flight-path-line {
            height: 2px;
            background-image: linear-gradient(to right, #CBD5E1 50%, transparent 50%);
            background-size: 10px 1px;
            width: 100%;
            position: relative;
            margin-top: 8px;
        }
        
    </style>
</head>
<body class="text-slate-600">

    <div id="snow-container"></div>

    <div id="app" class="relative min-h-screen">
        
        <!-- Header -->
        <header class="banner-container">
            <img src="photo.png" alt="北海道插畫" class="banner-image">
            <div class="absolute inset-0 bg-gradient-to-t from-[#F0F9FF] via-[#F0F9FF]/20 to-black/30"></div>
            
            <div class="absolute bottom-16 left-6 text-slate-700 drop-shadow-sm z-10">
                <h1 class="text-3xl font-bold tracking-wide text-slate-800 drop-shadow-sm">北緯43°の約定</h1>
                <p class="text-sm mt-1 text-slate-600 font-medium"><i class="far fa-calendar-alt mr-1"></i> 2025 Dec 22 - 29</p>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content px-4">
            
            <!-- ================= TAB 1: SCHEDULE (行程) ================= -->
            <div v-if="currentTab === 'schedule'">
                <div class="flex overflow-x-auto gap-3 pb-4 hide-scrollbar mb-2">
                    <div v-for="(day, index) in scheduleData" :key="index" @click="selectedDayIndex = index"
                        :class="['flex-shrink-0 w-14 h-16 rounded-xl flex flex-col items-center justify-center border transition-all', selectedDayIndex === index ? 'bg-sky-500 text-white border-sky-500 shadow-lg shadow-sky-200' : 'bg-white/80 border-white text-slate-500']">
                        <span class="text-xs font-bold opacity-80">{{ day.weekday }}</span>
                        <span class="text-lg font-bold">{{ day.date }}</span>
                    </div>
                </div>

                <div v-if="selectedDayIndex === 0" class="mb-5 bg-sky-100/80 border border-sky-200 rounded-2xl p-4 text-center shadow-sm">
                    <div class="text-xs font-bold text-sky-500 uppercase tracking-wider mb-1">距離出發 (12/22 00:05)</div>
                    <div class="text-2xl font-bold text-sky-700 font-mono">{{ countdown }}</div>
                </div>

                <section class="mb-5 bg-gradient-to-br from-blue-500 to-sky-400 rounded-2xl p-5 text-white shadow-lg shadow-sky-200 relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
                    <div class="flex items-center justify-between relative z-10 mb-4 border-b border-white/20 pb-4">
                        <div>
                            <div class="text-xs font-bold opacity-80 mb-1"><i class="fas fa-map-marker-alt"></i> 札幌 · {{ scheduleData[selectedDayIndex].date }}日</div>
                            <div class="text-3xl font-bold tracking-wider">{{ currentDayWeather.temp.split('/')[0] }} <span class="text-sm font-normal opacity-70">{{ currentDayWeather.temp.split('/')[1] }}</span></div>
                            <div class="text-xs font-bold mt-1 bg-white/20 inline-block px-2 py-0.5 rounded-full">{{ currentDayWeather.desc }}</div>
                        </div>
                        <div class="text-center"><i :class="['text-5xl drop-shadow-md', currentDayWeather.icon]"></i></div>
                    </div>
                    <div class="flex gap-3 mb-3">
                        <div class="flex-1 bg-white/10 rounded-lg p-2 flex items-center justify-center gap-2">
                            <i class="fas fa-sun text-yellow-300 text-xs"></i>
                            <span class="text-xs font-bold">{{ currentDayWeather.sunrise }}</span>
                        </div>
                        <div class="flex-1 bg-white/10 rounded-lg p-2 flex items-center justify-center gap-2">
                            <i class="fas fa-moon text-indigo-200 text-xs"></i>
                            <span class="text-xs font-bold">{{ currentDayWeather.sunset }}</span>
                        </div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-3 relative z-10">
                        <div class="flex items-start gap-3">
                            <div class="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center shrink-0 mt-0.5">
                                <i class="fas fa-tshirt text-xs"></i>
                            </div>
                            <div class="min-w-0">
                                <div class="text-[10px] opacity-70 mb-1">穿搭建議</div>
                                <div class="text-xs font-bold leading-relaxed whitespace-normal">{{ currentDayWeather.outfit }}</div>
                            </div>
                        </div>
                    </div>
                </section>

                <div id="schedule-list-container" class="space-y-0 pb-20 min-h-[200px]">
                    <div v-for="(item, index) in currentDaySchedule" :key="item.id" :data-id="item.id" class="schedule-item-wrapper">
                        <div class="bg-white/90 backdrop-blur-sm p-4 rounded-2xl shadow-sm border border-white flex gap-3 items-start relative z-10 group">
                            <div class="drag-handle absolute left-0 top-0 bottom-0 w-8 flex items-center justify-center text-slate-300 opacity-50 hover:opacity-100">
                                <i class="fas fa-grip-vertical"></i>
                            </div>
                            <div class="flex flex-col items-center justify-start w-14 shrink-0 border-r border-slate-100 pr-3 pt-1 ml-4">
                                <div :class="['w-10 h-10 rounded-full flex items-center justify-center mb-1 text-white shadow-sm', getCategoryColor(item.category)]">
                                    <i :class="getCategoryIcon(item.category)"></i>
                                </div>
                                <div class="text-[10px] font-bold text-slate-500">{{ item.startTime || '--:--' }}</div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-slate-100 text-slate-500 font-bold">{{ item.categoryLabel }}</span>
                                </div>
                                <h3 class="font-bold text-slate-800 truncate text-sm mb-1">{{ item.name }}</h3>
                                <div class="flex flex-wrap gap-2 mb-1.5">
                                    <span v-if="item.openingHours" class="text-[10px] text-slate-500 bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100 flex items-center gap-1"><i class="far fa-clock"></i> {{ item.openingHours }}</span>
                                    <span v-if="item.cost" class="text-[10px] text-slate-500 bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100 flex items-center gap-1"><i class="fas fa-ticket-alt"></i> {{ item.cost }}</span>
                                </div>
                                <p v-if="item.note" class="text-xs text-slate-500 mt-0.5 truncate">{{ item.note }}</p>
                            </div>
                            <div class="flex flex-col items-center gap-1.5 pt-1">
                                <button @click.stop="editScheduleItem(item)" class="w-8 h-8 rounded-full flex items-center justify-center text-slate-300 hover:text-sky-500 hover:bg-sky-50"><i class="fas fa-pen text-xs"></i></button>
                                <button @click.stop="removeScheduleItem(index)" class="w-8 h-8 rounded-full flex items-center justify-center text-slate-300 hover:text-rose-500 hover:bg-rose-50"><i class="fas fa-trash-alt text-xs"></i></button>
                            </div>
                        </div>
                        <div v-if="item.travelTime" class="travel-connector">
                            <div class="travel-line"></div>
                            <div class="travel-badge">
                                <i :class="['fas text-sky-500', getTransportIcon(item.travelMode)]"></i>
                                <span>{{ item.travelTime }}</span>
                            </div>
                            <div class="travel-line"></div>
                        </div>
                        <div v-else-if="index < currentDaySchedule.length - 1" class="h-3"></div>
                    </div>
                    <div v-if="currentDaySchedule.length === 0" class="text-center py-10 text-slate-400 text-sm">
                        <i class="far fa-snowflake text-2xl mb-2 opacity-50 block"></i> 無行程，點擊右下角新增
                    </div>
                </div>

                <button @click="openScheduleModal" class="fab-btn"><i class="fas fa-plus"></i></button>
            </div>

            <!-- ================= TAB 2: BOOKING (預訂) ================= -->
            <div v-if="currentTab === 'booking'" class="pb-20">
                <div class="bg-white/80 backdrop-blur-md rounded-2xl p-2 mb-4 flex justify-between shadow-sm border border-white">
                    <div @click="bookingCategory = 'flight'" :class="['booking-nav-item', bookingCategory === 'flight' ? 'active' : 'text-slate-400']"><i class="fas fa-plane"></i><span>機票</span></div>
                    <div @click="bookingCategory = 'hotel'" :class="['booking-nav-item', bookingCategory === 'hotel' ? 'active' : 'text-slate-400']"><i class="fas fa-hotel"></i><span>住宿</span></div>
                    <div @click="bookingCategory = 'tour'" :class="['booking-nav-item', bookingCategory === 'tour' ? 'active' : 'text-slate-400']"><i class="fas fa-bus"></i><span>一日團</span></div>
                    <div @click="bookingCategory = 'voucher'" :class="['booking-nav-item', bookingCategory === 'voucher' ? 'active' : 'text-slate-400']"><i class="fas fa-ticket-alt"></i><span>憑證</span></div>
                    <div @click="bookingCategory = 'other'" :class="['booking-nav-item', bookingCategory === 'other' ? 'active' : 'text-slate-400']"><i class="fas fa-ellipsis-h"></i><span>其他</span></div>
                </div>

                <div class="animate-fade-in">
                    <!-- Flight -->
                    <div v-if="bookingCategory === 'flight'" class="space-y-6">
                        <div v-for="(flight, fIndex) in flightData" :key="fIndex" class="flight-card relative">
                             <div class="flight-header">
                                <div class="flex items-center gap-2">
                                    <img :src="flight.logo" alt="Airline" class="h-4 object-contain">
                                    <span class="text-sm font-bold text-slate-600">{{ flight.airline }}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="bg-sky-100 text-sky-700 text-xs font-bold px-3 py-1 rounded-full">{{ flight.typeLabel }} {{ flight.date }}</div>
                                    <button @click="editFlight(flight)" class="w-7 h-7 rounded-full bg-slate-100 hover:bg-sky-50 text-slate-400 hover:text-sky-500 flex items-center justify-center transition-colors">
                                        <i class="fas fa-pen text-xs"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flight-body">
                                <div v-for="(leg, lIndex) in flight.legs" :key="lIndex" :class="lIndex < flight.legs.length - 1 ? 'mb-6' : ''">
                                    <div class="flex justify-between items-center">
                                        <div class="text-center w-1/3">
                                            <div class="airport-code">{{ leg.dep }}</div>
                                            <div class="flight-time" v-html="leg.depTime"></div>
                                            <div class="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded-md inline-block mt-1">{{ leg.termDep }}</div>
                                        </div>
                                        <div class="flex-1 px-2 text-center relative">
                                            <div class="text-xs text-slate-400 mb-1">{{ leg.duration }}</div>
                                            <div class="flight-path-line"></div>
                                            <div class="text-[12px] font-bold text-sky-600 mt-2">{{ leg.flightNo }}</div>
                                            <div class="text-[10px] text-slate-400 mt-0.5">{{ leg.aircraft }}</div>
                                        </div>
                                        <div class="text-center w-1/3">
                                            <div class="airport-code">{{ leg.arr }}</div>
                                            <div class="flight-time" v-html="leg.arrTime"></div>
                                            <div class="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded-md inline-block mt-1">{{ leg.termArr }}</div>
                                        </div>
                                    </div>
                                    <div v-if="lIndex < flight.legs.length - 1 && flight.transfer" class="mt-6 bg-orange-50 border border-orange-100 rounded-xl p-3 flex items-center justify-center gap-2">
                                        <i class="fas fa-walking text-orange-500"></i>
                                        <div class="text-xs text-orange-700 font-bold">
                                            {{ flight.transfer.text }} <span class="text-orange-400 mx-1">|</span> <span class="text-orange-600">{{ flight.transfer.note }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Hotel -->
                    <div v-if="bookingCategory === 'hotel'" class="space-y-6">
                        <div class="bg-white rounded-3xl overflow-hidden shadow-sm border border-slate-100">
                            <div class="h-48 relative">
                                <img :src="hotelData.image" alt="Hotel" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                                <div class="absolute bottom-4 left-4 text-white">
                                    <h2 class="text-xl font-bold leading-tight mb-1">{{ hotelData.name }}</h2>
                                    <div class="text-xs opacity-90 font-light"><i class="fas fa-map-marker-alt mr-1"></i>{{ hotelData.address }}</div>
                                </div>
                            </div>
                            <div class="p-5">
                                <div class="flex items-center justify-between bg-slate-50 rounded-xl p-4 mb-5 border border-slate-100">
                                    <div class="text-center">
                                        <div class="text-[10px] text-slate-400 mb-1">入住 IN</div>
                                        <div class="text-lg font-bold text-slate-700">{{ hotelData.checkIn }}</div>
                                        <div class="text-xs font-bold text-sky-600">{{ hotelData.checkInTime }} 後</div>
                                    </div>
                                    <div class="flex flex-col items-center px-4">
                                        <div class="text-[10px] text-slate-400 mb-1">{{ hotelData.nights }}晚</div>
                                        <div class="w-12 h-[1px] bg-slate-300 relative">
                                            <i class="fas fa-moon absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-50 px-1 text-slate-300 text-xs"></i>
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-[10px] text-slate-400 mb-1">退房 OUT</div>
                                        <div class="text-lg font-bold text-slate-700">{{ hotelData.checkOut }}</div>
                                        <div class="text-xs font-bold text-sky-600">{{ hotelData.checkOutTime }} 前</div>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div class="flex items-start gap-3">
                                        <div class="w-8 h-8 rounded-full bg-sky-50 flex items-center justify-center text-sky-500 shrink-0"><i class="fas fa-users"></i></div>
                                        <div>
                                            <div class="text-xs text-slate-400 mb-0.5">住客姓名</div>
                                            <div class="text-sm font-bold text-slate-700 whitespace-pre-line">{{ hotelData.guests }}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-start gap-3">
                                        <div class="w-8 h-8 rounded-full bg-sky-50 flex items-center justify-center text-sky-500 shrink-0"><i class="fas fa-phone-alt"></i></div>
                                        <div>
                                            <div class="text-xs text-slate-400 mb-0.5">聯絡電話</div>
                                            <div class="text-sm font-bold text-slate-700 font-mono">{{ hotelData.phone }}</div>
                                        </div>
                                    </div>
                                </div>
                                <button @click="openHotelModal" class="w-full mt-5 py-2.5 rounded-xl border border-slate-200 text-slate-500 text-sm font-bold hover:bg-slate-50 hover:text-sky-500 hover:border-sky-200 transition-all">
                                    <i class="fas fa-pen mr-1"></i> 編輯住宿資訊
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Tour -->
                    <div v-if="bookingCategory === 'tour'" class="space-y-6">
                        <div class="bg-white rounded-3xl overflow-hidden shadow-sm border border-slate-100 relative">
                            <div class="bg-gradient-to-r from-blue-500 to-sky-400 p-5 text-white">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="text-xs font-bold opacity-80 mb-1">一日團</div>
                                        <h2 class="text-lg font-bold leading-tight">{{ tourData.name }}</h2>
                                    </div>
                                    <div class="bg-white/20 backdrop-blur-sm px-3 py-1 rounded-lg text-sm font-bold">
                                        {{ tourData.date }}
                                    </div>
                                </div>
                            </div>
                            <div class="bg-red-50 border-b border-red-100 p-4 flex items-start gap-3">
                                <i class="fas fa-exclamation-circle text-red-500 mt-0.5 shrink-0"></i>
                                <div>
                                    <div class="text-xs font-bold text-red-500 mb-1">集合重要資訊</div>
                                    <div class="text-sm font-bold text-red-700 leading-relaxed">
                                        {{ tourData.meetingTime }} {{ tourData.meetingPoint }}<br>
                                        {{ tourData.departureTime }} 發車過時不候
                                    </div>
                                </div>
                            </div>
                            <div class="p-5 space-y-5">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <div class="text-[10px] text-slate-400 mb-1">訂單編號</div>
                                        <div class="text-xs font-bold text-slate-700 font-mono">{{ tourData.bookingId }}</div>
                                    </div>
                                    <div>
                                        <div class="text-[10px] text-slate-400 mb-1">參與人數</div>
                                        <div class="text-xs font-bold text-slate-700">{{ tourData.participants }}</div>
                                    </div>
                                </div>
                                <div class="border-t border-slate-100 pt-4">
                                    <h3 class="text-xs font-bold text-slate-400 mb-3">旅客資訊</h3>
                                    <div class="space-y-3">
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-500">姓名</span>
                                            <span class="text-xs font-bold text-slate-700">{{ tourData.touristName }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-500">電話</span>
                                            <span class="text-xs font-bold text-slate-700">{{ tourData.phone }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-500">社交軟體</span>
                                            <span class="text-xs font-bold text-slate-700">{{ tourData.socialApp }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                                    <h3 class="text-xs font-bold text-slate-500 mb-2">緊急聯絡人</h3>
                                    <div class="grid grid-cols-1 gap-2">
                                        <div class="flex justify-between items-center">
                                            <span class="text-[10px] bg-red-100 text-red-600 px-1.5 py-0.5 rounded">中國</span>
                                            <a :href="'tel:' + tourData.emergencyCn" class="text-xs font-bold text-slate-700 hover:text-sky-500">{{ tourData.emergencyCn }}</a>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-[10px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded">日本</span>
                                            <a :href="'tel:' + tourData.emergencyJp" class="text-xs font-bold text-slate-700 hover:text-sky-500">{{ tourData.emergencyJp }}</a>
                                        </div>
                                    </div>
                                </div>
                                <button @click="openTourModal" class="w-full py-2.5 rounded-xl border border-slate-200 text-slate-500 text-sm font-bold hover:bg-slate-50 hover:text-sky-500 hover:border-sky-200 transition-all">
                                    <i class="fas fa-pen mr-1"></i> 編輯一日團資訊
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Voucher -->
                    <div v-if="bookingCategory === 'voucher'" class="space-y-4">
                        <div class="flex justify-between items-center mb-2 px-2">
                            <h2 class="text-sm font-bold text-slate-500">我的憑證</h2>
                            <button @click="openVoucherModal" class="text-xs font-bold text-sky-500 bg-sky-50 px-3 py-1.5 rounded-lg hover:bg-sky-100 transition-colors">
                                <i class="fas fa-plus mr-1"></i> 新增憑證
                            </button>
                        </div>
                        <div v-if="voucherList.length === 0" class="text-center py-12 text-slate-400">
                            <i class="fas fa-file-pdf text-4xl mb-3 opacity-30"></i>
                            <p class="text-sm">暫無憑證，請點擊上方按鈕新增</p>
                        </div>
                        <div v-for="voucher in voucherList" :key="voucher.id" class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex items-center gap-4 group">
                            <div class="w-12 h-12 rounded-xl bg-red-50 flex items-center justify-center text-red-500 shrink-0">
                                <i class="fas fa-file-pdf text-xl"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-slate-700 truncate">{{ voucher.title }}</h3>
                                <div class="text-xs text-slate-400 truncate mt-0.5">{{ voucher.fileName }}</div>
                                <a v-if="voucher.fileData" :href="voucher.fileData" :download="voucher.fileName" class="text-[10px] font-bold text-sky-500 mt-1 inline-block hover:underline">
                                    <i class="fas fa-download mr-1"></i> 下載/預覽
                                </a>
                            </div>
                            <div class="flex flex-col gap-2">
                                <button @click="editVoucher(voucher)" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-sky-50 hover:text-sky-500 flex items-center justify-center transition-colors">
                                    <i class="fas fa-pen text-xs"></i>
                                </button>
                                <button @click="deleteVoucher(voucher.id)" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-colors">
                                    <i class="fas fa-trash-alt text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Other (Updated with VJW, Safety, Emergency) -->
                    <div v-if="bookingCategory === 'other'" class="space-y-6">
                        
                        <!-- Visit Japan Web -->
                        <a href="https://vjw-lp.digital.go.jp/en/" target="_blank" class="block bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex items-center justify-between group hover:border-rose-200 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-rose-50 flex items-center justify-center text-rose-500 shrink-0"><i class="fas fa-passport text-xl"></i></div>
                                <div>
                                    <div class="font-bold text-slate-700 group-hover:text-rose-600 transition-colors">Visit Japan Web</div>
                                    <div class="text-xs text-slate-400">入境手續、海關申報</div>
                                </div>
                            </div>
                            <i class="fas fa-external-link-alt text-slate-300 group-hover:text-rose-500"></i>
                        </a>

                        <!-- Currency -->
                        <section class="bg-white/90 backdrop-blur-sm rounded-2xl p-5 shadow-sm border border-white">
                            <h2 class="text-sm font-bold text-slate-400 mb-3 flex items-center gap-2"><i class="fas fa-coins text-sky-500"></i> 匯率換算</h2>
                            <div class="flex items-center gap-3">
                                <div class="flex-1"><label class="text-xs text-slate-400 block mb-1">日幣 (JPY)</label><input type="number" v-model="exchange.jpy" @input="calculateMOP" class="w-full bg-sky-50 rounded-lg p-2 font-bold text-lg text-slate-700 outline-none border border-sky-100 focus:border-sky-400"></div>
                                <i class="fas fa-arrow-right text-sky-200 mt-5"></i>
                                <div class="flex-1"><label class="text-xs text-slate-400 block mb-1">澳門幣 (MOP)</label><div class="w-full bg-slate-100 rounded-lg p-2 font-bold text-lg text-sky-600">{{ exchange.mop }}</div></div>
                            </div>
                        </section>

                        <!-- Safety & Emergency -->
                        <section>
                            <h2 class="text-sm font-bold text-slate-400 mb-3 ml-1">防災與緊急求助</h2>
                            <div class="grid grid-cols-2 gap-3">
                                <!-- Bear Info -->
                                <a href="https://www.pref.hokkaido.lg.jp/ks/skn/higuma/higuma.html" target="_blank" class="bg-yellow-50 p-4 rounded-2xl border border-yellow-100 flex flex-col items-center justify-center text-center gap-2 hover:bg-yellow-100 transition-colors">
                                    <i class="fas fa-paw text-yellow-600 text-2xl"></i>
                                    <div class="font-bold text-yellow-800 text-sm">熊出沒情報</div>
                                </a>
                                <!-- Earthquake Info -->
                                <a href="https://www.jma.go.jp/bosai/map.html#5/38.651/138.867/&elem=int&contents=earthquake_map" target="_blank" class="bg-slate-50 p-4 rounded-2xl border border-slate-200 flex flex-col items-center justify-center text-center gap-2 hover:bg-slate-100 transition-colors">
                                    <i class="fas fa-house-damage text-slate-600 text-2xl"></i>
                                    <div class="font-bold text-slate-700 text-sm">防災/地震</div>
                                </a>
                                <!-- Police -->
                                <a href="tel:110" class="bg-red-50 p-4 rounded-2xl border border-red-100 flex items-center gap-3 col-span-2 hover:bg-red-100 transition-colors">
                                    <div class="w-10 h-10 rounded-full bg-red-500 text-white flex items-center justify-center font-bold shrink-0"><i class="fas fa-phone"></i></div>
                                    <div class="flex-1">
                                        <div class="text-lg font-bold text-red-700">110</div>
                                        <div class="text-xs text-red-500">警察局 (報案)</div>
                                    </div>
                                    <i class="fas fa-chevron-right text-red-200"></i>
                                </a>
                                <!-- Ambulance -->
                                <a href="tel:119" class="bg-red-50 p-4 rounded-2xl border border-red-100 flex items-center gap-3 col-span-2 hover:bg-red-100 transition-colors">
                                    <div class="w-10 h-10 rounded-full bg-red-500 text-white flex items-center justify-center font-bold shrink-0"><i class="fas fa-ambulance"></i></div>
                                    <div class="flex-1">
                                        <div class="text-lg font-bold text-red-700">119</div>
                                        <div class="text-xs text-red-500">消防/救護車</div>
                                    </div>
                                    <i class="fas fa-chevron-right text-red-200"></i>
                                </a>
                                <!-- Consulate -->
                                <a href="tel:+81-80-1009-7179" class="bg-blue-50 p-4 rounded-2xl border border-blue-100 flex items-center gap-3 col-span-2 hover:bg-blue-100 transition-colors">
                                    <div class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold shrink-0"><i class="fas fa-globe"></i></div>
                                    <div class="flex-1">
                                        <div class="text-sm font-bold text-blue-700">外交部急難救助</div>
                                        <div class="text-xs text-blue-500">駐日代表處 (札幌分處)</div>
                                    </div>
                                    <i class="fas fa-chevron-right text-blue-200"></i>
                                </a>
                            </div>
                        </section>

                        <!-- Restaurant Reservation -->
                        <section class="bg-white rounded-2xl overflow-hidden shadow-sm border border-slate-100">
                            <div class="bg-slate-800 p-4 flex justify-between items-center text-white">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-utensils text-yellow-400"></i>
                                    <span class="font-bold">餐廳預約確認</span>
                                </div>
                                <span class="text-xs bg-green-500 px-2 py-0.5 rounded text-white font-bold">已確認</span>
                            </div>
                            <div class="p-5">
                                <div class="text-center mb-4 pb-4 border-b border-slate-100">
                                    <h3 class="text-xl font-bold text-slate-800 mb-1">{{ restaurantData.name }}</h3>
                                    <div class="text-sm text-slate-500">{{ restaurantData.course }}</div>
                                </div>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between"><span class="text-slate-400">預約號碼</span><span class="font-bold font-mono">{{ restaurantData.id }}</span></div>
                                    <div class="flex justify-between"><span class="text-slate-400">日期時間</span><span class="font-bold text-sky-600">{{ restaurantData.dateTime }}</span></div>
                                    <div class="flex justify-between"><span class="text-slate-400">人數</span><span class="font-bold">{{ restaurantData.pax }}</span></div>
                                    <div class="flex justify-between"><span class="text-slate-400">座位</span><span class="font-bold">{{ restaurantData.seat }}</span></div>
                                    <div class="flex justify-between"><span class="text-slate-400">預約人</span><span class="font-bold">{{ restaurantData.booker }}</span></div>
                                    <div class="bg-slate-50 p-3 rounded-lg text-xs mt-2">
                                        <div class="font-bold text-slate-700 mb-1"><i class="fas fa-map-marker-alt mr-1"></i>地址</div>
                                        <div class="text-slate-500 mb-2">{{ restaurantData.address }}</div>
                                        <div class="font-bold text-slate-700 mb-1"><i class="fas fa-phone mr-1"></i>電話</div>
                                        <div class="text-slate-500">{{ restaurantData.phone }}</div>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>

                </div>
            </div>

            <!-- ================= TAB 3: EXPENSES (記帳) ================= -->
            <div v-if="currentTab === 'expenses'" class="pb-20">
                <div class="flex bg-white/60 p-1 rounded-xl mb-6 shadow-sm border border-white">
                    <button @click="expenseMode = 'input'" :class="['flex-1 py-2 rounded-lg text-sm font-bold transition-all', expenseMode === 'input' ? 'bg-white text-sky-600 shadow-sm' : 'text-slate-400']">記帳輸入</button>
                    <button @click="expenseMode = 'list'" :class="['flex-1 py-2 rounded-lg text-sm font-bold transition-all', expenseMode === 'list' ? 'bg-white text-sky-600 shadow-sm' : 'text-slate-400']">消費明細</button>
                </div>

                <!-- Input Mode -->
                <div v-if="expenseMode === 'input'" class="animate-fade-in">
                    <div class="bg-white/90 backdrop-blur-sm rounded-3xl p-6 shadow-sm border border-white">
                        <div class="space-y-5">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 mb-1.5">日期</label>
                                    <input type="date" v-model="expenseForm.date" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm font-bold text-slate-700 outline-none focus:border-sky-400 transition-colors">
                                </div>
                                <div>
                                    <label class="block text-xs font-bold text-slate-400 mb-1.5">付款人</label>
                                    <div class="flex gap-2">
                                        <div @click="expenseForm.payer = 'Kyle'" :class="['flex-1 py-2.5 rounded-xl text-xs font-bold text-center border cursor-pointer transition-all', expenseForm.payer === 'Kyle' ? 'bg-blue-50 border-blue-200 text-blue-600' : 'bg-slate-50 border-slate-200 text-slate-400']">Kyle</div>
                                        <div @click="expenseForm.payer = 'Hayley'" :class="['flex-1 py-2.5 rounded-xl text-xs font-bold text-center border cursor-pointer transition-all', expenseForm.payer === 'Hayley' ? 'bg-pink-50 border-pink-200 text-pink-600' : 'bg-slate-50 border-slate-200 text-slate-400']">Hayley</div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-1.5">金額 & 幣別</label>
                                <div class="flex gap-3">
                                    <div class="relative flex-1">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 font-bold text-slate-400">{{ expenseForm.currency === 'JPY' ? '¥' : 'MOP$' }}</span>
                                        <input type="number" v-model="expenseForm.amount" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 pl-12 text-lg font-bold text-slate-800 outline-none focus:border-sky-400 transition-colors" placeholder="0">
                                    </div>
                                    <div class="custom-radio-group w-32">
                                        <div @click="expenseForm.currency = 'JPY'" :class="['custom-radio-item', expenseForm.currency === 'JPY' ? 'active' : '']">JPY</div>
                                        <div @click="expenseForm.currency = 'MOP'" :class="['custom-radio-item', expenseForm.currency === 'MOP' ? 'active' : '']">MOP</div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-1.5">類別</label>
                                <div class="grid grid-cols-4 gap-2">
                                    <div v-for="cat in ['飲食', '交通', '住宿', '購物', '門票', '其他']" :key="cat" 
                                         @click="expenseForm.category = cat"
                                         :class="['text-center py-2 rounded-lg text-xs font-bold border cursor-pointer transition-all', expenseForm.category === cat ? 'bg-sky-50 border-sky-200 text-sky-600' : 'bg-white border-slate-100 text-slate-500']">
                                        {{ cat }}
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-1.5">地點及消費項目</label>
                                <input type="text" v-model="expenseForm.name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none focus:border-sky-400 transition-colors" placeholder="例如：午餐 - 拉麵共和國">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-1.5">支付方式</label>
                                <div class="custom-radio-group">
                                    <div @click="expenseForm.payment = 'cash'" :class="['custom-radio-item', expenseForm.payment === 'cash' ? 'active' : '']"><i class="fas fa-money-bill-wave mr-1"></i>現金</div>
                                    <div @click="expenseForm.payment = 'card'" :class="['custom-radio-item', expenseForm.payment === 'card' ? 'active' : '']"><i class="fas fa-credit-card mr-1"></i>信用卡</div>
                                    <div @click="expenseForm.payment = 'epay'" :class="['custom-radio-item', expenseForm.payment === 'epay' ? 'active' : '']"><i class="fas fa-qrcode mr-1"></i>電子支付</div>
                                </div>
                            </div>
                            <button @click="saveExpense" class="w-full bg-gradient-to-r from-sky-500 to-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-sky-200 active:scale-95 transition-transform mt-2">
                                <i class="fas fa-check mr-2"></i> {{ isEditingExpense ? '更新紀錄' : '儲存紀錄' }}
                            </button>
                            <button v-if="isEditingExpense" @click="cancelEditExpense" class="w-full bg-slate-100 text-slate-500 py-3 rounded-xl font-bold text-sm">取消編輯</button>
                        </div>
                    </div>
                </div>

                <!-- List Mode -->
                <div v-if="expenseMode === 'list'" class="animate-fade-in">
                    
                    <!-- Filter Bar -->
                    <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar">
                        <button @click="expenseFilter = 'all'" :class="['px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors', expenseFilter === 'all' ? 'bg-slate-700 text-white' : 'bg-white text-slate-500 border border-slate-200']">全部</button>
                        <button @click="expenseFilter = 'Kyle'" :class="['px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors flex items-center gap-1', expenseFilter === 'Kyle' ? 'bg-blue-500 text-white' : 'bg-white text-slate-500 border border-slate-200']"><span class="w-2 h-2 rounded-full bg-blue-300"></span> Kyle</button>
                        <button @click="expenseFilter = 'Hayley'" :class="['px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors flex items-center gap-1', expenseFilter === 'Hayley' ? 'bg-pink-500 text-white' : 'bg-white text-slate-500 border border-slate-200']"><span class="w-2 h-2 rounded-full bg-pink-300"></span> Hayley</button>
                    </div>

                    <div class="bg-gradient-to-r from-sky-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg shadow-sky-200 mb-6 relative overflow-hidden">
                        <i class="fas fa-coins absolute -right-4 -top-4 text-8xl text-white opacity-10"></i>
                        <div class="text-xs font-medium opacity-80 mb-1">
                            {{ expenseFilter === 'all' ? '總花費' : expenseFilter + ' 的花費' }} (折合日幣)
                        </div>
                        <div class="text-4xl font-bold drop-shadow-sm">¥{{ totalExpensesJPY.toLocaleString() }}</div>
                        <div class="mt-4 flex flex-wrap gap-x-4 gap-y-2 text-xs opacity-90 border-t border-white/20 pt-3">
                            <div class="flex items-center"><i class="fas fa-money-bill-wave mr-1.5 w-3 text-center"></i>現金: ¥{{ totalCashJPY.toLocaleString() }}</div>
                            <div class="flex items-center"><i class="fas fa-credit-card mr-1.5 w-3 text-center"></i>卡片: ¥{{ totalCardJPY.toLocaleString() }}</div>
                            <div class="flex items-center"><i class="fas fa-qrcode mr-1.5 w-3 text-center"></i>電支: ¥{{ totalEpayJPY.toLocaleString() }}</div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div v-for="(group, date) in groupedExpenses" :key="date">
                            <div class="flex justify-between items-end px-2 mb-2">
                                <div class="text-sm font-bold text-slate-500 bg-slate-200/50 px-2 py-1 rounded">{{ date }}</div>
                                <div class="text-xs font-bold text-sky-600">
                                    小計: <span class="text-sm">¥{{ group.dailyTotalJPY.toLocaleString() }}</span>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div v-for="expense in group.items" :key="expense.id" class="bg-white/90 backdrop-blur-sm p-4 rounded-xl shadow-sm border border-white flex justify-between items-center group">
                                    <div class="flex gap-3 items-center flex-1 min-w-0">
                                        <div :class="['w-10 h-10 rounded-full flex items-center justify-center text-white text-sm shadow-sm shrink-0', getExpenseColor(expense.category)]">
                                            <i :class="getExpenseIcon(expense.category)"></i>
                                        </div>
                                        <div class="truncate">
                                            <div class="font-bold text-slate-800 truncate">{{ expense.name }}</div>
                                            <div class="text-xs text-slate-400 flex items-center gap-2 mt-0.5">
                                                <span :class="['px-1.5 py-0.5 rounded text-[10px] font-bold', expense.payer === 'Kyle' ? 'bg-blue-50 text-blue-600' : 'bg-pink-50 text-pink-600']">{{ expense.payer }}</span>
                                                <span v-if="expense.payment === 'card'"><i class="fas fa-credit-card"></i> 信用卡</span>
                                                <span v-else-if="expense.payment === 'epay'"><i class="fas fa-qrcode"></i> 電子支付</span>
                                                <span v-else><i class="fas fa-money-bill-wave"></i> 現金</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-end gap-1">
                                        <div class="font-bold text-slate-800">
                                            <span class="text-xs text-slate-400 mr-0.5">{{ expense.currency === 'JPY' ? '¥' : 'MOP$' }}</span>{{ Number(expense.amount).toLocaleString() }}
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <button @click.stop="editExpense(expense)" class="w-6 h-6 rounded-full flex items-center justify-center text-slate-300 hover:text-sky-500 hover:bg-sky-50 transition-colors"><i class="fas fa-pen text-[10px]"></i></button>
                                            <button @click.stop="removeExpense(expense.id)" class="w-6 h-6 rounded-full flex items-center justify-center text-slate-300 hover:text-rose-500 hover:bg-rose-50 transition-colors"><i class="fas fa-trash-alt text-[10px]"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div v-if="Object.keys(groupedExpenses).length === 0" class="text-center py-10 text-slate-400">
                            <p>沒有符合條件的消費紀錄</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= TAB 4: JOURNAL (日誌) ================= -->
            <div v-if="currentTab === 'journal'" class="pb-20">
                <div class="space-y-6">
                    <div v-for="entry in journalEntries" :key="entry.id" class="bg-white/90 backdrop-blur-sm rounded-2xl p-5 shadow-sm border border-white">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <div class="bg-sky-100 text-sky-600 font-bold px-2 py-1 rounded text-xs">{{ entry.date }}</div>
                                <div :class="['text-xs font-bold px-2 py-0.5 rounded-full flex items-center gap-1', entry.author === 'Kyle' ? 'bg-blue-50 text-blue-600' : 'bg-pink-50 text-pink-600']">
                                    <i class="fas fa-user-circle"></i> {{ entry.author }}
                                </div>
                            </div>
                            <div class="text-xs text-slate-400">{{ entry.time }}</div>
                        </div>
                        <p class="text-sm text-slate-700 leading-relaxed mb-3 whitespace-pre-line">{{ entry.text }}</p>
                        
                        <!-- Photos Display -->
                        <div v-if="entry.photos && entry.photos.length > 0" class="grid grid-cols-3 gap-2 mt-3">
                            <div v-for="(photo, pIndex) in entry.photos" :key="pIndex" class="aspect-square rounded-lg overflow-hidden bg-slate-100">
                                <img :src="photo" class="w-full h-full object-cover" alt="Journal photo">
                            </div>
                        </div>
                    </div>
                </div>
                <button @click="openJournalModal" class="fab-btn"><i class="fas fa-pen-nib"></i></button>
            </div>

            <!-- ================= TAB 5: PREPARATION (準備) ================= -->
            <div v-if="currentTab === 'preparation'" class="pb-20">
                
                <!-- Sub Navigation -->
                <div class="flex bg-white/60 p-1 rounded-xl mb-6 shadow-sm border border-white">
                    <button @click="prepTab = 'packing'" :class="['flex-1 py-2 rounded-lg text-sm font-bold transition-all', prepTab === 'packing' ? 'bg-white text-sky-600 shadow-sm' : 'text-slate-400']">行李清單</button>
                    <button @click="prepTab = 'shopping'" :class="['flex-1 py-2 rounded-lg text-sm font-bold transition-all', prepTab === 'shopping' ? 'bg-white text-sky-600 shadow-sm' : 'text-slate-400']">採購清單</button>
                </div>

                <!-- Filter Bar (Shared) -->
                <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar">
                    <button @click="packingFilter = 'all'" :class="['px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors', packingFilter === 'all' ? 'bg-slate-700 text-white' : 'bg-white text-slate-500 border border-slate-200']">全部</button>
                    <button @click="packingFilter = 'Kyle'" :class="['px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors flex items-center gap-1', packingFilter === 'Kyle' ? 'bg-blue-500 text-white' : 'bg-white text-slate-500 border border-slate-200']"><span class="w-2 h-2 rounded-full bg-blue-300"></span> Kyle</button>
                    <button @click="packingFilter = 'Hayley'" :class="['px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors flex items-center gap-1', packingFilter === 'Hayley' ? 'bg-pink-500 text-white' : 'bg-white text-slate-500 border border-slate-200']"><span class="w-2 h-2 rounded-full bg-pink-300"></span> Hayley</button>
                </div>

                <!-- Packing List View -->
                <section v-if="prepTab === 'packing'" class="bg-white/90 backdrop-blur-sm rounded-2xl p-5 shadow-sm border border-white">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-bold text-slate-400 flex items-center gap-2"><i class="fas fa-suitcase text-sky-500"></i> 行李準備進度</h2>
                        <div class="text-xs font-bold text-sky-600">{{ packingProgress }}%</div>
                    </div>
                    
                    <div class="w-full bg-slate-100 rounded-full h-1.5 mb-5">
                        <div class="bg-sky-500 h-1.5 rounded-full transition-all duration-500" :style="{ width: packingProgress + '%' }"></div>
                    </div>
                    
                    <div class="space-y-6">
                        <div v-for="(category, catIndex) in filteredPackingList" :key="category.id" class="relative">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-slate-700 text-sm">{{ category.title }}</h3>
                                <button @click="removeCategory(category.id)" class="text-slate-300 hover:text-rose-500"><i class="fas fa-trash-alt text-xs"></i></button>
                            </div>
                            <div class="space-y-2 mb-2">
                                <div v-for="(item, itemIndex) in category.items" :key="item.id" class="flex items-start gap-3 p-3 bg-white rounded-xl border border-slate-100 shadow-sm group">
                                    <label class="custom-checkbox cursor-pointer relative flex items-center mt-0.5">
                                        <input type="checkbox" v-model="item.checked" class="hidden">
                                        <div :class="['w-5 h-5 border-2 rounded flex items-center justify-center transition-all', item.checked ? 'bg-sky-500 border-sky-500' : 'bg-slate-50 border-slate-300']">
                                            <i class="fas fa-check text-white text-xs" v-if="item.checked"></i>
                                        </div>
                                    </label>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span :class="['text-[10px] font-bold px-1.5 py-0.5 rounded', item.owner === 'Kyle' ? 'bg-blue-50 text-blue-600' : 'bg-pink-50 text-pink-600']">{{ item.owner }}</span>
                                            <span :class="['text-sm transition-all font-medium', item.checked ? 'text-slate-400 line-through' : 'text-slate-700']">{{ item.text }}</span>
                                        </div>
                                        <div v-if="item.image" class="mt-2 w-20 h-20 rounded-lg overflow-hidden border border-slate-200">
                                            <img :src="item.image" class="w-full h-full object-cover" @click="openImagePreview(item.image)">
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <button @click="openPackingModal(category.id, item.id)" class="w-7 h-7 rounded-full bg-slate-50 text-slate-400 hover:bg-sky-50 hover:text-sky-500 flex items-center justify-center transition-colors">
                                            <i class="fas fa-pen text-[10px]"></i>
                                        </button>
                                        <button @click="deletePackingItem(category.id, item.id)" class="w-7 h-7 rounded-full bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-colors">
                                            <i class="fas fa-trash-alt text-[10px]"></i>
                                        </button>
                                    </div>
                                </div>
                                <div v-if="category.items.length === 0" class="text-center text-xs text-slate-300 py-2">無項目</div>
                            </div>
                            <button @click="openPackingModal(category.id)" class="w-full py-2 border border-dashed border-slate-300 rounded-xl text-slate-400 text-xs font-bold hover:bg-slate-50 hover:text-sky-500 hover:border-sky-300 transition-all">
                                <i class="fas fa-plus mr-1"></i> 新增物品
                            </button>
                        </div>
                    </div>
                    <div class="mt-6 pt-4 border-t border-slate-100">
                        <button @click="addCategory" class="w-full py-3 bg-slate-50 rounded-xl text-slate-500 text-sm font-bold hover:bg-slate-100 hover:text-sky-600 transition-all">
                            <i class="fas fa-folder-plus mr-1"></i> 新增類別
                        </button>
                    </div>
                </section>

                <!-- Shopping List View -->
                <section v-if="prepTab === 'shopping'" class="space-y-4">
                    <div v-if="filteredShoppingList.length === 0" class="text-center py-12 text-slate-400">
                        <i class="fas fa-shopping-basket text-4xl mb-3 opacity-30"></i>
                        <p class="text-sm">採購清單是空的</p>
                    </div>

                    <div v-for="item in filteredShoppingList" :key="item.id" class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex items-start gap-4 group">
                        <label class="custom-checkbox cursor-pointer relative flex items-center mt-1">
                            <input type="checkbox" v-model="item.bought" class="hidden">
                            <div :class="['w-6 h-6 border-2 rounded-lg flex items-center justify-center transition-all', item.bought ? 'bg-emerald-500 border-emerald-500' : 'bg-slate-50 border-slate-300']">
                                <i class="fas fa-check text-white text-xs" v-if="item.bought"></i>
                            </div>
                        </label>
                        
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span :class="['text-[10px] font-bold px-1.5 py-0.5 rounded', item.owner === 'Kyle' ? 'bg-blue-50 text-blue-600' : 'bg-pink-50 text-pink-600']">{{ item.owner }}</span>
                                <h3 :class="['font-bold text-slate-800 text-sm truncate', item.bought ? 'line-through text-slate-400' : '']">{{ item.name }}</h3>
                            </div>
                            <p v-if="item.note" class="text-xs text-slate-500 mb-2">{{ item.note }}</p>
                            <div v-if="item.image" class="w-full h-32 rounded-lg overflow-hidden border border-slate-100 bg-slate-50">
                                <img :src="item.image" class="w-full h-full object-cover" @click="openImagePreview(item.image)">
                            </div>
                        </div>

                        <div class="flex flex-col gap-2">
                            <button @click="openShoppingModal(item)" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-sky-50 hover:text-sky-500 flex items-center justify-center transition-colors">
                                <i class="fas fa-pen text-xs"></i>
                            </button>
                            <button @click="deleteShoppingItem(item.id)" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-colors">
                                <i class="fas fa-trash-alt text-xs"></i>
                            </button>
                        </div>
                    </div>

                    <button @click="openShoppingModal()" class="fab-btn"><i class="fas fa-plus"></i></button>
                </section>
            </div>

        </main>

        <!-- ================= DOCK NAVIGATION ================= -->
        <div class="apple-dock-container">
            <nav class="apple-dock">
                <button @click="currentTab = 'schedule'" :class="['dock-item', currentTab === 'schedule' ? 'active' : '']"><i class="fas fa-map-marked-alt"></i></button>
                <button @click="currentTab = 'booking'" :class="['dock-item', currentTab === 'booking' ? 'active' : '']"><i class="fas fa-ticket-alt"></i></button>
                <button @click="currentTab = 'expenses'" :class="['dock-item', currentTab === 'expenses' ? 'active' : '']"><i class="fas fa-yen-sign"></i></button>
                <button @click="currentTab = 'journal'" :class="['dock-item', currentTab === 'journal' ? 'active' : '']"><i class="fas fa-book-open"></i></button>
                <button @click="currentTab = 'preparation'" :class="['dock-item', currentTab === 'preparation' ? 'active' : '']"><i class="fas fa-suitcase-rolling"></i></button>
            </nav>
        </div>

        <!-- ================= MODALS ================= -->
        
        <!-- Packing Modal -->
        <div v-if="showPackingModal" class="modal-overlay" @click.self="showPackingModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h3 class="text-lg font-bold mb-4 text-slate-800">{{ isEditingPacking ? '編輯物品' : '新增物品' }}</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">物品名稱</label>
                        <input v-model="packingForm.text" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none" placeholder="例如：轉接頭">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">負責人</label>
                        <div class="flex gap-2">
                            <div @click="packingForm.owner = 'Kyle'" :class="['flex-1 py-2 rounded-lg text-xs font-bold text-center border cursor-pointer transition-all', packingForm.owner === 'Kyle' ? 'bg-blue-50 border-blue-200 text-blue-600' : 'bg-white border-slate-200 text-slate-400']">Kyle</div>
                            <div @click="packingForm.owner = 'Hayley'" :class="['flex-1 py-2 rounded-lg text-xs font-bold text-center border cursor-pointer transition-all', packingForm.owner === 'Hayley' ? 'bg-pink-50 border-pink-200 text-pink-600' : 'bg-white border-slate-200 text-slate-400']">Hayley</div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">圖片 (選填)</label>
                        <div v-if="packingForm.image" class="relative w-full h-40 rounded-xl overflow-hidden mb-2 border border-slate-200">
                            <img :src="packingForm.image" class="w-full h-full object-cover">
                            <button @click="packingForm.image = null" class="absolute top-2 right-2 bg-black/50 text-white w-6 h-6 rounded-full flex items-center justify-center"><i class="fas fa-times text-xs"></i></button>
                        </div>
                        <label class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer hover:bg-slate-50 transition-colors">
                            <div class="text-center">
                                <i class="fas fa-camera text-slate-300 text-xl mb-1"></i>
                                <div class="text-xs font-bold text-slate-400">上傳圖片</div>
                            </div>
                            <input type="file" accept="image/*" class="hidden" @change="handlePackingImage">
                        </label>
                    </div>
                    <button @click="savePackingItem" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">儲存</button>
                </div>
            </div>
        </div>

        <!-- Shopping Modal -->
        <div v-if="showShoppingModal" class="modal-overlay" @click.self="showShoppingModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto hide-scrollbar">
                <h3 class="text-lg font-bold mb-4 text-slate-800">{{ isEditingShopping ? '編輯採購項目' : '新增採購項目' }}</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">商品名稱</label>
                        <input v-model="shoppingForm.name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none" placeholder="例如：白色戀人">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">負責人</label>
                        <div class="flex gap-2">
                            <div @click="shoppingForm.owner = 'Kyle'" :class="['flex-1 py-2 rounded-lg text-xs font-bold text-center border cursor-pointer transition-all', shoppingForm.owner === 'Kyle' ? 'bg-blue-50 border-blue-200 text-blue-600' : 'bg-white border-slate-200 text-slate-400']">Kyle</div>
                            <div @click="shoppingForm.owner = 'Hayley'" :class="['flex-1 py-2 rounded-lg text-xs font-bold text-center border cursor-pointer transition-all', shoppingForm.owner === 'Hayley' ? 'bg-pink-50 border-pink-200 text-pink-600' : 'bg-white border-slate-200 text-slate-400']">Hayley</div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">備註 (數量/規格)</label>
                        <input v-model="shoppingForm.note" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none" placeholder="例如：要買3盒，黑巧克力口味">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">參考圖片</label>
                        <div v-if="shoppingForm.image" class="relative w-full h-48 rounded-xl overflow-hidden mb-2 border border-slate-200">
                            <img :src="shoppingForm.image" class="w-full h-full object-cover">
                            <button @click="shoppingForm.image = null" class="absolute top-2 right-2 bg-black/50 text-white w-6 h-6 rounded-full flex items-center justify-center"><i class="fas fa-times text-xs"></i></button>
                        </div>
                        <label class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer hover:bg-slate-50 transition-colors">
                            <div class="text-center">
                                <i class="fas fa-camera text-slate-300 text-xl mb-1"></i>
                                <div class="text-xs font-bold text-slate-400">上傳圖片</div>
                            </div>
                            <input type="file" accept="image/*" class="hidden" @change="handleShoppingImage">
                        </label>
                    </div>
                    <button @click="saveShoppingItem" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">儲存</button>
                </div>
            </div>
        </div>

        <!-- Schedule Modal -->
        <div v-if="showScheduleModal" class="modal-overlay" @click.self="showScheduleModal = false">
             <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto hide-scrollbar">
                <h3 class="text-lg font-bold mb-4 text-slate-800">{{ isEditingSchedule ? '編輯行程' : '新增行程' }}</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">分類</label>
                            <select v-model="scheduleForm.category" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none">
                                <option value="sightseeing">景點</option><option value="transport">交通</option><option value="flight">航班</option><option value="food">美食</option><option value="shopping">購物</option><option value="other">其他</option>
                            </select>
                        </div>
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">時間</label><input type="time" v-model="scheduleForm.time" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">名稱</label><input v-model="scheduleForm.name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none" placeholder="行程名稱"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">營業時間</label><input v-model="scheduleForm.openingHours" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none" placeholder="09:00 - 22:00"></div>
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">門票/費用</label><input v-model="scheduleForm.cost" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none" placeholder="¥1000"></div>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <label class="block text-xs font-bold text-sky-600 mb-2"><i class="fas fa-route"></i> 前往下一站方式</label>
                        <div class="grid grid-cols-5 gap-2 mb-2">
                            <div @click="scheduleForm.travelMode = 'walk'" :class="['transport-option', scheduleForm.travelMode === 'walk' ? 'active' : 'bg-white']"><i class="fas fa-walking"></i></div>
                            <div @click="scheduleForm.travelMode = 'train'" :class="['transport-option', scheduleForm.travelMode === 'train' ? 'active' : 'bg-white']"><i class="fas fa-train"></i></div>
                            <div @click="scheduleForm.travelMode = 'taxi'" :class="['transport-option', scheduleForm.travelMode === 'taxi' ? 'active' : 'bg-white']"><i class="fas fa-taxi"></i></div>
                            <div @click="scheduleForm.travelMode = 'plane'" :class="['transport-option', scheduleForm.travelMode === 'plane' ? 'active' : 'bg-white']"><i class="fas fa-plane"></i></div>
                            <div @click="scheduleForm.travelMode = 'ship'" :class="['transport-option', scheduleForm.travelMode === 'ship' ? 'active' : 'bg-white']"><i class="fas fa-ship"></i></div>
                        </div>
                        <input v-model="scheduleForm.travelTime" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-sm outline-none placeholder-slate-400" placeholder="所需時間 (如: 30分鐘)">
                    </div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">備註</label><input v-model="scheduleForm.note" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none" placeholder="備註事項"></div>
                    <button @click="saveSchedule" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200 mt-2">{{ isEditingSchedule ? '更新' : '新增' }}</button>
                </div>
            </div>
        </div>

        <!-- Flight Modal -->
        <div v-if="showFlightModal" class="modal-overlay" @click.self="showFlightModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto hide-scrollbar">
                <h3 class="text-lg font-bold mb-4 text-slate-800">編輯航班資訊</h3>
                <div v-if="flightForm" class="space-y-6">
                    <div v-for="(leg, index) in flightForm.legs" :key="index" class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <div class="text-xs font-bold text-sky-600 mb-3 uppercase tracking-wider">航段 {{ index + 1 }}</div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">航班編號</label><input v-model="leg.flightNo" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs outline-none"></div>
                            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">機型</label><input v-model="leg.aircraft" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs outline-none"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">出發地</label><input v-model="leg.dep" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs outline-none"></div>
                            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">目的地</label><input v-model="leg.arr" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs outline-none"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">出發時間</label><input v-model="leg.depTime" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs outline-none"></div>
                            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">抵達時間</label><input v-model="leg.arrTime" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs outline-none"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mt-3">
                            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">出發航廈</label><input v-model="leg.termDep" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs outline-none"></div>
                            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">抵達航廈</label><input v-model="leg.termArr" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs outline-none"></div>
                        </div>
                    </div>
                    <button @click="saveFlight" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">儲存變更</button>
                </div>
            </div>
        </div>

        <div v-if="showHotelModal" class="modal-overlay" @click.self="showHotelModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto hide-scrollbar">
                <h3 class="text-lg font-bold mb-4 text-slate-800">編輯住宿資訊</h3>
                <div class="space-y-4">
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">酒店名稱</label><input v-model="hotelForm.name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">地址</label><input v-model="hotelForm.address" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">入住日期</label><input v-model="hotelForm.checkIn" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">時間</label><input v-model="hotelForm.checkInTime" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">退房日期</label><input v-model="hotelForm.checkOut" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">時間</label><input v-model="hotelForm.checkOutTime" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">住客姓名</label><textarea v-model="hotelForm.guests" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none h-20"></textarea></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">Trip訂單號</label><input v-model="hotelForm.bookingId" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">酒店確認號</label><input v-model="hotelForm.hotelId" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">注意事項</label><textarea v-model="hotelForm.notes" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none h-20"></textarea></div>
                    <button @click="saveHotel" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">儲存變更</button>
                </div>
            </div>
        </div>

        <div v-if="showTourModal" class="modal-overlay" @click.self="showTourModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto hide-scrollbar">
                <h3 class="text-lg font-bold mb-4 text-slate-800">編輯一日團資訊</h3>
                <div class="space-y-4">
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">項目名稱</label><input v-model="tourForm.name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">日期</label><input v-model="tourForm.date" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    <div class="bg-red-50 p-3 rounded-xl border border-red-100">
                        <label class="block text-xs font-bold text-red-500 mb-2">集合資訊 (重要)</label>
                        <div class="space-y-2">
                            <input v-model="tourForm.meetingTime" class="w-full bg-white border border-red-100 rounded-lg p-2 text-sm outline-none" placeholder="集合時間">
                            <input v-model="tourForm.meetingPoint" class="w-full bg-white border border-red-100 rounded-lg p-2 text-sm outline-none" placeholder="集合地點">
                            <input v-model="tourForm.departureTime" class="w-full bg-white border border-red-100 rounded-lg p-2 text-sm outline-none" placeholder="發車時間">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">訂單編號</label><input v-model="tourForm.bookingId" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">參與人數</label><input v-model="tourForm.participants" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">旅客姓名</label><input v-model="tourForm.touristName" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">聯絡電話</label><input v-model="tourForm.phone" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">社交軟體</label><input v-model="tourForm.socialApp" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">帳號</label><input v-model="tourForm.socialId" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    </div>
                    <button @click="saveTour" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">儲存變更</button>
                </div>
            </div>
        </div>

        <div v-if="showVoucherModal" class="modal-overlay" @click.self="showVoucherModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h3 class="text-lg font-bold mb-4 text-slate-800">{{ isEditingVoucher ? '編輯憑證' : '新增憑證' }}</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">憑證標題</label>
                        <input v-model="voucherForm.title" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none" placeholder="例如：迪士尼門票">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">上傳 PDF / 圖片</label>
                        <div class="relative">
                            <input type="file" @change="handleVoucherFile" accept=".pdf,image/*" class="hidden" id="voucher-file">
                            <label for="voucher-file" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer hover:bg-slate-50 transition-colors">
                                <div v-if="voucherForm.fileName" class="text-center p-4">
                                    <i class="fas fa-file-check text-sky-500 text-2xl mb-2"></i>
                                    <div class="text-xs font-bold text-slate-600 break-all">{{ voucherForm.fileName }}</div>
                                    <div class="text-[10px] text-slate-400 mt-1">(點擊更換)</div>
                                </div>
                                <div v-else class="text-center">
                                    <i class="fas fa-cloud-upload-alt text-slate-300 text-2xl mb-2"></i>
                                    <div class="text-xs font-bold text-slate-400">點擊選擇檔案</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <button @click="saveVoucher" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">儲存</button>
                    <p class="text-[10px] text-center text-slate-400 mt-2">* 注意：重新整理網頁後檔案將會消失</p>
                </div>
            </div>
        </div>

        <!-- Journal Modal -->
        <div v-if="showJournalModal" class="modal-overlay" @click.self="showJournalModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto hide-scrollbar">
                <h3 class="text-lg font-bold mb-4 text-slate-800">寫日記</h3>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">日期</label>
                            <input type="date" v-model="journalForm.date" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-2 text-sm outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 mb-1">記錄人</label>
                            <div class="flex gap-2">
                                <div @click="journalForm.author = 'Kyle'" :class="['flex-1 py-2 rounded-lg text-xs font-bold text-center border cursor-pointer transition-all', journalForm.author === 'Kyle' ? 'bg-blue-50 border-blue-200 text-blue-600' : 'bg-white border-slate-200 text-slate-400']">Kyle</div>
                                <div @click="journalForm.author = 'Hayley'" :class="['flex-1 py-2 rounded-lg text-xs font-bold text-center border cursor-pointer transition-all', journalForm.author === 'Hayley' ? 'bg-pink-50 border-pink-200 text-pink-600' : 'bg-white border-slate-200 text-slate-400']">Hayley</div>
                            </div>
                        </div>
                    </div>
                    
                    <textarea v-model="journalForm.text" class="w-full h-32 bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none resize-none" placeholder="今天發生了什麼有趣的事？"></textarea>
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">照片 (最多5張)</label>
                        <div class="grid grid-cols-5 gap-2 mb-2">
                            <div v-for="(photo, index) in journalForm.photos" :key="index" class="relative aspect-square rounded-lg overflow-hidden border border-slate-200">
                                <img :src="photo" class="w-full h-full object-cover">
                                <button @click="removeJournalPhoto(index)" class="absolute top-0 right-0 bg-black/50 text-white w-4 h-4 flex items-center justify-center rounded-bl-lg text-[10px]"><i class="fas fa-times"></i></button>
                            </div>
                            <label v-if="journalForm.photos.length < 5" class="aspect-square rounded-lg border-2 border-dashed border-slate-300 flex items-center justify-center cursor-pointer hover:bg-slate-50">
                                <i class="fas fa-plus text-slate-300"></i>
                                <input type="file" accept="image/*" multiple class="hidden" @change="handleJournalPhotos">
                            </label>
                        </div>
                    </div>

                    <button @click="saveJournal" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">發佈</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const currentTab = ref('schedule');
                const selectedDayIndex = ref(0);
                const bookingCategory = ref('tour'); 

                // Countdown
                const countdown = ref('');
                const updateCountdown = () => {
                    const target = new Date('2025-12-22T00:05:00').getTime();
                    const now = new Date().getTime();
                    const diff = target - now;
                    if (diff < 0) { countdown.value = "旅程已開始"; return; }
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    countdown.value = `${days}天 ${hours}小時 ${minutes}分`;
                };
                setInterval(updateCountdown, 60000);
                updateCountdown();

                // Weather
                const weatherForecast = ref([
                    { date: '12/22', icon: 'fas fa-snowflake', temp: '-2° / -6°', desc: '大雪', sunrise: '07:06', sunset: '16:03', outfit: '極寒：發熱衣+厚毛衣+羽絨大衣+圍巾' },
                    { date: '12/23', icon: 'fas fa-snowflake', temp: '-3° / -8°', desc: '小雪', sunrise: '07:06', sunset: '16:04', outfit: '保暖：洋蔥式穿搭，防水雪靴必備' },
                    { date: '12/24', icon: 'fas fa-cloud', temp: '-1° / -5°', desc: '多雲', sunrise: '07:07', sunset: '16:05', outfit: '舒適：長版大衣+毛帽，注意防風' },
                    { date: '12/25', icon: 'fas fa-snowflake', temp: '-4° / -9°', desc: '暴風雪', sunrise: '07:07', sunset: '16:05', outfit: '嚴寒：最厚裝備全上，貼暖暖包' },
                    { date: '12/26', icon: 'fas fa-sun', temp: '0° / -7°', desc: '晴時多雲', sunrise: '07:08', sunset: '16:06', outfit: '晴朗：墨鏡防雪盲，室內外溫差大' },
                    { date: '12/27', icon: 'fas fa-cloud-sun', temp: '-1° / -6°', desc: '多雲', sunrise: '07:08', sunset: '16:07', outfit: '活動：輕便羽絨，方便活動為主' },
                    { date: '12/28', icon: 'fas fa-snowflake', temp: '-2° / -8°', desc: '小雪', sunrise: '07:09', sunset: '16:08', outfit: '降雪：防水外套，手套必備' },
                    { date: '12/29', icon: 'fas fa-snowflake', temp: '-3° / -7°', desc: '大雪', sunrise: '07:09', sunset: '16:09', outfit: '返程：舒適保暖，方便穿脫過安檢' },
                ]);
                const currentDayWeather = computed(() => weatherForecast.value[selectedDayIndex.value] || weatherForecast.value[0]);

                // Flight Data
                const flightData = ref([
                    {
                        id: 1, type: 'outbound', typeLabel: '去程', date: '12/22', airline: '全日空航空', 
                        logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e2/ANA_logo_%282023%29.svg/2560px-ANA_logo_%282023%29.svg.png',
                        legs: [
                            { dep: 'HKG', arr: 'HND', depTime: '00:05', arrTime: '04:55', flightNo: 'NH814', aircraft: '波音 787-800', termDep: 'T1', termArr: 'T3', duration: '3h 50m' },
                            { dep: 'HND', arr: 'CTS', depTime: '09:00', arrTime: '10:35', flightNo: 'NH055', aircraft: '波音 787-10', termDep: 'T2', termArr: 'Dom', duration: '1h 35m' }
                        ],
                        transfer: { text: '東京轉機 4h 5m', note: '需領取並重新託運行李' }
                    },
                    {
                        id: 2, type: 'inbound', typeLabel: '回程', date: '12/29', airline: '全日空航空',
                        logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e2/ANA_logo_%282023%29.svg/2560px-ANA_logo_%282023%29.svg.png',
                        legs: [
                            { dep: 'CTS', arr: 'HND', depTime: '20:30', arrTime: '22:10', flightNo: 'NH082', aircraft: '波音 777-300', termDep: 'Dom', termArr: 'T2', duration: '1h 40m' },
                            { dep: 'HND', arr: 'HKG', depTime: '<span class="text-[10px] text-orange-500 mr-1">12/30</span>09:15', arrTime: '13:30', flightNo: 'NH813', aircraft: '波音 787-800', termDep: 'T2', termArr: 'T1', duration: '5h 15m' }
                        ],
                        transfer: { text: '東京轉機 11h 5m', note: '隔夜轉機' }
                    }
                ]);

                // Hotel Data
                const hotelData = ref({
                    name: '微笑酒店PREMIUM札幌薄野',
                    address: 'Chuoku Minami 4 jo Nishi 1 chome 13-1, 中央區, 064-0804 札幌市, 北海道, 日本',
                    phone: '+81-11-2517055',
                    checkIn: '2025年12月22日',
                    checkInTime: '15:00',
                    checkOut: '2025年12月29日',
                    checkOutTime: '11:00',
                    nights: 7,
                    guests: 'KWOK MAN HEI, AO HEI LAM',
                    bookingId: '1359039935428674',
                    hotelId: 'J21-773-499',
                    notes: '不包括餐膳。連續入住的客人將每三晚清潔一次。',
                    image: 'hotel.jpg' 
                });

                // Tour Data
                const tourData = ref({
                    name: '北海道旭山動物園+四季彩常規集合',
                    date: '2025-12-27',
                    bookingId: '6251118211816897',
                    participants: '成人 2',
                    touristName: 'KWOK MAN HEI',
                    phone: '853-66881962',
                    socialApp: 'Whatsapp: 85366881962',
                    socialId: '85366881962',
                    meetingTime: '07:40',
                    meetingPoint: '大通公園地鐵站31號門集合',
                    departureTime: '07:50',
                    emergencyCn: '+8613332988980',
                    emergencyJp: '+819096998601'
                });

                // Restaurant Data
                const restaurantData = ref({
                    id: '9LT3K7WPR8',
                    name: 'HOUSE.H',
                    pax: '2名様',
                    dateTime: '12月25日(木) 18:00～',
                    duration: '2時間30分',
                    course: '赤れんがのクリスマスディナー',
                    price: '￥14,000(税込)',
                    seat: 'テーブル席 [禁煙]',
                    address: '北海道札幌市中央区北三条西6-1 赤れんが庁舎 1F',
                    phone: '011-211-5244',
                    booker: 'guo lulu'
                });

                // Voucher Logic
                const voucherList = ref([
                    { id: 1, title: 'JR Pass 兌換券', fileName: 'jr_pass_voucher.pdf', fileData: null }
                ]);
                const showVoucherModal = ref(false);
                const isEditingVoucher = ref(false);
                const editingVoucherId = ref(null);
                const voucherForm = ref({ title: '', fileName: '', fileData: null });

                const openVoucherModal = () => { isEditingVoucher.value = false; voucherForm.value = { title: '', fileName: '', fileData: null }; showVoucherModal.value = true; };
                const handleVoucherFile = (event) => { const file = event.target.files[0]; if (file) { voucherForm.value.fileName = file.name; const reader = new FileReader(); reader.onload = (e) => { voucherForm.value.fileData = e.target.result; }; reader.readAsDataURL(file); } };
                const saveVoucher = () => { if (!voucherForm.value.title) { alert('請輸入憑證標題'); return; } if (isEditingVoucher.value) { const index = voucherList.value.findIndex(v => v.id === editingVoucherId.value); if (index !== -1) { const oldData = voucherList.value[index]; voucherList.value[index] = { ...oldData, title: voucherForm.value.title, fileName: voucherForm.value.fileName || oldData.fileName, fileData: voucherForm.value.fileData || oldData.fileData }; } } else { voucherList.value.push({ id: Date.now(), title: voucherForm.value.title, fileName: voucherForm.value.fileName || '未上傳檔案', fileData: voucherForm.value.fileData }); } showVoucherModal.value = false; };
                const editVoucher = (voucher) => { isEditingVoucher.value = true; editingVoucherId.value = voucher.id; voucherForm.value = { title: voucher.title, fileName: voucher.fileName, fileData: null }; showVoucherModal.value = true; };
                const deleteVoucher = (id) => { if(confirm('確定要刪除此憑證嗎？')) { voucherList.value = voucherList.value.filter(v => v.id !== id); } };

                // Modals & Edit Logic
                const showTourModal = ref(false); const tourForm = ref({}); const openTourModal = () => { tourForm.value = { ...tourData.value }; showTourModal.value = true; }; const saveTour = () => { tourData.value = { ...tourForm.value }; showTourModal.value = false; };
                const showHotelModal = ref(false); const hotelForm = ref({}); const openHotelModal = () => { hotelForm.value = { ...hotelData.value }; showHotelModal.value = true; }; const saveHotel = () => { hotelData.value = { ...hotelForm.value }; showHotelModal.value = false; };
                
                // Flight Edit Logic
                const showFlightModal = ref(false); 
                const flightForm = ref(null); 
                const editingFlightId = ref(null); 
                
                const editFlight = (flight) => { 
                    editingFlightId.value = flight.id; 
                    flightForm.value = JSON.parse(JSON.stringify(flight)); 
                    showFlightModal.value = true; 
                }; 
                
                const saveFlight = () => { 
                    const index = flightData.value.findIndex(f => f.id === editingFlightId.value); 
                    if (index !== -1) {
                        flightData.value[index] = flightForm.value; 
                    }
                    showFlightModal.value = false; 
                };

                // Schedule Data
                const scheduleData = ref([
                    { date: '22', weekday: 'Mon', items: [{id:1, category:'flight', categoryLabel:'航班', name:'抵達新千歲', startTime:'10:35', note:'NH055', travelTime:'45分鐘', travelMode:'train', openingHours:'', cost:''}] },
                    { date: '23', weekday: 'Tue', items: [{id:2, category:'sightseeing', categoryLabel:'景點', name:'小樽運河', startTime:'10:00', note:'拍照', travelTime:'15分鐘', travelMode:'walk', openingHours:'24H', cost:'免費'}] },
                    { date: '24', weekday: 'Wed', items: [] },
                    { date: '25', weekday: 'Thu', items: [{id:5, category:'food', categoryLabel:'美食', name:'HOUSE.H 聖誕晚餐', startTime:'18:00', note:'赤れんが庁舎 1F', travelTime:'', travelMode:'', openingHours:'17:30-22:00', cost:'¥14,000'}] },
                    { date: '26', weekday: 'Fri', items: [] },
                    { date: '27', weekday: 'Sat', items: [{id:3, category:'sightseeing', categoryLabel:'景點', name:'一日團集合', startTime:'07:50', note:'大通公園地鐵站31號門', travelTime:'2小時', travelMode:'bus', openingHours:'', cost:''}] },
                    { date: '28', weekday: 'Sun', items: [] },
                    { date: '29', weekday: 'Mon', items: [{id:4, category:'flight', categoryLabel:'航班', name:'前往機場', startTime:'18:00', note:'預備搭乘 NH082', travelTime:'', travelMode:'', openingHours:'', cost:''}] },
                ]);
                const currentDaySchedule = computed(() => scheduleData.value[selectedDayIndex.value].items);

                const initSortable = () => { const el = document.getElementById('schedule-list-container'); if (el) { new Sortable(el, { animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost', onEnd: (evt) => { const items = scheduleData.value[selectedDayIndex.value].items; const item = items.splice(evt.oldIndex, 1)[0]; items.splice(evt.newIndex, 0, item); } }); } };
                watch([currentTab, selectedDayIndex], () => { if (currentTab.value === 'schedule') nextTick(() => initSortable()); });
                onMounted(() => { if(currentTab.value === 'schedule') initSortable(); });

                const showScheduleModal = ref(false); const isEditingSchedule = ref(false); const editingScheduleId = ref(null); const scheduleForm = ref({ category: 'sightseeing', name: '', time: '', note: '', travelTime: '', travelMode: 'train', openingHours: '', cost: '' });
                const openScheduleModal = () => { isEditingSchedule.value = false; scheduleForm.value = { category: 'sightseeing', name: '', time: '', note: '', travelTime: '', travelMode: 'train', openingHours: '', cost: '' }; showScheduleModal.value = true; };
                const editScheduleItem = (item) => { isEditingSchedule.value = true; editingScheduleId.value = item.id; scheduleForm.value = { ...item, travelMode: item.travelMode || 'train' }; showScheduleModal.value = true; };
                const saveSchedule = () => { if(!scheduleForm.value.name) return; const newItem = { id: isEditingSchedule.value ? editingScheduleId.value : Date.now(), category: scheduleForm.value.category, categoryLabel: { sightseeing: '景點', transport: '交通', flight: '航班', food: '美食', shopping: '購物', other: '其他' }[scheduleForm.value.category], name: scheduleForm.value.name, startTime: scheduleForm.value.time, note: scheduleForm.value.note, travelTime: scheduleForm.value.travelTime, travelMode: scheduleForm.value.travelMode, openingHours: scheduleForm.value.openingHours, cost: scheduleForm.value.cost }; if (isEditingSchedule.value) { const items = scheduleData.value[selectedDayIndex.value].items; const index = items.findIndex(i => i.id === editingScheduleId.value); if (index !== -1) items[index] = newItem; } else { scheduleData.value[selectedDayIndex.value].items.push(newItem); } showScheduleModal.value = false; };
                const removeScheduleItem = (index) => { if(confirm('確定要刪除此行程嗎？')) scheduleData.value[selectedDayIndex.value].items.splice(index, 1); };

                // Expenses
                const expenseMode = ref('list'); 
                const expenseFilter = ref('all'); 
                const expenseList = ref([ 
                    { id: 1, category: '飲食', name: '湯咖哩 - Suage+', date: '2025-12-22', amount: 3500, currency: 'JPY', payment: 'cash', payer: 'Kyle' }, 
                    { id: 2, category: '交通', name: 'JR Pass 7日券', date: '2025-12-22', amount: 24000, currency: 'JPY', payment: 'card', payer: 'Hayley' }, 
                    { id: 3, category: '其他', name: '機場免稅店', date: '2025-12-22', amount: 200, currency: 'MOP', payment: 'epay', payer: 'Kyle' } 
                ]);
                const isEditingExpense = ref(false);
                const editingExpenseId = ref(null);
                const expenseForm = ref({ category: '飲食', name: '', date: new Date().toISOString().split('T')[0], amount: '', currency: 'JPY', payment: 'cash', payer: 'Kyle' });
                const mopToJpyRate = 18.5; 
                
                const toJPY = (item) => item.currency === 'MOP' ? item.amount * mopToJpyRate : Number(item.amount);
                
                const filteredExpenses = computed(() => {
                    if (expenseFilter.value === 'all') return expenseList.value;
                    return expenseList.value.filter(e => e.payer === expenseFilter.value);
                });

                const totalExpensesJPY = computed(() => Math.round(filteredExpenses.value.reduce((sum, item) => sum + toJPY(item), 0)));
                const totalCashJPY = computed(() => Math.round(filteredExpenses.value.filter(i => i.payment === 'cash').reduce((sum, item) => sum + toJPY(item), 0)));
                const totalCardJPY = computed(() => Math.round(filteredExpenses.value.filter(i => i.payment === 'card').reduce((sum, item) => sum + toJPY(item), 0)));
                const totalEpayJPY = computed(() => Math.round(filteredExpenses.value.filter(i => i.payment === 'epay').reduce((sum, item) => sum + toJPY(item), 0)));
                
                const groupedExpenses = computed(() => { 
                    const groups = {}; 
                    const sorted = [...filteredExpenses.value].sort((a, b) => new Date(b.date) - new Date(a.date)); 
                    sorted.forEach(item => { 
                        if (!groups[item.date]) { groups[item.date] = { items: [], dailyTotalJPY: 0 }; } 
                        groups[item.date].items.push(item); 
                        groups[item.date].dailyTotalJPY += toJPY(item); 
                    }); 
                    Object.keys(groups).forEach(date => { groups[date].dailyTotalJPY = Math.round(groups[date].dailyTotalJPY); }); 
                    return groups; 
                });

                const saveExpense = () => { if (!expenseForm.value.amount || !expenseForm.value.name) { alert("請輸入金額及消費項目"); return; } if (isEditingExpense.value) { const index = expenseList.value.findIndex(i => i.id === editingExpenseId.value); if(index !== -1) expenseList.value[index] = { ...expenseForm.value, id: editingExpenseId.value }; isEditingExpense.value = false; editingExpenseId.value = null; } else { expenseList.value.unshift({ ...expenseForm.value, id: Date.now() }); } expenseForm.value = { category: '飲食', name: '', date: new Date().toISOString().split('T')[0], amount: '', currency: 'JPY', payment: 'cash', payer: 'Kyle' }; expenseMode.value = 'list'; };
                const editExpense = (item) => { isEditingExpense.value = true; editingExpenseId.value = item.id; expenseForm.value = { ...item }; expenseMode.value = 'input'; };
                const cancelEditExpense = () => { isEditingExpense.value = false; editingExpenseId.value = null; expenseForm.value = { category: '飲食', name: '', date: new Date().toISOString().split('T')[0], amount: '', currency: 'JPY', payment: 'cash', payer: 'Kyle' }; expenseMode.value = 'list'; };
                const removeExpense = (id) => { if(confirm('確定刪除此筆消費？')) expenseList.value = expenseList.value.filter(i => i.id !== id); };

                // Journal
                const journalEntries = ref([ 
                    { id: 1, date: '2025-12-22', time: '22:30', author: 'Kyle', text: '終於抵達北海道了！外面真的超級冷，但是雪景美到不行。', photos: [] } 
                ]);
                const showJournalModal = ref(false);
                const journalForm = ref({ date: '', author: 'Kyle', text: '', photos: [] });
                
                const openJournalModal = () => { 
                    const now = new Date();
                    const dateStr = now.toISOString().split('T')[0];
                    journalForm.value = { date: dateStr, author: 'Kyle', text: '', photos: [] }; 
                    showJournalModal.value = true; 
                };
                
                const handleJournalPhotos = (event) => {
                    const files = Array.from(event.target.files);
                    if (journalForm.value.photos.length + files.length > 5) {
                        alert('最多只能上傳 5 張照片');
                        return;
                    }
                    files.forEach(file => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            journalForm.value.photos.push(e.target.result);
                        };
                        reader.readAsDataURL(file);
                    });
                };
                
                const removeJournalPhoto = (index) => {
                    journalForm.value.photos.splice(index, 1);
                };

                const saveJournal = () => { 
                    if(!journalForm.value.text) return; 
                    const now = new Date();
                    journalEntries.value.unshift({ 
                        id: Date.now(), 
                        date: journalForm.value.date, 
                        time: `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`, 
                        author: journalForm.value.author,
                        text: journalForm.value.text,
                        photos: [...journalForm.value.photos]
                    }); 
                    showJournalModal.value = false; 
                };

                // Prep (UPDATED)
                const exchange = ref({ jpy: 1000, mop: 0, rate: 0.054 }); 
                const calculateMOP = () => { exchange.value.mop = (exchange.value.jpy * exchange.value.rate).toFixed(1); };
                calculateMOP();
                
                const prepTab = ref('packing'); // 'packing' or 'shopping'
                const packingFilter = ref('all');
                const packingList = ref([ 
                    { id: 1, title: '重要證件', items: [{id:101, text:'護照', checked:false, owner: 'Kyle', image: null}, {id:102, text:'電子機票', checked:false, owner: 'Hayley', image: null}] }, 
                    { id: 2, title: '衣物類', items: [{id:201, text:'發熱衣', checked:false, owner: 'Kyle', image: null}, {id:202, text:'羽絨外套', checked:false, owner: 'Hayley', image: null}] } 
                ]);

                // Shopping List Data
                const shoppingList = ref([
                    { id: 1, name: '六花亭奶油夾心餅', note: '要買5盒送同事', owner: 'Kyle', bought: false, image: 'https://www.rokkatei.co.jp/wp-content/uploads/2020/12/10052.jpg' },
                    { id: 2, name: '藥妝 - 合利他命', note: '幫媽媽買2罐', owner: 'Hayley', bought: false, image: null }
                ]);

                // Filter Logic for Packing
                const filteredPackingList = computed(() => {
                    if (packingFilter.value === 'all') return packingList.value;
                    return packingList.value.map(cat => ({
                        ...cat,
                        items: cat.items.filter(item => item.owner === packingFilter.value)
                    })).filter(cat => cat.items.length > 0 || packingList.value.find(c => c.id === cat.id).items.length === 0);
                });

                // Filter Logic for Shopping
                const filteredShoppingList = computed(() => {
                    if (packingFilter.value === 'all') return shoppingList.value;
                    return shoppingList.value.filter(item => item.owner === packingFilter.value);
                });

                const packingProgress = computed(() => { 
                    let total = 0, checked = 0; 
                    filteredPackingList.value.forEach(cat => cat.items.forEach(i => { total++; if(i.checked) checked++; })); 
                    return total === 0 ? 0 : Math.round((checked / total) * 100); 
                });

                const addCategory = () => { const name = prompt("請輸入新類別名稱："); if(name) packingList.value.push({ id: Date.now(), title: name, items: [] }); };
                const removeCategory = (id) => { if(confirm('刪除此類別及所有項目？')) packingList.value = packingList.value.filter(c => c.id !== id); };
                
                // Packing Modal Logic
                const showPackingModal = ref(false);
                const isEditingPacking = ref(false);
                const editingPackingId = ref(null);
                const editingCategoryId = ref(null);
                const packingForm = ref({ text: '', owner: 'Kyle', image: null });

                const openPackingModal = (catId, itemId = null) => {
                    editingCategoryId.value = catId;
                    if (itemId) {
                        isEditingPacking.value = true;
                        editingPackingId.value = itemId;
                        const category = packingList.value.find(c => c.id === catId);
                        const item = category.items.find(i => i.id === itemId);
                        packingForm.value = { text: item.text, owner: item.owner, image: item.image };
                    } else {
                        isEditingPacking.value = false;
                        packingForm.value = { text: '', owner: 'Kyle', image: null };
                    }
                    showPackingModal.value = true;
                };

                const handlePackingImage = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => { packingForm.value.image = e.target.result; };
                        reader.readAsDataURL(file);
                    }
                };

                const savePackingItem = () => {
                    if (!packingForm.value.text) { alert('請輸入物品名稱'); return; }
                    const categoryIndex = packingList.value.findIndex(c => c.id === editingCategoryId.value);
                    if (categoryIndex === -1) return;

                    if (isEditingPacking.value) {
                        const itemIndex = packingList.value[categoryIndex].items.findIndex(i => i.id === editingPackingId.value);
                        if (itemIndex !== -1) {
                            packingList.value[categoryIndex].items[itemIndex] = {
                                ...packingList.value[categoryIndex].items[itemIndex],
                                text: packingForm.value.text,
                                owner: packingForm.value.owner,
                                image: packingForm.value.image
                            };
                        }
                    } else {
                        packingList.value[categoryIndex].items.push({
                            id: Date.now(),
                            text: packingForm.value.text,
                            owner: packingForm.value.owner,
                            image: packingForm.value.image,
                            checked: false
                        });
                    }
                    showPackingModal.value = false;
                };

                const deletePackingItem = (catId, itemId) => {
                    if(confirm('確定要刪除此物品嗎？')) {
                        const category = packingList.value.find(c => c.id === catId);
                        if (category) {
                            category.items = category.items.filter(i => i.id !== itemId);
                        }
                    }
                };

                // Shopping Modal Logic
                const showShoppingModal = ref(false);
                const isEditingShopping = ref(false);
                const editingShoppingId = ref(null);
                const shoppingForm = ref({ name: '', note: '', owner: 'Kyle', image: null });

                const openShoppingModal = (item = null) => {
                    if (item) {
                        isEditingShopping.value = true;
                        editingShoppingId.value = item.id;
                        shoppingForm.value = { name: item.name, note: item.note, owner: item.owner, image: item.image };
                    } else {
                        isEditingShopping.value = false;
                        shoppingForm.value = { name: '', note: '', owner: 'Kyle', image: null };
                    }
                    showShoppingModal.value = true;
                };

                const handleShoppingImage = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => { shoppingForm.value.image = e.target.result; };
                        reader.readAsDataURL(file);
                    }
                };

                const saveShoppingItem = () => {
                    if (!shoppingForm.value.name) { alert('請輸入商品名稱'); return; }
                    
                    if (isEditingShopping.value) {
                        const index = shoppingList.value.findIndex(i => i.id === editingShoppingId.value);
                        if (index !== -1) {
                            shoppingList.value[index] = {
                                ...shoppingList.value[index],
                                name: shoppingForm.value.name,
                                note: shoppingForm.value.note,
                                owner: shoppingForm.value.owner,
                                image: shoppingForm.value.image
                            };
                        }
                    } else {
                        shoppingList.value.push({
                            id: Date.now(),
                            name: shoppingForm.value.name,
                            note: shoppingForm.value.note,
                            owner: shoppingForm.value.owner,
                            image: shoppingForm.value.image,
                            bought: false
                        });
                    }
                    showShoppingModal.value = false;
                };

                const deleteShoppingItem = (id) => {
                    if(confirm('確定要刪除此採購項目嗎？')) {
                        shoppingList.value = shoppingList.value.filter(i => i.id !== id);
                    }
                };
                
                const openImagePreview = (src) => {
                    const win = window.open();
                    win.document.write('<img src="' + src + '" style="max-width:100%">');
                };

                // Helpers & Snow
                const getCategoryIcon = (cat) => ({ sightseeing: 'fas fa-camera', flight: 'fas fa-plane', transport: 'fas fa-train', food: 'fas fa-utensils', shopping: 'fas fa-shopping-bag', other: 'fas fa-sticky-note' }[cat] || 'fas fa-circle');
                const getCategoryColor = (cat) => ({ sightseeing: 'bg-emerald-400', flight: 'bg-sky-500', transport: 'bg-blue-500', food: 'bg-orange-400', shopping: 'bg-pink-400', other: 'bg-slate-400' }[cat] || 'bg-slate-400');
                const getTransportIcon = (mode) => ({ walk: 'fa-walking', train: 'fa-subway', taxi: 'fa-taxi', plane: 'fa-plane', ship: 'fa-ship', bus: 'fa-bus' }[mode] || 'fa-car');
                const getExpenseIcon = (cat) => ({ '飲食': 'fas fa-utensils', '交通': 'fas fa-bus', '住宿': 'fas fa-bed', '門票': 'fas fa-ticket-alt', '購物': 'fas fa-shopping-bag', '其他': 'fas fa-comment-dots' }[cat]);
                const getExpenseColor = (cat) => ({ '飲食': 'bg-orange-400', '交通': 'bg-blue-500', '住宿': 'bg-indigo-500', '門票': 'bg-pink-500', '購物': 'bg-emerald-400', '其他': 'bg-slate-400' }[cat]);

                onMounted(() => {
                    const snowContainer = document.getElementById('snow-container');
                    for(let i=0; i<30; i++) { const flake = document.createElement('div'); flake.classList.add('snowflake'); const size = Math.random() * 5 + 2 + 'px'; flake.style.width = size; flake.style.height = size; flake.style.left = Math.random() * 100 + 'vw'; flake.style.animationDuration = Math.random() * 5 + 5 + 's'; flake.style.animationDelay = Math.random() * 5 + 's'; snowContainer.appendChild(flake); }
                });

                return {
                    currentTab, selectedDayIndex, scheduleData, currentDaySchedule, bookingCategory, weatherForecast, currentDayWeather, countdown,
                    showScheduleModal, isEditingSchedule, scheduleForm, openScheduleModal, editScheduleItem, saveSchedule, removeScheduleItem,
                    flightData, showFlightModal, flightForm, editFlight, saveFlight,
                    hotelData, showHotelModal, hotelForm, openHotelModal, saveHotel,
                    tourData, showTourModal, tourForm, openTourModal, saveTour,
                    voucherList, showVoucherModal, isEditingVoucher, voucherForm, openVoucherModal, handleVoucherFile, saveVoucher, editVoucher, deleteVoucher,
                    expenseMode, expenseFilter, expenseList, isEditingExpense, expenseForm, saveExpense, editExpense, cancelEditExpense, removeExpense, 
                    totalExpensesJPY, totalCashJPY, totalCardJPY, totalEpayJPY, groupedExpenses, mopToJpyRate,
                    journalEntries, showJournalModal, journalForm, openJournalModal, saveJournal, handleJournalPhotos, removeJournalPhoto,
                    exchange, calculateMOP, 
                    // Packing & Shopping
                    prepTab, packingList, packingFilter, filteredPackingList, packingProgress, addCategory, removeCategory, 
                    showPackingModal, isEditingPacking, packingForm, openPackingModal, handlePackingImage, savePackingItem, deletePackingItem, openImagePreview,
                    shoppingList, filteredShoppingList, showShoppingModal, isEditingShopping, shoppingForm, openShoppingModal, handleShoppingImage, saveShoppingItem, deleteShoppingItem,
                    // Helpers
                    getCategoryIcon, getCategoryColor, getTransportIcon, getExpenseIcon, getExpenseColor,
                    restaurantData
                };
            }
        }).mount('#app');
    </script>
</body>
</html>