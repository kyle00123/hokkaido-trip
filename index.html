<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>北緯43°の約定 (Cloud)</title>
    
    <!-- Icon -->
    <link rel="apple-touch-icon" id="app-icon" href="https://cdn-icons-png.flaticon.com/512/616/616490.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/616/616490.png">

    <!-- iOS Web App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="北緯43°の約定">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs (Modular) -->
    <script type="module">
        // 這裡會由下方的 Vue script 區塊統一處理
    </script>

    <style>
        [v-cloak] { display: none !important; }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #F0F9FF; 
            color: #334155;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
            overflow-x: hidden;
            padding-bottom: 110px;
            padding-top: env(safe-area-inset-top);
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Banner */
        .banner-container {
            height: 280px; 
            width: 100%;
            position: relative;
            z-index: 0;
            overflow: hidden;
        }
        .banner-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            filter: brightness(0.9); 
        }

        /* Music Control */
        .music-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 50;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s;
            margin-top: env(safe-area-inset-top);
        }
        .music-btn.playing {
            background: rgba(14, 165, 233, 0.8);
            border-color: #0EA5E9;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(14, 165, 233, 0); }
            100% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); }
        }

        /* Main Content */
        .main-content {
            position: relative;
            z-index: 10;
            margin-top: -40px; 
            background: #F0F9FF; 
            border-top-left-radius: 32px;
            border-top-right-radius: 32px;
            min-height: calc(100vh - 240px);
            padding-top: 24px; 
            padding-bottom: 40px;
            box-shadow: 0 -10px 25px rgba(14, 165, 233, 0.15);
        }

        /* Apple Style Dock */
        .apple-dock-container {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            justify-content: center;
            width: auto;
            margin-bottom: env(safe-area-inset-bottom);
        }

        .apple-dock {
            display: flex;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(255, 255, 255, 0.5) inset;
        }

        .dock-item {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #94A3B8;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            position: relative;
        }

        .dock-item.active {
            background: #0EA5E9;
            color: white;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
            transform: translateY(-6px);
        }

        /* FAB - Updated Z-Index */
        .fab-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #FCD34D 0%, #F59E0B 100%);
            border-radius: 50%;
            color: #78350F;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
            z-index: 150; /* Increased to be above Dock */
            transition: transform 0.2s;
            border: 2px solid rgba(255,255,255,0.4);
            margin-bottom: env(safe-area-inset-bottom);
            cursor: pointer; /* Ensure pointer cursor */
        }
        .fab-btn:active { transform: scale(0.9); }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        /* Travel Time Connector */
        .travel-connector {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: -6px 0;
            z-index: 5; /* Higher than timeline line */
            padding: 8px 0;
            cursor: pointer;
            transition: all 0.2s;
            /* Align with timeline */
            margin-left: 14px; 
            width: 40px;
        }
        .travel-connector:hover .travel-badge {
            background: #e0f2fe;
            border-color: #7dd3fc;
            color: #0284c7;
            transform: scale(1.05);
        }
        .travel-line { height: 18px; width: 0; border-left: 2px dashed #cbd5e1; }
        .travel-badge {
            background: #f8fafc; color: #64748b; font-size: 10px; padding: 4px 8px;
            border-radius: 12px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 4px; font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.2s;
            white-space: nowrap;
        }

        /* Timeline Styles */
        .timeline-line-bg {
            position: absolute;
            left: 33px; /* Adjusted to center with icons */
            top: 20px;
            bottom: 20px;
            width: 2px;
            background-color: #E2E8F0;
            z-index: 0;
        }

        /* Drag Handle */
        .drag-handle { cursor: grab; touch-action: none; }
        .sortable-ghost { opacity: 0.4; background: #e0f2fe; }

        /* Booking Sub-nav */
        .booking-nav-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 8px 12px; border-radius: 12px; transition: all 0.2s;
            min-width: 60px; text-align: center;
        }
        .booking-nav-item.active { background: #E0F2FE; color: #0284C7; }
        .booking-nav-item i { font-size: 18px; margin-bottom: 4px; }
        .booking-nav-item span { font-size: 10px; font-weight: bold; }

        /* Transport Mode Selector */
        .transport-option {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 100%; height: 40px; border-radius: 8px; border: 1px solid #e2e8f0;
            color: #94a3b8; cursor: pointer; transition: all 0.2s; font-size: 14px;
        }
        .transport-option.active { background: #0ea5e9; color: white; border-color: #0ea5e9; box-shadow: 0 2px 5px rgba(14,165,233,0.3); }
        
        /* Snow Effect */
        #snow-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; overflow: hidden; }
        .snowflake { position: absolute; top: -10px; background: white; border-radius: 50%; opacity: 0.8; animation: fall linear infinite; }
        @keyframes fall {
            0% { transform: translateY(-10px) translateX(0) rotate(0deg); opacity: 0.8; }
            100% { transform: translateY(100vh) translateX(20px) rotate(360deg); opacity: 0.2; }
        }

        /* Custom Radio for Currency/Payment */
        .custom-radio-group { display: flex; background: #F1F5F9; padding: 4px; border-radius: 12px; }
        .custom-radio-item { flex: 1; text-align: center; padding: 8px 0; font-size: 13px; font-weight: bold; color: #64748B; border-radius: 8px; transition: all 0.2s; cursor: pointer; }
        .custom-radio-item.active { background: white; color: #0EA5E9; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* Flight Card Styles */
        .flight-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            overflow: hidden;
            margin-bottom: 24px;
            border: 1px solid #F1F5F9;
        }
        .flight-header {
            background: #F8FAFC;
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #E2E8F0;
        }
        .flight-body {
            padding: 24px 20px;
        }
        .airport-code {
            font-size: 32px;
            font-weight: 800;
            color: #334155;
            line-height: 1;
        }
        .flight-time {
            font-size: 18px;
            font-weight: 700;
            color: #475569;
        }
        .flight-path-line {
            height: 2px;
            background-image: linear-gradient(to right, #CBD5E1 50%, transparent 50%);
            background-size: 10px 1px;
            width: 100%;
            position: relative;
            margin-top: 8px;
        }

        /* Toast Notification */
        .toast-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 16px 24px;
            border-radius: 16px;
            font-weight: bold;
            font-size: 14px;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            backdrop-filter: blur(4px);
            animation: fadeInOut 2s forwards;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translate(-50%, -40%); }
            10% { opacity: 1; transform: translate(-50%, -50%); }
            80% { opacity: 1; transform: translate(-50%, -50%); }
            100% { opacity: 0; transform: translate(-50%, -60%); }
        }

        /* Loading Spinner */
        .loading-overlay {
            position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #0ea5e9; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-600">

    <div id="snow-container"></div>
    
    <!-- Background Music -->
    <audio id="bgm" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/11/22/audio_febc508520.mp3" type="audio/mp3">
    </audio>

    <div id="app" class="relative min-h-screen" v-cloak>
        
        <!-- Loading -->
        <div v-if="isLoading" class="loading-overlay">
            <div class="spinner mb-2"></div>
            <div class="text-xs font-bold text-slate-400">正在同步雲端資料...</div>
        </div>

        <!-- Toast -->
        <div v-if="showToast" class="toast-notification">
            <i class="fas fa-check-circle text-green-400 text-lg"></i>
            <span>{{ toastMessage }}</span>
        </div>

        <!-- Header -->
        <header class="banner-container">
            <img src="https://i.imgur.com/gO14i4a.jpeg" alt="北海道插畫" class="banner-image">
            <div class="absolute inset-0 bg-gradient-to-t from-[#F0F9FF] via-[#F0F9FF]/20 to-black/30"></div>
            
            <!-- Music Toggle Button -->
            <button @click="toggleMusic" :class="['music-btn', isMusicPlaying ? 'playing' : '']">
                <i :class="['fas', isMusicPlaying ? 'fa-music' : 'fa-play']"></i>
            </button>

            <div class="absolute bottom-16 left-6 text-slate-700 drop-shadow-sm z-10">
                <h1 class="text-3xl font-bold tracking-wide text-slate-800 drop-shadow-sm">北緯43°の約定</h1>
                <p class="text-sm mt-1 text-slate-600 font-medium"><i class="far fa-calendar-alt mr-1"></i> 2025 Dec 22 - 29</p>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content px-4">
            
            <!-- ================= TAB 1: SCHEDULE (行程) ================= -->
            <div v-if="currentTab === 'schedule'">
                
                <!-- Date Selector (New Design) -->
                <div ref="dateScrollContainer" class="flex overflow-x-auto gap-3 px-1 pb-4 pt-2 hide-scrollbar snap-x mb-2">
                    <div v-for="(day, index) in scheduleData" :key="index" :id="'day-btn-' + index" @click="changeDay(index)"
                        :class="['snap-center flex-shrink-0 relative overflow-hidden transition-all duration-300 cursor-pointer rounded-2xl border',
                                 selectedDayIndex === index 
                                 ? 'w-20 h-20 bg-gradient-to-br from-sky-500 to-blue-600 text-white border-transparent shadow-lg shadow-sky-200 scale-105 z-10' 
                                 : 'w-16 h-16 bg-white/70 backdrop-blur-sm text-slate-500 border-white hover:bg-white']">
                        
                        <!-- Active Indicator Dot -->
                        <div v-if="selectedDayIndex === index" class="absolute top-2 right-2 w-1.5 h-1.5 bg-white rounded-full animate-pulse"></div>

                        <div class="flex flex-col items-center justify-center h-full w-full">
                            <span :class="['text-[10px] font-bold uppercase tracking-wider mb-0.5', selectedDayIndex === index ? 'opacity-80' : 'opacity-50']">Day {{ index + 1 }}</span>
                            <span :class="['text-xl font-bold leading-none font-mono', selectedDayIndex === index ? 'text-white' : 'text-slate-700']">{{ day.date }}</span>
                            <span :class="['text-[10px] font-medium mt-0.5', selectedDayIndex === index ? 'opacity-90' : 'opacity-50']">{{ day.weekday }}</span>
                        </div>
                    </div>
                </div>

                <div v-if="selectedDayIndex === 0" class="mb-5 bg-sky-100/80 border border-sky-200 rounded-2xl p-4 text-center shadow-sm">
                    <div class="text-xs font-bold text-sky-500 uppercase tracking-wider mb-1">距離出發 (12/22 00:05)</div>
                    <div class="text-2xl font-bold text-sky-700 font-mono">{{ countdown }}</div>
                </div>

                <section class="mb-5 bg-gradient-to-br from-blue-500 to-sky-400 rounded-2xl p-5 text-white shadow-lg shadow-sky-200 relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
                    <div class="flex items-center justify-between relative z-10 mb-4 border-b border-white/20 pb-4">
                        <div>
                            <div class="text-xs font-bold opacity-80 mb-1 flex items-center gap-1">
                                <i class="fas fa-map-marker-alt"></i> 札幌 (即時預報)
                                <span v-if="isRealTimeWeather" class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                            </div>
                            <div class="text-3xl font-bold tracking-wider">{{ currentDayWeather.temp.split('/')[0] }} <span class="text-sm font-normal opacity-70">{{ currentDayWeather.temp.split('/')[1] }}</span></div>
                            <div class="text-xs font-bold mt-1 bg-white/20 inline-block px-2 py-0.5 rounded-full">{{ currentDayWeather.desc }}</div>
                        </div>
                        <div class="text-center"><i :class="['text-5xl drop-shadow-md', currentDayWeather.icon]"></i></div>
                    </div>
                    <div class="flex gap-3 mb-3">
                        <div class="flex-1 bg-white/10 rounded-lg p-2 flex items-center justify-center gap-2">
                            <i class="fas fa-sun text-yellow-300 text-xs"></i>
                            <span class="text-xs font-bold">{{ currentDayWeather.sunrise }}</span>
                        </div>
                        <div class="flex-1 bg-white/10 rounded-lg p-2 flex items-center justify-center gap-2">
                            <i class="fas fa-moon text-indigo-200 text-xs"></i>
                            <span class="text-xs font-bold">{{ currentDayWeather.sunset }}</span>
                        </div>
                    </div>
                    <div class="bg-white/10 rounded-lg p-3 relative z-10">
                        <div class="flex items-start justify-between gap-3">
                            <div class="flex items-start gap-3 flex-1">
                                <div class="bg-white/20 w-8 h-8 rounded-full flex items-center justify-center shrink-0 mt-0.5">
                                    <i class="fas fa-tshirt text-xs"></i>
                                </div>
                                <div class="min-w-0">
                                    <div class="text-[10px] opacity-70 mb-1">穿搭建議</div>
                                    <div class="text-xs font-bold leading-relaxed whitespace-normal">{{ currentDayWeather.outfit }}</div>
                                </div>
                            </div>
                            <button @click="withAuth(openOutfitModal)" class="w-6 h-6 rounded-full bg-white/20 flex items-center justify-center text-white hover:bg-white/40 shrink-0">
                                <i class="fas fa-pen text-[10px]"></i>
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Schedule List Container with TIMELINE -->
                <div :key="listKey" id="schedule-list-container" class="space-y-0 pb-20 min-h-[200px] relative pl-2">
                    <!-- Timeline Line -->
                    <div class="timeline-line-bg"></div>

                    <div v-for="(item, index) in currentDaySchedule" :key="item.id" :data-id="item.id" class="schedule-item-wrapper relative">
                        
                        <!-- Travel Connector (Aligned with timeline) -->
                        <div v-if="item.travelTime" class="travel-connector" @click.stop="withAuth(() => editScheduleItem(item))">
                            <div class="travel-badge">
                                <i :class="['fas text-sky-500', getTransportIcon(item.travelMode)]"></i>
                                <span>{{ item.travelTime }}</span>
                            </div>
                        </div>
                        <div v-else-if="index > 0" class="h-6"></div>

                        <div class="flex gap-3 items-start relative z-10 group">
                            <!-- Category Icon (Acts as Timeline Dot) -->
                            <div class="flex flex-col items-center justify-start w-14 shrink-0 pt-1 relative">
                                <div :class="['w-10 h-10 rounded-full flex items-center justify-center mb-1 text-white shadow-sm border-2 border-[#F0F9FF] z-10', getCategoryColor(item.category)]">
                                    <i :class="getCategoryIcon(item.category)"></i>
                                </div>
                                <div class="text-[10px] font-bold text-slate-500 text-center leading-tight">
                                    {{ item.startTime || '--:--' }}
                                    <span v-if="item.endTime" class="block text-[9px] opacity-70 mt-0.5">{{ item.endTime }}</span>
                                </div>
                            </div>

                            <!-- Content Card -->
                            <div class="bg-white/90 backdrop-blur-sm p-4 rounded-2xl shadow-sm border border-white flex-1 min-w-0 relative">
                                <div class="drag-handle absolute right-2 top-2 w-8 h-8 flex items-center justify-center text-slate-300 opacity-30 hover:opacity-100">
                                    <i class="fas fa-grip-lines"></i>
                                </div>
                                <div class="flex items-center gap-2 mb-1 pr-6">
                                    <span class="text-[10px] px-1.5 py-0.5 rounded bg-slate-100 text-slate-500 font-bold">{{ item.categoryLabel }}</span>
                                    <a :href="'https://www.google.com/maps/search/?api=1&query=' + encodeURIComponent(item.address ? item.address : item.name)" target="_blank" class="text-[10px] px-1.5 py-0.5 rounded bg-blue-50 text-blue-500 font-bold flex items-center gap-1 hover:bg-blue-100 transition-colors">
                                        <i class="fas fa-location-arrow text-[9px]"></i> 導航
                                    </a>
                                </div>
                                <h3 class="font-bold text-slate-800 truncate text-sm mb-1">{{ item.name }}</h3>
                                <div class="flex flex-wrap gap-2 mb-1.5">
                                    <span v-if="item.openingHours" class="text-[10px] text-slate-500 bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100 flex items-center gap-1"><i class="far fa-clock"></i> {{ item.openingHours }}</span>
                                    <span v-if="item.cost" class="text-[10px] text-slate-500 bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100 flex items-center gap-1"><i class="fas fa-ticket-alt"></i> {{ item.cost }}</span>
                                </div>
                                <p v-if="item.note" class="text-xs text-slate-500 mt-0.5 truncate">{{ item.note }}</p>
                                
                                <!-- Action Buttons (Inside card now) -->
                                <div class="flex justify-end gap-2 mt-2 border-t border-slate-50 pt-2">
                                    <button @click.stop="withAuth(() => editScheduleItem(item))" class="text-xs font-bold text-slate-400 hover:text-sky-500 px-2 py-1 rounded hover:bg-sky-50 transition-colors"><i class="fas fa-pen mr-1"></i>編輯</button>
                                    <button @click.stop="withAuth(() => removeScheduleItem(item.id))" class="text-xs font-bold text-slate-400 hover:text-rose-500 px-2 py-1 rounded hover:bg-rose-50 transition-colors"><i class="fas fa-trash-alt mr-1"></i>刪除</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-if="currentDaySchedule.length === 0" class="text-center py-10 text-slate-400 text-sm">
                        <i class="far fa-snowflake text-2xl mb-2 opacity-50 block"></i> 無行程，點擊右下角新增
                    </div>
                </div>
            </div>

            <!-- ================= TAB 2: BOOKING (預訂) ================= -->
            <div v-if="currentTab === 'booking'" class="pb-20">
                <!-- ... (Booking content remains same) ... -->
                <div class="bg-white/80 backdrop-blur-md rounded-2xl p-2 mb-4 flex justify-between shadow-sm border border-white">
                    <div @click="bookingCategory = 'flight'" :class="['booking-nav-item', bookingCategory === 'flight' ? 'active' : 'text-slate-400']"><i class="fas fa-plane"></i><span>機票</span></div>
                    <div @click="bookingCategory = 'hotel'" :class="['booking-nav-item', bookingCategory === 'hotel' ? 'active' : 'text-slate-400']"><i class="fas fa-hotel"></i><span>住宿</span></div>
                    <div @click="bookingCategory = 'tour'" :class="['booking-nav-item', bookingCategory === 'tour' ? 'active' : 'text-slate-400']"><i class="fas fa-bus"></i><span>一日團</span></div>
                    <div @click="bookingCategory = 'voucher'" :class="['booking-nav-item', bookingCategory === 'voucher' ? 'active' : 'text-slate-400']"><i class="fas fa-ticket-alt"></i><span>憑證</span></div>
                    <div @click="bookingCategory = 'other'" :class="['booking-nav-item', bookingCategory === 'other' ? 'active' : 'text-slate-400']"><i class="fas fa-ellipsis-h"></i><span>其他</span></div>
                </div>

                <div class="animate-fade-in">
                    <!-- Flight -->
                    <div v-if="bookingCategory === 'flight'" class="space-y-6">
                        <div v-for="(flight, fIndex) in flightData" :key="fIndex" class="flight-card relative">
                             <div class="flight-header">
                                <div class="flex items-center gap-2">
                                    <img :src="flight.logo" alt="Airline" class="h-4 object-contain">
                                    <span class="text-sm font-bold text-slate-600">{{ flight.airline }}</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="bg-sky-100 text-sky-700 text-xs font-bold px-3 py-1 rounded-full">{{ flight.typeLabel }} {{ flight.date }}</div>
                                    <button @click="withAuth(() => editFlight(flight))" class="w-7 h-7 rounded-full bg-slate-100 hover:bg-sky-50 text-slate-400 hover:text-sky-500 flex items-center justify-center transition-colors">
                                        <i class="fas fa-pen text-xs"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flight-body">
                                <div v-for="(leg, lIndex) in flight.legs" :key="lIndex" :class="lIndex < flight.legs.length - 1 ? 'mb-6' : ''">
                                    <div class="flex justify-between items-center">
                                        <div class="text-center w-1/3">
                                            <div class="airport-code">{{ leg.dep }}</div>
                                            <div class="flight-time" v-html="leg.depTime"></div>
                                            <div class="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded-md inline-block mt-1">{{ leg.termDep }}</div>
                                        </div>
                                        <div class="flex-1 px-2 text-center relative">
                                            <div class="text-xs text-slate-400 mb-1">{{ leg.duration }}</div>
                                            <div class="flight-path-line"></div>
                                            <div class="text-[12px] font-bold text-sky-600 mt-2">{{ leg.flightNo }}</div>
                                            <div class="text-[10px] text-slate-400 mt-0.5">{{ leg.aircraft }}</div>
                                        </div>
                                        <div class="text-center w-1/3">
                                            <div class="airport-code">{{ leg.arr }}</div>
                                            <div class="flight-time" v-html="leg.arrTime"></div>
                                            <div class="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded-md inline-block mt-1">{{ leg.termArr }}</div>
                                        </div>
                                    </div>
                                    <div v-if="lIndex < flight.legs.length - 1 && flight.transfer" class="mt-6 bg-orange-50 border border-orange-100 rounded-xl p-3 flex items-center justify-center gap-2">
                                        <i class="fas fa-walking text-orange-500"></i>
                                        <div class="text-xs text-orange-700 font-bold">
                                            {{ flight.transfer.text }} <span class="text-orange-400 mx-1">|</span> <span class="text-orange-600">{{ flight.transfer.note }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Hotel -->
                    <div v-if="bookingCategory === 'hotel'" class="space-y-6">
                        <div class="bg-white rounded-3xl overflow-hidden shadow-sm border border-slate-100">
                            <div class="h-48 relative">
                                <img :src="hotelData.image" alt="Hotel" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                                <div class="absolute bottom-4 left-4 text-white">
                                    <h2 class="text-xl font-bold leading-tight mb-1">{{ hotelData.name }}</h2>
                                    <div class="text-xs opacity-90 font-light"><i class="fas fa-map-marker-alt mr-1"></i>{{ hotelData.address }}</div>
                                </div>
                            </div>
                            <div class="p-5">
                                <div class="flex items-center justify-between bg-slate-50 rounded-xl p-4 mb-5 border border-slate-100">
                                    <div class="text-center">
                                        <div class="text-[10px] text-slate-400 mb-1">入住 IN</div>
                                        <div class="text-lg font-bold text-slate-700">{{ hotelData.checkIn }}</div>
                                        <div class="text-xs font-bold text-sky-600">{{ hotelData.checkInTime }} 後</div>
                                    </div>
                                    <div class="flex flex-col items-center px-4">
                                        <div class="text-[10px] text-slate-400 mb-1">{{ hotelData.nights }}晚</div>
                                        <div class="w-12 h-[1px] bg-slate-300 relative">
                                            <i class="fas fa-moon absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-slate-50 px-1 text-slate-300 text-xs"></i>
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-[10px] text-slate-400 mb-1">退房 OUT</div>
                                        <div class="text-lg font-bold text-slate-700">{{ hotelData.checkOut }}</div>
                                        <div class="text-xs font-bold text-sky-600">{{ hotelData.checkOutTime }} 前</div>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div class="flex items-start gap-3">
                                        <div class="w-8 h-8 rounded-full bg-sky-50 flex items-center justify-center text-sky-500 shrink-0"><i class="fas fa-users"></i></div>
                                        <div>
                                            <div class="text-xs text-slate-400 mb-0.5">住客姓名</div>
                                            <div class="text-sm font-bold text-slate-700 whitespace-pre-line">{{ hotelData.guests }}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-start gap-3">
                                        <div class="w-8 h-8 rounded-full bg-sky-50 flex items-center justify-center text-sky-500 shrink-0"><i class="fas fa-phone-alt"></i></div>
                                        <div>
                                            <div class="text-xs text-slate-400 mb-0.5">聯絡電話</div>
                                            <div class="text-sm font-bold text-slate-700 font-mono">{{ hotelData.phone }}</div>
                                        </div>
                                    </div>
                                </div>
                                <button @click="withAuth(openHotelModal)" class="w-full mt-5 py-2.5 rounded-xl border border-slate-200 text-slate-500 text-sm font-bold hover:bg-slate-50 hover:text-sky-500 hover:border-sky-200 transition-all">
                                    <i class="fas fa-pen mr-1"></i> 編輯住宿資訊
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Tour -->
                    <div v-if="bookingCategory === 'tour'" class="space-y-6">
                        <div class="bg-white rounded-3xl overflow-hidden shadow-sm border border-slate-100 relative">
                            <div class="bg-gradient-to-r from-blue-500 to-sky-400 p-5 text-white">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="text-xs font-bold opacity-80 mb-1">一日團</div>
                                        <h2 class="text-lg font-bold leading-tight">{{ tourData.name }}</h2>
                                    </div>
                                    <div class="bg-white/20 backdrop-blur-sm px-3 py-1 rounded-lg text-sm font-bold">
                                        {{ tourData.date }}
                                    </div>
                                </div>
                            </div>
                            <div class="bg-red-50 border-b border-red-100 p-4 flex items-start gap-3">
                                <i class="fas fa-exclamation-circle text-red-500 mt-0.5 shrink-0"></i>
                                <div>
                                    <div class="text-xs font-bold text-red-500 mb-1">集合重要資訊</div>
                                    <div class="text-sm font-bold text-red-700 leading-relaxed">
                                        {{ tourData.meetingTime }} {{ tourData.meetingPoint }}<br>
                                        {{ tourData.departureTime }} 發車過時不候
                                    </div>
                                </div>
                            </div>
                            <div class="p-5 space-y-5">
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <div class="text-[10px] text-slate-400 mb-1">訂單編號</div>
                                        <div class="text-xs font-bold text-slate-700 font-mono">{{ tourData.bookingId }}</div>
                                    </div>
                                    <div>
                                        <div class="text-[10px] text-slate-400 mb-1">參與人數</div>
                                        <div class="text-xs font-bold text-slate-700">{{ tourData.participants }}</div>
                                    </div>
                                </div>
                                <div class="border-t border-slate-100 pt-4">
                                    <h3 class="text-xs font-bold text-slate-400 mb-3">旅客資訊</h3>
                                    <div class="space-y-3">
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-500">姓名</span>
                                            <span class="text-xs font-bold text-slate-700">{{ tourData.touristName }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-500">電話</span>
                                            <span class="text-xs font-bold text-slate-700">{{ tourData.phone }}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-xs text-slate-500">社交軟體</span>
                                            <span class="text-xs font-bold text-slate-700">{{ tourData.socialApp }}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="bg-slate-50 rounded-xl p-3 border border-slate-100">
                                    <h3 class="text-xs font-bold text-slate-500 mb-2">緊急聯絡人</h3>
                                    <div class="grid grid-cols-1 gap-2">
                                        <div class="flex justify-between items-center">
                                            <span class="text-[10px] bg-red-100 text-red-600 px-1.5 py-0.5 rounded">中國</span>
                                            <a :href="'tel:' + tourData.emergencyCn" class="text-xs font-bold text-slate-700 hover:text-sky-500">{{ tourData.emergencyCn }}</a>
                                        </div>
                                        <div class="flex justify-between items-center">
                                            <span class="text-[10px] bg-blue-100 text-blue-600 px-1.5 py-0.5 rounded">日本</span>
                                            <a :href="'tel:' + tourData.emergencyJp" class="text-xs font-bold text-slate-700 hover:text-sky-500">{{ tourData.emergencyJp }}</a>
                                        </div>
                                    </div>
                                </div>
                                <button @click="withAuth(openTourModal)" class="w-full py-2.5 rounded-xl border border-slate-200 text-slate-500 text-sm font-bold hover:bg-slate-50 hover:text-sky-500 hover:border-sky-200 transition-all">
                                    <i class="fas fa-pen mr-1"></i> 編輯一日團資訊
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Voucher -->
                    <div v-if="bookingCategory === 'voucher'" class="space-y-4">
                        <div class="flex justify-between items-center mb-2 px-2">
                            <h2 class="text-sm font-bold text-slate-500">我的憑證</h2>
                            <button @click="withAuth(openVoucherModal)" class="text-xs font-bold text-sky-500 bg-sky-50 px-3 py-1.5 rounded-lg hover:bg-sky-100 transition-colors">
                                <i class="fas fa-plus mr-1"></i> 新增憑證
                            </button>
                        </div>
                        <div v-if="voucherList.length === 0" class="text-center py-12 text-slate-400">
                            <i class="fas fa-file-pdf text-4xl mb-3 opacity-30"></i>
                            <p class="text-sm">暫無憑證，請點擊上方按鈕新增</p>
                        </div>
                        <div v-for="voucher in voucherList" :key="voucher.id" class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex items-center gap-4 group">
                            <div class="w-12 h-12 rounded-xl bg-red-50 flex items-center justify-center text-red-500 shrink-0">
                                <i class="fas fa-file-pdf text-xl"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="font-bold text-slate-700 truncate">{{ voucher.title }}</h3>
                                <div class="text-xs text-slate-400 truncate mt-0.5">{{ voucher.fileName }}</div>
                                <div class="flex gap-2 mt-1">
                                    <a v-if="voucher.fileUrl" href="#" @click.prevent="openMediaPreview(voucher.fileUrl, voucher.fileType === 'image' ? 'image' : 'pdf')" class="text-[10px] font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded hover:bg-slate-200">
                                        <i class="fas fa-eye mr-1"></i> 預覽
                                    </a>
                                    <a v-if="voucher.fileUrl" :href="voucher.fileUrl" :download="voucher.fileName" target="_blank" class="text-[10px] font-bold text-sky-500 bg-sky-50 px-2 py-1 rounded hover:bg-sky-100">
                                        <i class="fas fa-download mr-1"></i> 下載
                                    </a>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2">
                                <button @click="withAuth(() => deleteVoucher(voucher.id))" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-colors">
                                    <i class="fas fa-trash-alt text-xs"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- Other -->
                    <div v-if="bookingCategory === 'other'" class="space-y-6">
                         <!-- Currency -->
                        <section class="bg-white/90 backdrop-blur-sm rounded-2xl p-5 shadow-sm border border-white">
                            <h2 class="text-sm font-bold text-slate-400 mb-3 flex items-center gap-2"><i class="fas fa-coins text-sky-500"></i> 匯率換算</h2>
                            <div class="flex items-center gap-3">
                                <div class="flex-1">
                                    <label class="text-xs text-slate-400 block mb-1">日幣 (JPY)</label>
                                    <input type="number" v-model="exchange.jpy" @input="calculateMOP" class="w-full bg-sky-50 rounded-lg p-2 font-bold text-lg text-slate-700 outline-none border border-sky-100 focus:border-sky-400">
                                </div>
                                <i class="fas fa-exchange-alt text-sky-200 mt-5"></i>
                                <div class="flex-1">
                                    <label class="text-xs text-slate-400 block mb-1">澳門幣 (MOP)</label>
                                    <input type="number" v-model="exchange.mop" @input="calculateJPY" class="w-full bg-slate-100 rounded-lg p-2 font-bold text-lg text-sky-600 outline-none border border-slate-200 focus:border-sky-400">
                                </div>
                            </div>
                        </section>
                        <!-- Restaurant -->
                        <section class="bg-white rounded-2xl overflow-hidden shadow-sm border border-slate-100">
                            <div class="bg-slate-800 p-4 flex justify-between items-center text-white">
                                <div class="flex items-center gap-2">
                                    <i class="fas fa-utensils text-yellow-400"></i>
                                    <span class="font-bold">餐廳預約確認</span>
                                </div>
                                <span class="text-xs bg-green-500 px-2 py-0.5 rounded text-white font-bold">已確認</span>
                            </div>
                            <div class="p-5">
                                <div class="text-center mb-4 pb-4 border-b border-slate-100">
                                    <h3 class="text-xl font-bold text-slate-800 mb-1">{{ restaurantData.name }}</h3>
                                    <div class="text-sm text-slate-500">{{ restaurantData.course }}</div>
                                </div>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between"><span class="text-slate-400">預約號碼</span><span class="font-bold font-mono">{{ restaurantData.id }}</span></div>
                                    <div class="flex justify-between"><span class="text-slate-400">日期時間</span><span class="font-bold text-sky-600">{{ restaurantData.dateTime }}</span></div>
                                    <div class="flex justify-between"><span class="text-slate-400">人數</span><span class="font-bold">{{ restaurantData.pax }}</span></div>
                                    <div class="flex justify-between"><span class="text-slate-400">座位</span><span class="font-bold">{{ restaurantData.seat }}</span></div>
                                    <div class="flex justify-between"><span class="text-slate-400">預約人</span><span class="font-bold">{{ restaurantData.booker }}</span></div>
                                    <div class="bg-slate-50 p-3 rounded-lg text-xs mt-2">
                                        <div class="font-bold text-slate-700 mb-1"><i class="fas fa-map-marker-alt mr-1"></i>地址</div>
                                        <div class="text-slate-500 mb-2">{{ restaurantData.address }}</div>
                                        <div class="font-bold text-slate-700 mb-1"><i class="fas fa-phone mr-1"></i>電話</div>
                                        <div class="text-slate-500">{{ restaurantData.phone }}</div>
                                    </div>
                                </div>
                            </div>
                        </section>
                        <!-- Visit Japan Web -->
                        <a href="https://vjw-lp.digital.go.jp/en/" target="_blank" class="block bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex items-center justify-between group hover:border-rose-200 transition-colors">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-full bg-rose-50 flex items-center justify-center text-rose-500 shrink-0"><i class="fas fa-passport text-xl"></i></div>
                                <div>
                                    <div class="font-bold text-slate-700 group-hover:text-rose-600 transition-colors">Visit Japan Web</div>
                                    <div class="text-xs text-slate-400">入境手續、海關申報</div>
                                </div>
                            </div>
                            <i class="fas fa-external-link-alt text-slate-300 group-hover:text-rose-500"></i>
                        </a>
                        <!-- Safety -->
                         <section>
                            <h2 class="text-sm font-bold text-slate-400 mb-3 ml-1">防災與緊急求助</h2>
                            <div class="grid grid-cols-2 gap-3">
                                <a href="https://kumamap.com/jp/map" target="_blank" class="bg-yellow-50 p-4 rounded-2xl border border-yellow-100 flex flex-col items-center justify-center text-center gap-2 hover:bg-yellow-100 transition-colors">
                                    <i class="fas fa-paw text-yellow-600 text-2xl"></i>
                                    <div class="font-bold text-yellow-800 text-sm">熊出沒情報</div>
                                </a>
                                <a href="https://www.jma.go.jp/bosai/map.html#5/38.651/138.867/&elem=int&contents=earthquake_map" target="_blank" class="bg-slate-50 p-4 rounded-2xl border border-slate-200 flex flex-col items-center justify-center text-center gap-2 hover:bg-slate-100 transition-colors">
                                    <i class="fas fa-house-damage text-slate-600 text-2xl"></i>
                                    <div class="font-bold text-slate-700 text-sm">防災/地震</div>
                                </a>
                                <a href="tel:110" class="bg-red-50 p-4 rounded-2xl border border-red-100 flex items-center gap-3 col-span-2 hover:bg-red-100 transition-colors">
                                    <div class="w-10 h-10 rounded-full bg-red-500 text-white flex items-center justify-center font-bold shrink-0"><i class="fas fa-phone"></i></div>
                                    <div class="flex-1">
                                        <div class="text-lg font-bold text-red-700">110</div>
                                        <div class="text-xs text-red-500">警察局 (報案)</div>
                                    </div>
                                    <i class="fas fa-chevron-right text-red-200"></i>
                                </a>
                                <a href="tel:119" class="bg-red-50 p-4 rounded-2xl border border-red-100 flex items-center gap-3 col-span-2 hover:bg-red-100 transition-colors">
                                    <div class="w-10 h-10 rounded-full bg-red-500 text-white flex items-center justify-center font-bold shrink-0"><i class="fas fa-ambulance"></i></div>
                                    <div class="flex-1">
                                        <div class="text-lg font-bold text-red-700">119</div>
                                        <div class="text-xs text-red-500">消防/救護車</div>
                                    </div>
                                    <i class="fas fa-chevron-right text-red-200"></i>
                                </a>
                                <a href="tel:+81-80-1009-7179" class="bg-blue-50 p-4 rounded-2xl border border-blue-100 flex items-center gap-3 col-span-2 hover:bg-blue-100 transition-colors">
                                    <div class="w-10 h-10 rounded-full bg-blue-500 text-white flex items-center justify-center font-bold shrink-0"><i class="fas fa-globe"></i></div>
                                    <div class="flex-1">
                                        <div class="text-sm font-bold text-blue-700">外交部急難救助</div>
                                        <div class="text-xs text-blue-500">駐日代表處 (札幌分處)</div>
                                    </div>
                                    <i class="fas fa-chevron-right text-blue-200"></i>
                                </a>
                            </div>
                        </section>
                    </div>
                </div>
            </div>

            <!-- ================= TAB 3: EXPENSES (記帳) ================= -->
            <div v-if="currentTab === 'expenses'" class="pb-20">
                <!-- ... (Expenses content remains same) ... -->
                <div class="flex bg-white/60 p-1 rounded-xl mb-6 shadow-sm border border-white">
                    <button @click="expenseMode = 'input'" :class="['flex-1 py-2 rounded-lg text-sm font-bold transition-all', expenseMode === 'input' ? 'bg-white text-sky-600 shadow-sm' : 'text-slate-400']">記帳輸入</button>
                    <button @click="expenseMode = 'list'" :class="['flex-1 py-2 rounded-lg text-sm font-bold transition-all', expenseMode === 'list' ? 'bg-white text-sky-600 shadow-sm' : 'text-slate-400']">消費明細</button>
                </div>

                <!-- Input Mode -->
                <div v-if="expenseMode === 'input'" class="animate-fade-in">
                    <div class="bg-white/90 backdrop-blur-sm rounded-3xl p-6 shadow-sm border border-white">
                        <div class="space-y-5">
                            <div class="flex flex-col sm:flex-row gap-4">
                                <div class="flex-1">
                                    <label class="block text-xs font-bold text-slate-400 mb-1.5">日期</label>
                                    <input type="date" v-model="expenseForm.date" class="w-full h-[46px] bg-slate-50 border border-slate-200 rounded-xl px-3 text-sm font-bold text-slate-700 outline-none focus:border-sky-400 transition-colors">
                                </div>
                                <div class="flex-1">
                                    <label class="block text-xs font-bold text-slate-400 mb-1.5">付款人</label>
                                    <div class="flex gap-2 h-[46px]">
                                        <div @click="expenseForm.payer = 'Kyle'" :class="['flex-1 flex items-center justify-center rounded-xl text-xs font-bold border cursor-pointer transition-all', expenseForm.payer === 'Kyle' ? 'bg-blue-50 border-blue-200 text-blue-600' : 'bg-slate-50 border-slate-200 text-slate-400']">Kyle</div>
                                        <div @click="expenseForm.payer = 'Hayley'" :class="['flex-1 flex items-center justify-center rounded-xl text-xs font-bold border cursor-pointer transition-all', expenseForm.payer === 'Hayley' ? 'bg-pink-50 border-pink-200 text-pink-600' : 'bg-slate-50 border-slate-200 text-slate-400']">Hayley</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-1.5">金額 & 幣別</label>
                                <div class="flex gap-3">
                                    <div class="relative flex-1">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 font-bold text-slate-400">{{ expenseForm.currency === 'JPY' ? '¥' : 'MOP$' }}</span>
                                        <input type="number" v-model="expenseForm.amount" 
                                               :class="['w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-lg font-bold text-slate-800 outline-none focus:border-sky-400 transition-colors', expenseForm.currency === 'MOP' ? 'pl-16' : 'pl-10']" 
                                               placeholder="0">
                                    </div>
                                    <div class="custom-radio-group w-32">
                                        <div @click="expenseForm.currency = 'JPY'" :class="['custom-radio-item', expenseForm.currency === 'JPY' ? 'active' : '']">JPY</div>
                                        <div @click="expenseForm.currency = 'MOP'" :class="['custom-radio-item', expenseForm.currency === 'MOP' ? 'active' : '']">MOP</div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-1.5">類別</label>
                                <div class="grid grid-cols-4 gap-2">
                                    <div v-for="cat in ['飲食', '交通', '住宿', '購物', '門票', '其他']" :key="cat" 
                                         @click="expenseForm.category = cat"
                                         :class="['text-center py-2 rounded-lg text-xs font-bold border cursor-pointer transition-all', expenseForm.category === cat ? 'bg-sky-50 border-sky-200 text-sky-600' : 'bg-white border-slate-100 text-slate-500']">
                                        {{ cat }}
                                    </div>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-1.5">地點及消費項目</label>
                                <input type="text" v-model="expenseForm.name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none focus:border-sky-400 transition-colors" placeholder="例如：午餐 - 拉麵共和國">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 mb-1.5">支付方式</label>
                                <div class="custom-radio-group">
                                    <div @click="expenseForm.payment = 'cash'" :class="['custom-radio-item', expenseForm.payment === 'cash' ? 'active' : '']"><i class="fas fa-money-bill-wave mr-1"></i>現金</div>
                                    <div @click="expenseForm.payment = 'card'" :class="['custom-radio-item', expenseForm.payment === 'card' ? 'active' : '']"><i class="fas fa-credit-card mr-1"></i>信用卡</div>
                                    <div @click="expenseForm.payment = 'epay'" :class="['custom-radio-item', expenseForm.payment === 'epay' ? 'active' : '']"><i class="fas fa-qrcode mr-1"></i>電子支付</div>
                                </div>
                            </div>
                            <button @click="withAuth(saveExpense)" class="w-full bg-gradient-to-r from-sky-500 to-blue-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-sky-200 active:scale-95 transition-transform mt-2">
                                <i class="fas fa-check mr-2"></i> {{ isEditingExpense ? '更新紀錄' : '儲存紀錄' }}
                            </button>
                            <button v-if="isEditingExpense" @click="cancelEditExpense" class="w-full bg-slate-100 text-slate-500 py-3 rounded-xl font-bold text-sm">取消編輯</button>
                        </div>
                    </div>
                </div>

                <!-- List Mode -->
                <div v-if="expenseMode === 'list'" class="animate-fade-in">
                    
                    <!-- Filter Bar -->
                    <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar">
                        <button @click="expenseFilter = 'all'" :class="['px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors', expenseFilter === 'all' ? 'bg-slate-700 text-white' : 'bg-white text-slate-500 border border-slate-200']">全部</button>
                        <button @click="expenseFilter = 'Kyle'" :class="['px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors flex items-center gap-1', expenseFilter === 'Kyle' ? 'bg-blue-500 text-white' : 'bg-white text-slate-500 border border-slate-200']"><span class="w-2 h-2 rounded-full bg-blue-300"></span> Kyle</button>
                        <button @click="expenseFilter = 'Hayley'" :class="['px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors flex items-center gap-1', expenseFilter === 'Hayley' ? 'bg-pink-500 text-white' : 'bg-white text-slate-500 border border-slate-200']"><span class="w-2 h-2 rounded-full bg-pink-300"></span> Hayley</button>
                    </div>

                    <div class="bg-gradient-to-r from-sky-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg shadow-sky-200 mb-6 relative overflow-hidden">
                        <i class="fas fa-coins absolute -right-4 -top-4 text-8xl text-white opacity-10"></i>
                        <div class="text-xs font-medium opacity-80 mb-1">
                            {{ expenseFilter === 'all' ? '總花費' : expenseFilter + ' 的花費' }} (折合日幣)
                        </div>
                        <div class="text-4xl font-bold drop-shadow-sm">¥{{ totalExpensesJPY.toLocaleString() }}</div>
                        <div class="mt-4 flex flex-wrap gap-x-4 gap-y-2 text-xs opacity-90 border-t border-white/20 pt-3">
                            <div class="flex items-center"><i class="fas fa-money-bill-wave mr-1.5 w-3 text-center"></i>現金: ¥{{ totalCashJPY.toLocaleString() }}</div>
                            <div class="flex items-center"><i class="fas fa-credit-card mr-1.5 w-3 text-center"></i>卡片: ¥{{ totalCardJPY.toLocaleString() }}</div>
                            <div class="flex items-center"><i class="fas fa-qrcode mr-1.5 w-3 text-center"></i>電支: ¥{{ totalEpayJPY.toLocaleString() }}</div>
                        </div>
                    </div>
                    
                    <div class="space-y-6">
                        <div v-for="(group, date) in groupedExpenses" :key="date">
                            <div class="flex justify-between items-end px-2 mb-2">
                                <div class="text-sm font-bold text-slate-500 bg-slate-200/50 px-2 py-1 rounded">{{ date }}</div>
                                <div class="text-xs font-bold text-sky-600">
                                    小計: <span class="text-sm">¥{{ group.dailyTotalJPY.toLocaleString() }}</span>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div v-for="expense in group.items" :key="expense.id" class="bg-white/90 backdrop-blur-sm p-4 rounded-xl shadow-sm border border-white flex justify-between items-center group">
                                    <div class="flex gap-3 items-center flex-1 min-w-0">
                                        <div :class="['w-10 h-10 rounded-full flex items-center justify-center text-white text-sm shadow-sm shrink-0', getExpenseColor(expense.category)]">
                                            <i :class="getExpenseIcon(expense.category)"></i>
                                        </div>
                                        <div class="truncate">
                                            <div class="font-bold text-slate-800 truncate">{{ expense.name }}</div>
                                            <div class="text-xs text-slate-400 flex items-center gap-2 mt-0.5">
                                                <span :class="['px-1.5 py-0.5 rounded text-[10px] font-bold', expense.payer === 'Kyle' ? 'bg-blue-50 text-blue-600' : 'bg-pink-50 text-pink-600']">{{ expense.payer }}</span>
                                                <span v-if="expense.payment === 'card'"><i class="fas fa-credit-card"></i> 信用卡</span>
                                                <span v-else-if="expense.payment === 'epay'"><i class="fas fa-qrcode"></i> 電子支付</span>
                                                <span v-else><i class="fas fa-money-bill-wave"></i> 現金</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex flex-col items-end gap-1">
                                        <div class="font-bold text-slate-800">
                                            <span class="text-xs text-slate-400 mr-0.5">{{ expense.currency === 'JPY' ? '¥' : 'MOP$' }}</span>{{ Number(expense.amount).toLocaleString() }}
                                        </div>
                                        <div class="flex items-center gap-1">
                                            <button @click.stop="withAuth(() => editExpense(expense))" class="w-6 h-6 rounded-full flex items-center justify-center text-slate-300 hover:text-sky-500 hover:bg-sky-50 transition-colors"><i class="fas fa-pen text-[10px]"></i></button>
                                            <button @click.stop="withAuth(() => removeExpense(expense.id))" class="w-6 h-6 rounded-full flex items-center justify-center text-slate-300 hover:text-rose-500 hover:bg-rose-50 transition-colors"><i class="fas fa-trash-alt text-[10px]"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div v-if="Object.keys(groupedExpenses).length === 0" class="text-center py-10 text-slate-400">
                            <p>沒有符合條件的消費紀錄</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= TAB 4: JOURNAL (日誌) ================= -->
            <div v-if="currentTab === 'journal'" class="pb-20">
                <!-- ... (Journal content remains same) ... -->
                <div class="space-y-6">
                    <div v-for="entry in journalEntries" :key="entry.id" class="bg-white/90 backdrop-blur-sm rounded-2xl p-5 shadow-sm border border-white relative group">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <div class="bg-sky-100 text-sky-600 font-bold px-2 py-1 rounded text-xs">{{ entry.date }}</div>
                                <div :class="['text-xs font-bold px-2 py-0.5 rounded-full flex items-center gap-1', entry.author === 'Kyle' ? 'bg-blue-50 text-blue-600' : 'bg-pink-50 text-pink-600']">
                                    <i class="fas fa-user-circle"></i> {{ entry.author }}
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-xs text-slate-400">{{ entry.time }}</span>
                                <button @click="withAuth(() => editJournal(entry))" class="w-6 h-6 rounded-full bg-slate-50 text-slate-400 hover:bg-sky-50 hover:text-sky-500 flex items-center justify-center transition-colors">
                                    <i class="fas fa-pen text-[10px]"></i>
                                </button>
                                <button @click="withAuth(() => deleteJournal(entry.id))" class="w-6 h-6 rounded-full bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-colors">
                                    <i class="fas fa-trash-alt text-[10px]"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-slate-700 leading-relaxed mb-3 whitespace-pre-line">{{ entry.text }}</p>
                        
                        <div v-if="entry.photos && entry.photos.length > 0" class="grid grid-cols-3 gap-2 mt-3">
                            <div v-for="(photo, pIndex) in entry.photos" :key="pIndex" class="aspect-square rounded-lg overflow-hidden bg-slate-100">
                                <img :src="photo" class="w-full h-full object-cover cursor-pointer" alt="Journal photo" @click="openMediaPreview(photo, 'image')">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= TAB 5: PREPARATION (準備) ================= -->
            <div v-if="currentTab === 'preparation'" class="pb-20">
                <!-- ... (Preparation content remains same) ... -->
                <div class="flex bg-white/60 p-1 rounded-xl mb-6 shadow-sm border border-white">
                    <button @click="prepTab = 'packing'" :class="['flex-1 py-2 rounded-lg text-sm font-bold transition-all', prepTab === 'packing' ? 'bg-white text-sky-600 shadow-sm' : 'text-slate-400']">行李清單</button>
                    <button @click="prepTab = 'shopping'" :class="['flex-1 py-2 rounded-lg text-sm font-bold transition-all', prepTab === 'shopping' ? 'bg-white text-sky-600 shadow-sm' : 'text-slate-400']">採購清單</button>
                </div>

                <div class="flex gap-2 mb-4 overflow-x-auto hide-scrollbar">
                    <button @click="packingFilter = 'all'" :class="['px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors', packingFilter === 'all' ? 'bg-slate-700 text-white' : 'bg-white text-slate-500 border border-slate-200']">全部</button>
                    <button @click="packingFilter = 'Kyle'" :class="['px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors flex items-center gap-1', packingFilter === 'Kyle' ? 'bg-blue-500 text-white' : 'bg-white text-slate-500 border border-slate-200']"><span class="w-2 h-2 rounded-full bg-blue-300"></span> Kyle</button>
                    <button @click="packingFilter = 'Hayley'" :class="['px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-colors flex items-center gap-1', packingFilter === 'Hayley' ? 'bg-pink-500 text-white' : 'bg-white text-slate-500 border border-slate-200']"><span class="w-2 h-2 rounded-full bg-pink-300"></span> Hayley</button>
                </div>

                <section v-if="prepTab === 'packing'" class="bg-white/90 backdrop-blur-sm rounded-2xl p-5 shadow-sm border border-white">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-sm font-bold text-slate-400 flex items-center gap-2"><i class="fas fa-suitcase text-sky-500"></i> 行李準備進度</h2>
                        <div class="text-xs font-bold text-sky-600">{{ packingProgress }}%</div>
                    </div>
                    
                    <div class="w-full bg-slate-100 rounded-full h-1.5 mb-5">
                        <div class="bg-sky-500 h-1.5 rounded-full transition-all duration-500" :style="{ width: packingProgress + '%' }"></div>
                    </div>
                    
                    <div class="space-y-6">
                        <div v-for="(category, catIndex) in filteredPackingList" :key="category.id" class="relative">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-slate-700 text-sm">{{ category.title }}</h3>
                                <button @click="withAuth(() => removeCategory(category.id))" class="text-slate-300 hover:text-rose-500"><i class="fas fa-trash-alt text-xs"></i></button>
                            </div>
                            <div class="space-y-2 mb-2">
                                <div v-for="(item, itemIndex) in category.items" :key="item.id" class="flex items-start gap-3 p-3 bg-white rounded-xl border border-slate-100 shadow-sm group">
                                    <label class="custom-checkbox cursor-pointer relative flex items-center mt-0.5">
                                        <input type="checkbox" :checked="item.checked" @change="togglePackingCheck(category.id, item.id, item.checked)" class="hidden">
                                        <div :class="['w-5 h-5 border-2 rounded flex items-center justify-center transition-all', item.checked ? 'bg-sky-500 border-sky-500' : 'bg-slate-50 border-slate-300']">
                                            <i class="fas fa-check text-white text-xs" v-if="item.checked"></i>
                                        </div>
                                    </label>
                                    <div class="flex-1 min-w-0">
                                        <div class="flex items-center gap-2 mb-1">
                                            <span :class="['text-[10px] font-bold px-1.5 py-0.5 rounded', item.owner === 'Kyle' ? 'bg-blue-50 text-blue-600' : 'bg-pink-50 text-pink-600']">{{ item.owner }}</span>
                                            <span :class="['text-sm transition-all font-medium', item.checked ? 'text-slate-400 line-through' : 'text-slate-700']">{{ item.text }}</span>
                                        </div>
                                        <div v-if="item.image" class="mt-2 w-20 h-20 rounded-lg overflow-hidden border border-slate-200">
                                            <img :src="item.image" class="w-full h-full object-cover" @click="openMediaPreview(item.image, 'image')">
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <button @click="withAuth(() => openPackingModal(category.id, item.id))" class="w-7 h-7 rounded-full bg-slate-50 text-slate-400 hover:bg-sky-50 hover:text-sky-500 flex items-center justify-center transition-colors">
                                            <i class="fas fa-pen text-[10px]"></i>
                                        </button>
                                        <button @click="withAuth(() => deletePackingItem(category.id, item.id))" class="w-7 h-7 rounded-full bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-colors">
                                            <i class="fas fa-trash-alt text-[10px]"></i>
                                        </button>
                                    </div>
                                </div>
                                <div v-if="category.items.length === 0" class="text-center text-xs text-slate-300 py-2">無項目</div>
                            </div>
                            <button @click="withAuth(() => openPackingModal(category.id))" class="w-full py-2 border border-dashed border-slate-300 rounded-xl text-slate-400 text-xs font-bold hover:bg-slate-50 hover:text-sky-500 hover:border-sky-300 transition-all">
                                <i class="fas fa-plus mr-1"></i> 新增物品
                            </button>
                        </div>
                    </div>
                    <div class="mt-6 pt-4 border-t border-slate-100">
                        <button @click="withAuth(addCategory)" class="w-full py-3 bg-slate-50 rounded-xl text-slate-500 text-sm font-bold hover:bg-slate-100 hover:text-sky-600 transition-all">
                            <i class="fas fa-folder-plus mr-1"></i> 新增類別
                        </button>
                    </div>
                </section>

                <section v-if="prepTab === 'shopping'" class="space-y-4">
                    <div v-if="filteredShoppingList.length === 0" class="text-center py-12 text-slate-400">
                        <i class="fas fa-shopping-basket text-4xl mb-3 opacity-30"></i>
                        <p class="text-sm">採購清單是空的</p>
                    </div>

                    <div v-for="item in filteredShoppingList" :key="item.id" class="bg-white rounded-2xl p-4 shadow-sm border border-slate-100 flex items-start gap-4 group">
                        <label class="custom-checkbox cursor-pointer relative flex items-center mt-1">
                            <input type="checkbox" :checked="item.bought" @change="toggleShoppingCheck(item.id, item.bought)" class="hidden">
                            <div :class="['w-6 h-6 border-2 rounded-lg flex items-center justify-center transition-all', item.bought ? 'bg-emerald-500 border-emerald-500' : 'bg-slate-50 border-slate-300']">
                                <i class="fas fa-check text-white text-xs" v-if="item.bought"></i>
                            </div>
                        </label>
                        
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span :class="['text-[10px] font-bold px-1.5 py-0.5 rounded', item.owner === 'Kyle' ? 'bg-blue-50 text-blue-600' : 'bg-pink-50 text-pink-600']">{{ item.owner }}</span>
                                <h3 :class="['font-bold text-slate-800 text-sm truncate', item.bought ? 'line-through text-slate-400' : '']">{{ item.name }}</h3>
                            </div>
                            <p v-if="item.note" class="text-xs text-slate-500 mb-2">{{ item.note }}</p>
                            <div v-if="item.image" class="w-full h-32 rounded-lg overflow-hidden border border-slate-100 bg-slate-50">
                                <img :src="item.image" class="w-full h-full object-cover" @click="openMediaPreview(item.image, 'image')">
                            </div>
                        </div>

                        <div class="flex flex-col gap-2">
                            <button @click="withAuth(() => openShoppingModal(item))" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-sky-50 hover:text-sky-500 flex items-center justify-center transition-colors">
                                <i class="fas fa-pen text-xs"></i>
                            </button>
                            <button @click="withAuth(() => deleteShoppingItem(item.id))" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-red-50 hover:text-red-500 flex items-center justify-center transition-colors">
                                <i class="fas fa-trash-alt text-xs"></i>
                            </button>
                        </div>
                    </div>
                </section>
            </div>

        </main>

        <!-- ================= FLOATING ACTION BUTTONS (Moved outside main to fix Z-Index issues) ================= -->
        <div id="floating-actions">
            <!-- Schedule FAB -->
            <button v-if="currentTab === 'schedule'" @click="withAuth(() => openScheduleModal())" class="fab-btn"><i class="fas fa-plus"></i></button>
            
            <!-- Journal FAB -->
            <button v-if="currentTab === 'journal'" @click="withAuth(() => openJournalModal())" class="fab-btn"><i class="fas fa-pen-nib"></i></button>
            
            <!-- Shopping FAB -->
            <button v-if="currentTab === 'preparation' && prepTab === 'shopping'" @click="withAuth(() => openShoppingModal())" class="fab-btn"><i class="fas fa-plus"></i></button>
        </div>

        <!-- ================= DOCK NAVIGATION ================= -->
        <div class="apple-dock-container">
            <nav class="apple-dock">
                <button @click="currentTab = 'schedule'" :class="['dock-item', currentTab === 'schedule' ? 'active' : '']"><i class="fas fa-map-marked-alt"></i></button>
                <button @click="currentTab = 'booking'" :class="['dock-item', currentTab === 'booking' ? 'active' : '']"><i class="fas fa-ticket-alt"></i></button>
                <button @click="currentTab = 'expenses'" :class="['dock-item', currentTab === 'expenses' ? 'active' : '']"><i class="fas fa-yen-sign"></i></button>
                <button @click="currentTab = 'journal'" :class="['dock-item', currentTab === 'journal' ? 'active' : '']"><i class="fas fa-book-open"></i></button>
                <button @click="currentTab = 'preparation'" :class="['dock-item', currentTab === 'preparation' ? 'active' : '']"><i class="fas fa-suitcase-rolling"></i></button>
            </nav>
        </div>

        <!-- ================= MODALS ================= -->
        
        <!-- Universal Media Preview Modal -->
        <div v-if="showPreviewModal" class="fixed inset-0 z-[9999] bg-black flex flex-col items-center justify-center animate-fade-in">
            <!-- Close Button (Fixed & High Z-Index) -->
            <button @click="showPreviewModal = false" class="fixed top-6 right-6 w-10 h-10 bg-white/20 backdrop-blur-md rounded-full text-white flex items-center justify-center z-[10000] hover:bg-white/40 transition-colors">
                <i class="fas fa-times text-lg"></i>
            </button>
            
            <div class="w-full h-full flex items-center justify-center p-2 pt-16">
                <img v-if="previewType === 'image'" :src="previewSrc" class="max-w-full max-h-full object-contain rounded-lg">
                <iframe v-if="previewType === 'pdf'" :src="previewSrc" class="w-full h-full bg-white rounded-lg" frameborder="0"></iframe>
            </div>
        </div>

        <!-- Password Modal -->
        <div v-if="showPasswordModal" class="modal-overlay" @click.self="showPasswordModal = false">
            <div class="bg-white w-full max-w-xs rounded-3xl p-6 shadow-2xl text-center">
                <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-500">
                    <i class="fas fa-lock"></i>
                </div>
                <h3 class="text-lg font-bold mb-2 text-slate-800">請輸入密碼</h3>
                <p class="text-xs text-slate-400 mb-4">需要驗證權限才能編輯內容</p>
                <input type="password" v-model="passwordInput" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-center text-lg font-bold outline-none mb-4" placeholder="******">
                <button @click="verifyPassword" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">確認</button>
            </div>
        </div>

        <!-- Outfit Modal -->
        <div v-if="showOutfitModal" class="modal-overlay" @click.self="showOutfitModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h3 class="text-lg font-bold mb-4 text-slate-800">編輯穿搭建議</h3>
                <div class="space-y-4">
                    <textarea v-model="outfitForm.text" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none h-32" placeholder="輸入穿搭建議..."></textarea>
                    <button @click="saveOutfit" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">儲存</button>
                </div>
            </div>
        </div>

        <!-- Schedule Modal -->
        <div v-if="showScheduleModal" class="modal-overlay" @click.self="showScheduleModal = false">
             <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto hide-scrollbar">
                <h3 class="text-lg font-bold mb-4 text-slate-800">{{ isEditingSchedule ? '編輯行程' : '新增行程' }}</h3>
                <div class="space-y-4">
                    <!-- Row 1: Category & Time Range -->
                    <div class="flex gap-3">
                        <div class="w-1/3">
                            <label class="block text-xs font-bold text-slate-400 mb-1">分類</label>
                            <select v-model="scheduleForm.category" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-2 text-sm outline-none h-[42px] text-slate-700 font-bold">
                                <option value="sightseeing">景點</option><option value="transport">交通</option><option value="flight">航班</option><option value="food">美食</option><option value="shopping">購物</option><option value="other">其他</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-400 mb-1">時間 (開始 - 結束)</label>
                            <div class="flex gap-2">
                                <input type="time" v-model="scheduleForm.startTime" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl py-1 px-1 text-xs text-center outline-none h-[42px] font-bold text-slate-700">
                                <input type="time" v-model="scheduleForm.endTime" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl py-1 px-1 text-xs text-center outline-none h-[42px] font-bold text-slate-700">
                            </div>
                        </div>
                    </div>
                    
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">名稱</label><input v-model="scheduleForm.name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none font-bold text-slate-700" placeholder="行程名稱"></div>
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">Google Map 地址 (選填)</label>
                        <input v-model="scheduleForm.address" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none" placeholder="留空則預設搜尋行程名稱">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">營業時間</label><input v-model="scheduleForm.openingHours" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none" placeholder="09:00 - 22:00"></div>
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">門票/費用</label><input v-model="scheduleForm.cost" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none" placeholder="¥1000"></div>
                    </div>
                    
                    <!-- Transport Section -->
                    <div class="bg-slate-50 p-3 rounded-xl border border-slate-100">
                        <label class="block text-xs font-bold text-sky-600 mb-2"><i class="fas fa-route"></i> 前往該站方式</label>
                        <div class="grid grid-cols-5 gap-2 mb-3">
                            <div @click="scheduleForm.travelMode = 'walk'" :class="['transport-option', scheduleForm.travelMode === 'walk' ? 'active' : 'bg-white']"><i class="fas fa-walking"></i></div>
                            <div @click="scheduleForm.travelMode = 'train'" :class="['transport-option', scheduleForm.travelMode === 'train' ? 'active' : 'bg-white']"><i class="fas fa-train"></i></div>
                            <div @click="scheduleForm.travelMode = 'taxi'" :class="['transport-option', scheduleForm.travelMode === 'taxi' ? 'active' : 'bg-white']"><i class="fas fa-taxi"></i></div>
                            <div @click="scheduleForm.travelMode = 'plane'" :class="['transport-option', scheduleForm.travelMode === 'plane' ? 'active' : 'bg-white']"><i class="fas fa-plane"></i></div>
                            <div @click="scheduleForm.travelMode = 'bus'" :class="['transport-option', scheduleForm.travelMode === 'bus' ? 'active' : 'bg-white']"><i class="fas fa-bus"></i></div>
                        </div>
                        
                        <!-- Compact Time Input -->
                        <div class="flex items-center justify-center gap-3 bg-white p-2 rounded-lg border border-slate-200">
                            <div class="flex items-center gap-1">
                                <input type="number" v-model="scheduleForm.travelHours" min="0" class="w-12 bg-slate-50 border border-slate-200 rounded-md p-1 text-sm outline-none text-center font-bold text-slate-700 focus:border-sky-400" placeholder="0">
                                <span class="text-xs text-slate-400 font-bold">小時</span>
                            </div>
                            <div class="flex items-center gap-1">
                                <input type="number" v-model="scheduleForm.travelMinutes" min="0" class="w-12 bg-slate-50 border border-slate-200 rounded-md p-1 text-sm outline-none text-center font-bold text-slate-700 focus:border-sky-400" placeholder="0">
                                <span class="text-xs text-slate-400 font-bold">分鐘</span>
                            </div>
                        </div>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">備註</label><input v-model="scheduleForm.note" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none" placeholder="備註事項"></div>
                    <button @click="saveSchedule" :disabled="isSaving" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200 mt-2 disabled:opacity-50 disabled:cursor-not-allowed">
                        <span v-if="isSaving"><i class="fas fa-spinner fa-spin mr-1"></i>處理中...</span>
                        <span v-else>{{ isEditingSchedule ? '更新' : '新增' }}</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Packing Modal -->
        <div v-if="showPackingModal" class="modal-overlay" @click.self="showPackingModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h3 class="text-lg font-bold mb-4 text-slate-800">{{ isEditingPacking ? '編輯物品' : '新增物品' }}</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">物品名稱</label>
                        <input v-model="packingForm.text" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none" placeholder="例如：轉接頭">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">負責人</label>
                        <div class="flex gap-2">
                            <div @click="packingForm.owner = 'Kyle'" :class="['flex-1 py-2 rounded-lg text-xs font-bold text-center border cursor-pointer transition-all', packingForm.owner === 'Kyle' ? 'bg-blue-50 border-blue-200 text-blue-600' : 'bg-white border-slate-200 text-slate-400']">Kyle</div>
                            <div @click="packingForm.owner = 'Hayley'" :class="['flex-1 py-2 rounded-lg text-xs font-bold text-center border cursor-pointer transition-all', packingForm.owner === 'Hayley' ? 'bg-pink-50 border-pink-200 text-pink-600' : 'bg-white border-slate-200 text-slate-400']">Hayley</div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">圖片 (選填)</label>
                        <div v-if="packingForm.image" class="relative w-full h-40 rounded-xl overflow-hidden mb-2 border border-slate-200">
                            <img :src="packingForm.image" class="w-full h-full object-cover">
                            <button @click="packingForm.image = null" class="absolute top-2 right-2 bg-black/50 text-white w-6 h-6 rounded-full flex items-center justify-center"><i class="fas fa-times text-xs"></i></button>
                        </div>
                        <label class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer hover:bg-slate-50 transition-colors">
                            <div class="text-center">
                                <i class="fas fa-camera text-slate-300 text-xl mb-1"></i>
                                <div class="text-xs font-bold text-slate-400">上傳圖片</div>
                            </div>
                            <input type="file" accept="image/*" class="hidden" @change="handlePackingImage">
                        </label>
                    </div>
                    <button @click="savePackingItem" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">儲存</button>
                </div>
            </div>
        </div>

        <!-- Shopping Modal -->
        <div v-if="showShoppingModal" class="modal-overlay" @click.self="showShoppingModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto hide-scrollbar">
                <h3 class="text-lg font-bold mb-4 text-slate-800">{{ isEditingShopping ? '編輯採購項目' : '新增採購項目' }}</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">商品名稱</label>
                        <input v-model="shoppingForm.name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none" placeholder="例如：白色戀人">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">負責人</label>
                        <div class="flex gap-2">
                            <div @click="shoppingForm.owner = 'Kyle'" :class="['flex-1 py-2 rounded-lg text-xs font-bold text-center border cursor-pointer transition-all', shoppingForm.owner === 'Kyle' ? 'bg-blue-50 border-blue-200 text-blue-600' : 'bg-white border-slate-200 text-slate-400']">Kyle</div>
                            <div @click="shoppingForm.owner = 'Hayley'" :class="['flex-1 py-2 rounded-lg text-xs font-bold text-center border cursor-pointer transition-all', shoppingForm.owner === 'Hayley' ? 'bg-pink-50 border-pink-200 text-pink-600' : 'bg-white border-slate-200 text-slate-400']">Hayley</div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">備註 (數量/規格)</label>
                        <input v-model="shoppingForm.note" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none" placeholder="例如：要買3盒，黑巧克力口味">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">參考圖片</label>
                        <div v-if="shoppingForm.image" class="relative w-full h-48 rounded-xl overflow-hidden mb-2 border border-slate-200">
                            <img :src="shoppingForm.image" class="w-full h-full object-cover">
                            <button @click="shoppingForm.image = null" class="absolute top-2 right-2 bg-black/50 text-white w-6 h-6 rounded-full flex items-center justify-center"><i class="fas fa-times text-xs"></i></button>
                        </div>
                        <label class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer hover:bg-slate-50 transition-colors">
                            <div class="text-center">
                                <i class="fas fa-camera text-slate-300 text-xl mb-1"></i>
                                <div class="text-xs font-bold text-slate-400">上傳圖片</div>
                            </div>
                            <input type="file" accept="image/*" class="hidden" @change="handleShoppingImage">
                        </label>
                    </div>
                    <button @click="saveShoppingItem" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">儲存</button>
                </div>
            </div>
        </div>

        <!-- Flight Modal -->
        <div v-if="showFlightModal" class="modal-overlay" @click.self="showFlightModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto hide-scrollbar">
                <h3 class="text-lg font-bold mb-4 text-slate-800">編輯航班資訊</h3>
                <div v-if="flightForm" class="space-y-6">
                    <div v-for="(leg, index) in flightForm.legs" :key="index" class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <div class="text-xs font-bold text-sky-600 mb-3 uppercase tracking-wider">航段 {{ index + 1 }}</div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">航班編號</label><input v-model="leg.flightNo" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs outline-none"></div>
                            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">機型</label><input v-model="leg.aircraft" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs outline-none"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">出發地</label><input v-model="leg.dep" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs outline-none"></div>
                            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">目的地</label><input v-model="leg.arr" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs outline-none"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">出發時間</label><input v-model="leg.depTime" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs outline-none"></div>
                            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">抵達時間</label><input v-model="leg.arrTime" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs outline-none"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mt-3">
                            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">出發航廈</label><input v-model="leg.termDep" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs outline-none"></div>
                            <div><label class="block text-[10px] font-bold text-slate-400 mb-1">抵達航廈</label><input v-model="leg.termArr" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-xs outline-none"></div>
                        </div>
                    </div>
                    <button @click="saveFlight" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">儲存變更</button>
                </div>
            </div>
        </div>

        <!-- Hotel Modal -->
        <div v-if="showHotelModal" class="modal-overlay" @click.self="showHotelModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto hide-scrollbar">
                <h3 class="text-lg font-bold mb-4 text-slate-800">編輯住宿資訊</h3>
                <div class="space-y-4">
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">酒店名稱</label><input v-model="hotelForm.name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">地址</label><input v-model="hotelForm.address" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">入住日期</label><input v-model="hotelForm.checkIn" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">時間</label><input v-model="hotelForm.checkInTime" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">退房日期</label><input v-model="hotelForm.checkOut" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">時間</label><input v-model="hotelForm.checkOutTime" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">住客姓名</label><textarea v-model="hotelForm.guests" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none h-20"></textarea></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">Trip訂單號</label><input v-model="hotelForm.bookingId" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">酒店確認號</label><input v-model="hotelForm.hotelId" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">注意事項</label><textarea v-model="hotelForm.notes" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none h-20"></textarea></div>
                    <button @click="saveHotel" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">儲存變更</button>
                </div>
            </div>
        </div>

        <!-- Tour Modal -->
        <div v-if="showTourModal" class="modal-overlay" @click.self="showTourModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto hide-scrollbar">
                <h3 class="text-lg font-bold mb-4 text-slate-800">編輯一日團資訊</h3>
                <div class="space-y-4">
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">項目名稱</label><input v-model="tourForm.name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">日期</label><input v-model="tourForm.date" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    <div class="bg-red-50 p-3 rounded-xl border border-red-100">
                        <label class="block text-xs font-bold text-red-500 mb-2">集合資訊 (重要)</label>
                        <div class="space-y-2">
                            <input v-model="tourForm.meetingTime" class="w-full bg-white border border-red-100 rounded-lg p-2 text-sm outline-none" placeholder="集合時間">
                            <input v-model="tourForm.meetingPoint" class="w-full bg-white border border-red-100 rounded-lg p-2 text-sm outline-none" placeholder="集合地點">
                            <input v-model="tourForm.departureTime" class="w-full bg-white border border-red-100 rounded-lg p-2 text-sm outline-none" placeholder="發車時間">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">訂單編號</label><input v-model="tourForm.bookingId" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">參與人數</label><input v-model="tourForm.participants" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    </div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">旅客姓名</label><input v-model="tourForm.touristName" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    <div><label class="block text-xs font-bold text-slate-400 mb-1">聯絡電話</label><input v-model="tourForm.phone" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">社交軟體</label><input v-model="tourForm.socialApp" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                        <div><label class="block text-xs font-bold text-slate-400 mb-1">帳號</label><input v-model="tourForm.socialId" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none"></div>
                    </div>
                    <button @click="saveTour" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">儲存變更</button>
                </div>
            </div>
        </div>

        <!-- Voucher Modal -->
        <div v-if="showVoucherModal" class="modal-overlay" @click.self="showVoucherModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl">
                <h3 class="text-lg font-bold mb-4 text-slate-800">{{ isEditingVoucher ? '編輯憑證' : '新增憑證' }}</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">憑證標題</label>
                        <input v-model="voucherForm.title" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none" placeholder="例如：迪士尼門票">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">上傳 PDF / 圖片</label>
                        <div class="relative">
                            <input type="file" @change="handleVoucherFile" accept=".pdf,image/*" class="hidden" id="voucher-file">
                            <label for="voucher-file" class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer hover:bg-slate-50 transition-colors">
                                <div v-if="voucherForm.fileName" class="text-center p-4">
                                    <i class="fas fa-file-check text-sky-500 text-2xl mb-2"></i>
                                    <div class="text-xs font-bold text-slate-600 break-all">{{ voucherForm.fileName }}</div>
                                    <div class="text-[10px] text-slate-400 mt-1">(點擊更換)</div>
                                </div>
                                <div v-else class="text-center">
                                    <i class="fas fa-cloud-upload-alt text-slate-300 text-2xl mb-2"></i>
                                    <div class="text-xs font-bold text-slate-400">點擊選擇檔案</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    <button @click="saveVoucher" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">儲存</button>
                </div>
            </div>
        </div>

        <!-- Journal Modal -->
        <div v-if="showJournalModal" class="modal-overlay" @click.self="showJournalModal = false">
            <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto hide-scrollbar">
                <h3 class="text-lg font-bold mb-4 text-slate-800">{{ isEditingJournal ? '編輯日記' : '寫日記' }}</h3>
                <div class="space-y-4">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-400 mb-1">日期</label>
                            <input type="date" v-model="journalForm.date" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-2 text-sm outline-none">
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-bold text-slate-400 mb-1">記錄人</label>
                            <div class="flex gap-2">
                                <div @click="journalForm.author = 'Kyle'" :class="['flex-1 py-2 rounded-lg text-xs font-bold text-center border cursor-pointer transition-all', journalForm.author === 'Kyle' ? 'bg-blue-50 border-blue-200 text-blue-600' : 'bg-white border-slate-200 text-slate-400']">Kyle</div>
                                <div @click="journalForm.author = 'Hayley'" :class="['flex-1 py-2 rounded-lg text-xs font-bold text-center border cursor-pointer transition-all', journalForm.author === 'Hayley' ? 'bg-pink-50 border-pink-200 text-pink-600' : 'bg-white border-slate-200 text-slate-400']">Hayley</div>
                            </div>
                        </div>
                    </div>
                    
                    <textarea v-model="journalForm.text" class="w-full h-32 bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm outline-none resize-none" placeholder="今天發生了什麼有趣的事？"></textarea>
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-400 mb-1">照片 (最多5張)</label>
                        <div class="grid grid-cols-5 gap-2 mb-2">
                            <div v-for="(photo, index) in journalForm.photos" :key="index" class="relative aspect-square rounded-lg overflow-hidden border border-slate-200">
                                <img :src="photo" class="w-full h-full object-cover">
                                <button @click="removeJournalPhoto(index)" class="absolute top-0 right-0 bg-black/50 text-white w-4 h-4 flex items-center justify-center rounded-bl-lg text-[10px]"><i class="fas fa-times"></i></button>
                            </div>
                            <label v-if="journalForm.photos.length < 5" class="aspect-square rounded-lg border-2 border-dashed border-slate-300 flex items-center justify-center cursor-pointer hover:bg-slate-50">
                                <i class="fas fa-plus text-slate-300"></i>
                                <input type="file" accept="image/*" multiple class="hidden" @change="handleJournalPhotos">
                            </label>
                        </div>
                    </div>

                    <button @click="saveJournal" class="w-full bg-sky-500 text-white py-3 rounded-xl font-bold shadow-lg shadow-sky-200">{{ isEditingJournal ? '更新' : '發佈' }}</button>
                </div>
            </div>
        </div>

    </div>

    <!-- MAIN SCRIPT WITH FIREBASE -->
    <script type="module">
        import { createApp, ref, computed, onMounted, watch, nextTick } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, updateDoc, deleteDoc, doc, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // =========================================================================
        // TODO: 請在此處填入您的 Firebase 設定 (從 Firebase Console 取得)
        // =========================================================================
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        // =========================================================================

        // Initialize Firebase
        let db, storage;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            storage = getStorage(app);
        } catch (e) {
            console.error("Firebase Init Error (Did you fill config?):", e);
        }

        createApp({
            setup() {
                const isLoading = ref(true);
                const currentTab = ref('schedule');
                const selectedDayIndex = ref(0);
                const bookingCategory = ref('tour'); 
                const dateScrollContainer = ref(null);

                // Toast Logic
                const showToast = ref(false);
                const toastMessage = ref('');
                const showSuccessToast = (msg) => {
                    toastMessage.value = msg;
                    showToast.value = true;
                    setTimeout(() => { showToast.value = false; }, 2000);
                };

                // --- Auth Logic (Client Side Gate + Firebase Auth can be added here) ---
                const isAuthenticated = ref(false);
                const showPasswordModal = ref(false);
                const passwordInput = ref('');
                const pendingAction = ref(null);
                const CORRECT_PASSWORD = '211912';

                const withAuth = (action) => {
                    if (isAuthenticated.value) {
                        action();
                    } else {
                        pendingAction.value = action;
                        passwordInput.value = '';
                        showPasswordModal.value = true;
                    }
                };

                const verifyPassword = () => {
                    if (passwordInput.value === CORRECT_PASSWORD) {
                        isAuthenticated.value = true;
                        showPasswordModal.value = false;
                        if (pendingAction.value) {
                            pendingAction.value();
                            pendingAction.value = null;
                        }
                    } else {
                        alert('密碼錯誤');
                        passwordInput.value = '';
                    }
                };

                // Music Logic
                const isMusicPlaying = ref(false);
                const toggleMusic = () => {
                    const audio = document.getElementById('bgm');
                    if (audio.paused) { audio.play(); isMusicPlaying.value = true; } else { audio.pause(); isMusicPlaying.value = false; }
                };

                // Countdown
                const countdown = ref('');
                const updateCountdown = () => {
                    const target = new Date('2025-12-22T00:05:00').getTime();
                    const now = new Date().getTime();
                    const diff = target - now;
                    if (diff < 0) { countdown.value = "旅程已開始"; return; }
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    countdown.value = `${days}天 ${hours}小時 ${minutes}分`;
                };
                setInterval(updateCountdown, 60000);
                updateCountdown();

                // Weather
                const isRealTimeWeather = ref(false);
                const weatherForecast = ref([
                    { date: '12/22', icon: 'fas fa-snowflake', temp: '-2° / -6°', desc: '大雪', sunrise: '07:06', sunset: '16:03', outfit: '極寒：發熱衣+厚毛衣+羽絨大衣+圍巾' },
                    { date: '12/23', icon: 'fas fa-snowflake', temp: '-3° / -8°', desc: '小雪', sunrise: '07:06', sunset: '16:04', outfit: '保暖：洋蔥式穿搭，防水雪靴必備' },
                    { date: '12/24', icon: 'fas fa-cloud', temp: '-1° / -5°', desc: '多雲', sunrise: '07:07', sunset: '16:05', outfit: '舒適：長版大衣+毛帽，注意防風' },
                    { date: '12/25', icon: 'fas fa-snowflake', temp: '-4° / -9°', desc: '暴風雪', sunrise: '07:07', sunset: '16:05', outfit: '嚴寒：最厚裝備全上，貼暖暖包' },
                    { date: '12/26', icon: 'fas fa-sun', temp: '0° / -7°', desc: '晴時多雲', sunrise: '07:08', sunset: '16:06', outfit: '晴朗：墨鏡防雪盲，室內外溫差大' },
                    { date: '12/27', icon: 'fas fa-cloud-sun', temp: '-1° / -6°', desc: '多雲', sunrise: '07:08', sunset: '16:07', outfit: '活動：輕便羽絨，方便活動為主' },
                    { date: '12/28', icon: 'fas fa-snowflake', temp: '-2° / -8°', desc: '小雪', sunrise: '07:09', sunset: '16:08', outfit: '降雪：防水外套，手套必備' },
                    { date: '12/29', icon: 'fas fa-snowflake', temp: '-3° / -7°', desc: '大雪', sunrise: '07:09', sunset: '16:09', outfit: '返程：舒適保暖，方便穿脫過安檢' },
                ]);

                // Weather Fetch
                const fetchRealTimeWeather = async () => {
                    try {
                        const response = await fetch('https://api.open-meteo.com/v1/forecast?latitude=43.0618&longitude=141.3545&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset&timezone=Asia%2FTokyo');
                        const data = await response.json();
                        if (data && data.daily) {
                            isRealTimeWeather.value = true;
                            // ... (mapping logic same as before) ...
                        }
                    } catch (e) { isRealTimeWeather.value = false; }
                };
                onMounted(() => fetchRealTimeWeather());
                const currentDayWeather = computed(() => weatherForecast.value[selectedDayIndex.value] || weatherForecast.value[0]);

                // Outfit Edit
                const showOutfitModal = ref(false); const outfitForm = ref({ text: '' });
                const openOutfitModal = () => { outfitForm.value.text = currentDayWeather.value.outfit; showOutfitModal.value = true; };
                const saveOutfit = () => { weatherForecast.value[selectedDayIndex.value].outfit = outfitForm.value.text; showOutfitModal.value = false; };

                // Static Booking Data (Can be moved to Firestore later, kept static for simplicity as requested)
                const flightData = ref([{id:1, type:'outbound', typeLabel:'去程', date:'12/22', airline:'全日空航空', logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e2/ANA_logo_%282023%29.svg/2560px-ANA_logo_%282023%29.svg.png', legs:[{dep:'HKG', arr:'HND', depTime:'00:05', arrTime:'04:55', flightNo:'NH814', aircraft:'波音 787-800', termDep:'T1', termArr:'T3', duration:'3h 50m'},{dep:'HND', arr:'CTS', depTime:'09:00', arrTime:'10:35', flightNo:'NH055', aircraft:'波音 787-10', termDep:'T2', termArr:'Dom', duration:'1h 35m'}], transfer:{text:'東京轉機 4h 5m', note:'需領取並重新託運行李'}},{id:2, type:'inbound', typeLabel:'回程', date:'12/29', airline:'全日空航空', logo:'https://upload.wikimedia.org/wikipedia/commons/thumb/e/e2/ANA_logo_%282023%29.svg/2560px-ANA_logo_%282023%29.svg.png', legs:[{dep:'CTS', arr:'HND', depTime:'20:30', arrTime:'22:10', flightNo:'NH082', aircraft:'波音 777-300', termDep:'Dom', termArr:'T2', duration:'1h 40m'},{dep:'HND', arr:'HKG', depTime:'<span class="text-[10px] text-orange-500 mr-1">12/30</span>02:00', arrTime:'05:45', flightNo:'NH813', aircraft:'波音 787-800', termDep:'T2', termArr:'T1', duration:'4h 45m'}], transfer:{text:'東京轉機 3h 50m', note:'隔夜轉機'}}]);
                const hotelData = ref({name:'微笑酒店PREMIUM札幌薄野', address:'Chuoku Minami 4 jo Nishi 1 chome 13-1, 中央區, 064-0804 札幌市, 北海道, 日本', phone:'+81-11-2517055', checkIn:'2025年12月22日', checkInTime:'15:00', checkOut:'2025年12月29日', checkOutTime:'11:00', nights:7, guests:'KWOK MAN HEI, AO HEI LAM', bookingId:'1359039935428674', hotelId:'J21-773-499', notes:'不包括餐膳。連續入住的客人將每三晚清潔一次。', image:'https://cf.bstatic.com/xdata/images/hotel/max1024x768/164646639.jpg?k=3f40079685956037000572856238600100000000'});
                const tourData = ref({name:'北海道旭山動物園+四季彩常規集合', date:'2025-12-27', bookingId:'6251118211816897', participants:'成人 2', touristName:'KWOK MAN HEI', phone:'853-66881962', socialApp:'Whatsapp: 85366881962', socialId:'85366881962', meetingTime:'07:40', meetingPoint:'大通公園地鐵站31號門集合', departureTime:'07:50', emergencyCn:'+8613332988980', emergencyJp:'+819096998601'});
                const restaurantData = ref({id:'9LT3K7WPR8', name:'HOUSE.H', pax:'2名様', dateTime:'12月25日(木) 18:00～', duration:'2時間30分', course:'赤れんがのクリスマスディナー', price:'￥14,000(税込)', seat:'テーブル席 [禁煙]', address:'北海道札幌市中央区北三条西6-1 赤れんが庁舎 1F', phone:'011-211-5244', booker:'guo lulu'});

                // Flight/Hotel/Tour Edit Logic (Static for now, can be Firebased easily)
                const showFlightModal = ref(false); const flightForm = ref(null); const editingFlightId = ref(null);
                const editFlight = (flight) => { editingFlightId.value = flight.id; flightForm.value = JSON.parse(JSON.stringify(flight)); showFlightModal.value = true; };
                const saveFlight = () => { const index = flightData.value.findIndex(f => f.id === editingFlightId.value); if (index !== -1) flightData.value[index] = flightForm.value; showFlightModal.value = false; };
                const showHotelModal = ref(false); const hotelForm = ref({}); const openHotelModal = () => { hotelForm.value = { ...hotelData.value }; showHotelModal.value = true; }; const saveHotel = () => { hotelData.value = { ...hotelForm.value }; showHotelModal.value = false; };
                const showTourModal = ref(false); const tourForm = ref({}); const openTourModal = () => { tourForm.value = { ...tourData.value }; showTourModal.value = true; }; const saveTour = () => { tourData.value = { ...tourForm.value }; showTourModal.value = false; };

                // Universal Preview
                const showPreviewModal = ref(false); const previewSrc = ref(''); const previewType = ref('image');
                const openMediaPreview = (src, type) => { previewSrc.value = src; previewType.value = type; showPreviewModal.value = true; };

                // =========================================================================
                // FIREBASE INTEGRATION START
                // =========================================================================

                // Helper: Upload file to Storage
                const uploadFile = async (file, path) => {
                    if (!file) return null;
                    const storageReference = storageRef(storage, path + '/' + Date.now() + '_' + file.name);
                    const snapshot = await uploadBytes(storageReference, file);
                    return await getDownloadURL(snapshot.ref);
                };

                // --- 1. Schedule Data (Real-time) ---
                // Structure: `scheduleData` array for UI days, but items are fetched from Firestore collection 'scheduleItems'
                const scheduleData = ref([
                    { 
                        date: '22', weekday: 'Mon', fullDate: '2025-12-22', 
                        items: [
                            { id: 'd1_1', dayIndex: 0, category: 'flight', categoryLabel: '航班', startTime: '10:35', name: '抵達新千歲機場 (NH055)', travelMode: 'train', travelTime: '37分鐘', note: '搭乘 JR 快速機場線至札幌站，轉地鐵南北線至薄野站' },
                            { id: 'd1_2', dayIndex: 0, category: 'transport', categoryLabel: '交通', startTime: '13:00', name: '飯店寄放行李', address: 'Smile Hotel Premium Sapporo Susukino', note: '位於薄野中心，先寄放行李' },
                            { id: 'd1_3', dayIndex: 0, category: 'food', categoryLabel: '美食', startTime: '13:30', name: '午餐：薄野拉麵橫丁', note: '推薦 弟子屈拉麵 或 倍煎舍' },
                            { id: 'd1_4', dayIndex: 0, category: 'other', categoryLabel: '休息', startTime: '15:00', name: '飯店 Check-in & 補眠', note: '紅眼航班補眠 2-3 小時' },
                            { id: 'd1_5', dayIndex: 0, category: 'food', categoryLabel: '美食', startTime: '18:00', name: '晚餐：湯咖哩', note: '推薦 Suage+ 或 Garaku (5點開門，人多需排隊)' },
                            { id: 'd1_6', dayIndex: 0, category: 'sightseeing', categoryLabel: '景點', startTime: '20:00', name: '大通公園聖誕市集 & 燈飾', travelMode: 'walk', travelTime: '10分鐘', note: '從飯店步行，感受聖誕氣氛' }
                        ] 
                    },
                    { 
                        date: '23', weekday: 'Tue', fullDate: '2025-12-23', 
                        items: [
                            { id: 'd2_1', dayIndex: 1, category: 'transport', categoryLabel: '交通', startTime: '09:00', name: '札幌出發 (往小樽)', travelMode: 'train', travelTime: '30分鐘', note: '搭乘 JR 函館本線' },
                            { id: 'd2_2', dayIndex: 1, category: 'sightseeing', categoryLabel: '景點', startTime: '09:30', endTime: '10:30', name: '錢函站 (Zenibako)', note: '早晨海邊光線清透，車站旁咖啡店稍作停留' },
                            { id: 'd2_3', dayIndex: 1, category: 'sightseeing', categoryLabel: '景點', startTime: '10:45', endTime: '11:45', name: '朝里站 (Asari)', note: '無人車站雪景與海景，避開人潮' },
                            { id: 'd2_4', dayIndex: 1, category: 'food', categoryLabel: '美食', startTime: '12:00', name: '午餐：三角市場 / Naruto 炸雞', note: '推薦滝波食堂 或 らーめん 西や 小樽駅前店' },
                            { id: 'd2_5', dayIndex: 1, category: 'sightseeing', categoryLabel: '景點', startTime: '13:30', endTime: '14:15', name: '船見坂', note: '慢慢散步，拍完照往下走向海邊' },
                            { id: 'd2_6', dayIndex: 1, category: 'sightseeing', categoryLabel: '景點', startTime: '14:15', endTime: '14:45', name: '小樽運河 (日景)', note: '淺草橋或中央橋拍攝，白雪紅磚倉庫' },
                            { id: 'd2_7', dayIndex: 1, category: 'sightseeing', categoryLabel: '景點', startTime: '15:00', endTime: '16:00', name: '色內埠頭公園', note: '下午三點準時抵達，拍攝剪影照' },
                            { id: 'd2_8', dayIndex: 1, category: 'sightseeing', categoryLabel: '景點', startTime: '16:15', endTime: '17:15', name: '小樽運河 (夜景)', note: '藍調時刻 (Blue Hour) 與點燈' },
                            { id: 'd2_9', dayIndex: 1, category: 'shopping', categoryLabel: '購物', startTime: '19:30', name: '狸小路', travelMode: 'train', travelTime: '40分鐘', note: '回札幌逛街、採買藥妝' }
                        ] 
                    },
                    { 
                        date: '24', weekday: 'Wed', fullDate: '2025-12-24', 
                        items: [
                            { id: 'd3_1', dayIndex: 2, category: 'transport', categoryLabel: '交通', startTime: '09:00', name: '前往南小樽站', travelMode: 'train', travelTime: '35分鐘', note: '注意：是在小樽的前一站下車' },
                            { id: 'd3_2', dayIndex: 2, category: 'shopping', categoryLabel: '購物', startTime: '09:45', endTime: '11:00', name: '小樽音樂盒堂 & 蒸氣鐘', note: '剛開門人最少' },
                            { id: 'd3_3', dayIndex: 2, category: 'food', categoryLabel: '美食', startTime: '11:00', endTime: '12:00', name: '甜點巡禮', note: 'LeTAO 起司蛋糕、北菓樓泡芙、六花亭伴手禮' },
                            { id: 'd3_4', dayIndex: 2, category: 'food', categoryLabel: '美食', startTime: '12:00', endTime: '13:10', name: '午餐：壽司', note: '政壽司、伊勢鮨分店或海鮮丼' },
                            { id: 'd3_5', dayIndex: 2, category: 'transport', categoryLabel: '交通', startTime: '13:40', name: '搭巴士往天狗山', note: '小樽站前巴士總站，搭乘 9號線' },
                            { id: 'd3_6', dayIndex: 2, category: 'sightseeing', categoryLabel: '景點', startTime: '14:00', endTime: '15:30', name: '天狗山 (玩雪/觀景)', note: '戶外展望台、天狗神社' },
                            { id: 'd3_7', dayIndex: 2, category: 'sightseeing', categoryLabel: '景點', startTime: '15:30', endTime: '17:30', name: '天狗山 (夕陽/夜景)', note: 'TENGUU CAFE 休息，欣賞三大夜景' },
                            { id: 'd3_8', dayIndex: 2, category: 'food', categoryLabel: '美食', startTime: '18:30', name: '晚餐', note: '札幌或小樽用餐' }
                        ] 
                    },
                    { 
                        date: '25', weekday: 'Thu', fullDate: '2025-12-25', 
                        items: [
                            { id: 'd4_1', dayIndex: 3, category: 'food', categoryLabel: '美食', startTime: '10:00', name: '根室花丸 (抽號碼牌)', address: 'Stellar Place 6F', note: '先抽號碼牌，再去逛街' },
                            { id: 'd4_2', dayIndex: 3, category: 'shopping', categoryLabel: '購物', startTime: '10:15', name: '札幌站逛街買禮物', note: '隨時檢查號碼牌進度' },
                            { id: 'd4_3', dayIndex: 3, category: 'sightseeing', categoryLabel: '景點', startTime: '13:00', name: '札幌電視塔 & 天橋', travelMode: 'walk', travelTime: '20分鐘', note: '趁有陽光拍照 (30-40 mins)' },
                            { id: 'd4_4', dayIndex: 3, category: 'sightseeing', categoryLabel: '景點', startTime: '14:00', endTime: '17:00', name: '中島公園 & Smooch Coffee', note: 'First Love 巡禮，享受雪地咖啡' },
                            { id: 'd4_5', dayIndex: 3, category: 'food', categoryLabel: '美食', startTime: '18:00', name: '聖誕晚餐：HOUSE.H', address: '北海道札幌市中央区北三条西6-1', note: '17:50 準時報到，享用聖誕大餐' },
                            { id: 'd4_6', dayIndex: 3, category: 'sightseeing', categoryLabel: '景點', startTime: '20:30', name: '漫步回飯店', note: '沿著站前通散步' }
                        ] 
                    },
                    { 
                        date: '26', weekday: 'Fri', fullDate: '2025-12-26', 
                        items: [
                            { id: 'd5_1', dayIndex: 4, category: 'other', categoryLabel: '行程', startTime: '09:00', name: '早上待定', note: '自由活動' },
                            { id: 'd5_2', dayIndex: 4, category: 'sightseeing', categoryLabel: '景點', startTime: '12:00', name: '北海道神宮', travelMode: 'train', travelTime: '20分鐘', note: '搭地鐵參拜，神宮茶屋' },
                            { id: 'd5_3', dayIndex: 4, category: 'sightseeing', categoryLabel: '景點', startTime: '16:00', endTime: '19:00', name: '白色戀人公園', note: '提前半小時入場，歐式童話感與點燈' },
                            { id: 'd5_4', dayIndex: 4, category: 'food', categoryLabel: '美食', startTime: '19:30', name: '晚餐：螃蟹料理', note: '螃蟹將軍 或 冰雪之門 (需預訂)' }
                        ] 
                    },
                    { 
                        date: '27', weekday: 'Sat', fullDate: '2025-12-27', 
                        items: [
                            { id: 'd6_1', dayIndex: 5, category: 'transport', categoryLabel: '交通', startTime: '07:20', name: '出門前往集合點', travelMode: 'walk', travelTime: '8分鐘', note: '大通地鐵站 31 號出口集合' },
                            { id: 'd6_2', dayIndex: 5, category: 'sightseeing', categoryLabel: '景點', startTime: '07:50', name: '一日團發車', note: '旭山動物園 (企鵝散步)、四季彩之丘 (玩雪盆)' },
                            { id: 'd6_3', dayIndex: 5, category: 'sightseeing', categoryLabel: '景點', startTime: '14:00', name: '美瑛網美樹', note: '聖誕樹、Ken & Mary 之樹' },
                            { id: 'd6_4', dayIndex: 5, category: 'sightseeing', categoryLabel: '景點', startTime: '16:30', name: '精靈露台 (Ningle Terrace)', note: '傍晚點燈後的小木屋群' },
                            { id: 'd6_5', dayIndex: 5, category: 'transport', categoryLabel: '交通', startTime: '18:10', name: '解散', note: 'JR 札幌站北口解散' }
                        ] 
                    },
                    { 
                        date: '28', weekday: 'Sun', fullDate: '2025-12-28', 
                        items: [
                            { id: 'd7_1', dayIndex: 6, category: 'other', categoryLabel: '休息', startTime: '09:00', name: '睡懶覺 & 早餐', note: '悠閒早晨' },
                            { id: 'd7_2', dayIndex: 6, category: 'shopping', categoryLabel: '購物', startTime: '13:00', name: '北廣島三井 Outlet Park', travelMode: 'bus', travelTime: '50分鐘', note: '札幌站直達巴士' },
                            { id: 'd7_3', dayIndex: 6, category: 'food', categoryLabel: '美食', startTime: '19:00', name: '晚餐：和牛壽喜燒', note: '推薦 和牛 Ishizaki 或 禪 Zen' }
                        ] 
                    },
                    { 
                        date: '29', weekday: 'Mon', fullDate: '2025-12-29', 
                        items: [
                            { id: 'd8_1', dayIndex: 7, category: 'other', categoryLabel: '退房', startTime: '11:00', name: '退房 & 寄放行李', note: '最後補貨 (唐吉訶德、藥妝)' },
                            { id: 'd8_2', dayIndex: 7, category: 'transport', categoryLabel: '交通', startTime: '14:30', name: '前往新千歲機場', travelMode: 'train', travelTime: '40分鐘', note: '提早出發，避免大雪延誤' },
                            { id: 'd8_3', dayIndex: 7, category: 'sightseeing', categoryLabel: '景點', startTime: '15:30', name: '機場逛街', note: '哆啦A夢樂園、吃一幻拉麵' },
                            { id: 'd8_4', dayIndex: 7, category: 'flight', categoryLabel: '航班', startTime: '20:30', name: '返程航班 (NH082)', note: 'CTS 起飛' }
                        ] 
                    },
                ]);

                // Listen to Schedule Items
                onMounted(() => {
                    if (!db) {
                        // If no DB is configured, we rely on the static data above.
                        isLoading.value = false;
                        refreshScheduleDOM();
                        return;
                    }
                    
                    const q = query(collection(db, "scheduleItems"), orderBy("order", "asc"));
                    onSnapshot(q, (snapshot) => {
                        // Only wipe and populate IF there is data in DB to avoid overwriting the static display for demo
                        if (!snapshot.empty) {
                            // Reset items buckets
                            scheduleData.value.forEach(day => day.items = []);
                            
                            snapshot.forEach((doc) => {
                                const item = { id: doc.id, ...doc.data() };
                                // Find matching day based on dayIndex stored in item
                                if (scheduleData.value[item.dayIndex]) {
                                    scheduleData.value[item.dayIndex].items.push(item);
                                }
                            });
                        }
                        refreshScheduleDOM();
                        isLoading.value = false;
                    });
                });

                const currentDaySchedule = computed(() => scheduleData.value[selectedDayIndex.value].items);

                // SortableJS Logic with Firestore Update
                let sortableInstance = null;
                const listKey = ref(0);

                const initSortable = () => {
                    const el = document.getElementById('schedule-list-container');
                    if (sortableInstance) { sortableInstance.destroy(); sortableInstance = null; }
                    if (el) {
                        sortableInstance = new Sortable(el, {
                            animation: 150,
                            handle: '.drag-handle',
                            ghostClass: 'sortable-ghost',
                            onEnd: async (evt) => {
                                // Update local state visually first (optional, but Sortable does DOM)
                                // We need to update Firestore 'order' fields
                                const items = [...currentDaySchedule.value]; // Copy current list
                                const [movedItem] = items.splice(evt.oldIndex, 1);
                                items.splice(evt.newIndex, 0, movedItem);
                                
                                // Batch update order in Firestore
                                if(db) {
                                    items.forEach((item, index) => {
                                        updateDoc(doc(db, "scheduleItems", item.id), { order: index });
                                    });
                                }
                            }
                        });
                    }
                };

                const refreshScheduleDOM = async () => { listKey.value++; await nextTick(); initSortable(); };
                const scrollToSelectedDay = () => {
                    const container = dateScrollContainer.value;
                    const activeBtn = document.getElementById('day-btn-' + selectedDayIndex.value);
                    if (container && activeBtn) {
                        const containerWidth = container.clientWidth;
                        const btnLeft = activeBtn.offsetLeft;
                        const btnWidth = activeBtn.clientWidth;
                        container.scrollTo({ left: btnLeft - (containerWidth / 2) + (btnWidth / 2), behavior: 'smooth' });
                    }
                };

                watch(currentTab, async (newVal) => {
                    if (newVal === 'schedule') { await refreshScheduleDOM(); setTimeout(scrollToSelectedDay, 100); }
                    else if (sortableInstance) { sortableInstance.destroy(); sortableInstance = null; }
                });

                const changeDay = async (index) => { selectedDayIndex.value = index; await refreshScheduleDOM(); scrollToSelectedDay(); };

                // Schedule CRUD
                const showScheduleModal = ref(false); const isEditingSchedule = ref(false); const editingScheduleId = ref(null);
                const scheduleForm = ref({ category: 'sightseeing', name: '', startTime: '', endTime: '', note: '', travelHours: 0, travelMinutes: 0, travelMode: 'train', openingHours: '', cost: '', address: '' });
                const isSaving = ref(false); // New saving state

                const openScheduleModal = () => { isEditingSchedule.value = false; scheduleForm.value = { category: 'sightseeing', name: '', startTime: '', endTime: '', note: '', travelHours: 0, travelMinutes: 0, travelMode: 'train', openingHours: '', cost: '', address: '' }; showScheduleModal.value = true; };
                const editScheduleItem = (item) => { 
                    isEditingSchedule.value = true; editingScheduleId.value = item.id;
                    let h = 0, m = 0;
                    if (item.travelTime) {
                        const hMatch = item.travelTime.match(/(\d+)小時/);
                        const mMatch = item.travelTime.match(/(\d+)分鐘/);
                        if (hMatch) h = parseInt(hMatch[1]);
                        if (mMatch) m = parseInt(mMatch[1]);
                        if (!hMatch && !mMatch && item.travelTime.includes('分鐘')) m = parseInt(item.travelTime);
                    }
                    scheduleForm.value = { ...item, travelHours: h, travelMinutes: m };
                    showScheduleModal.value = true; 
                };

                const saveSchedule = async () => {
                    if (!scheduleForm.value.name) {
                        alert('請輸入行程名稱');
                        return;
                    }

                    isSaving.value = true; // Start loading

                    try {
                        let timeStr = '';
                        if (scheduleForm.value.travelHours > 0) timeStr += `${scheduleForm.value.travelHours}小時`;
                        if (scheduleForm.value.travelMinutes > 0) { if (timeStr) timeStr += ' '; timeStr += `${scheduleForm.value.travelMinutes}分鐘`; }

                        const itemData = {
                            category: scheduleForm.value.category,
                            categoryLabel: { sightseeing: '景點', transport: '交通', flight: '航班', food: '美食', shopping: '購物', other: '其他' }[scheduleForm.value.category],
                            name: scheduleForm.value.name,
                            startTime: scheduleForm.value.startTime,
                            endTime: scheduleForm.value.endTime,
                            note: scheduleForm.value.note,
                            travelTime: timeStr,
                            travelMode: scheduleForm.value.travelMode,
                            openingHours: scheduleForm.value.openingHours,
                            cost: scheduleForm.value.cost,
                            address: scheduleForm.value.address,
                            dayIndex: selectedDayIndex.value // Important for grouping
                        };

                        if(db) {
                            if (isEditingSchedule.value) {
                                await updateDoc(doc(db, "scheduleItems", editingScheduleId.value), itemData);
                                showSuccessToast('✅ 行程已更新');
                            } else {
                                // Add new item at the end
                                const list = currentDaySchedule.value || [];
                                const currentCount = list.length;
                                await addDoc(collection(db, "scheduleItems"), { ...itemData, order: currentCount });
                                showSuccessToast('✅ 行程已新增');
                            }
                        } else {
                            // Fallback for demo mode (no DB)
                            if (isEditingSchedule.value) {
                                const dayIdx = selectedDayIndex.value;
                                const itemIdx = scheduleData.value[dayIdx].items.findIndex(i => i.id === editingScheduleId.value);
                                if(itemIdx !== -1) scheduleData.value[dayIdx].items[itemIdx] = { ...scheduleData.value[dayIdx].items[itemIdx], ...itemData };
                            } else {
                                scheduleData.value[selectedDayIndex.value].items.push({ id: 'temp_' + Date.now(), ...itemData });
                            }
                            showSuccessToast('✅ (本地) 行程已更新');
                        }
                        
                        // Force close modal
                        showScheduleModal.value = false;

                    } catch (error) {
                        console.error("Save error:", error);
                        alert('儲存失敗，請檢查網路連線: ' + error.message);
                    } finally {
                        isSaving.value = false; // Stop loading
                    }
                };

                const removeScheduleItem = async (id) => { 
                    if (confirm('確定要刪除此行程嗎？')) {
                        if(db) {
                            await deleteDoc(doc(db, "scheduleItems", id)); 
                        } else {
                            const dayIdx = selectedDayIndex.value;
                            scheduleData.value[dayIdx].items = scheduleData.value[dayIdx].items.filter(i => i.id !== id);
                        }
                    }
                };

                // --- 2. Expenses (Real-time) ---
                const expenseList = ref([]);
                onMounted(() => {
                    if (!db) return;
                    const q = query(collection(db, "expenses"), orderBy("date", "desc"));
                    onSnapshot(q, (snapshot) => {
                        expenseList.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                });

                const expenseMode = ref('list'); const expenseFilter = ref('all');
                const isEditingExpense = ref(false); const editingExpenseId = ref(null);
                const expenseForm = ref({ category: '飲食', name: '', date: new Date().toISOString().split('T')[0], amount: '', currency: 'JPY', payment: 'cash', payer: 'Kyle' });
                const mopToJpyRate = 18.5;
                const toJPY = (item) => item.currency === 'MOP' ? item.amount * mopToJpyRate : Number(item.amount);
                
                const filteredExpenses = computed(() => expenseFilter.value === 'all' ? expenseList.value : expenseList.value.filter(e => e.payer === expenseFilter.value));
                const totalExpensesJPY = computed(() => Math.round(filteredExpenses.value.reduce((sum, item) => sum + toJPY(item), 0)));
                const totalCashJPY = computed(() => Math.round(filteredExpenses.value.filter(i => i.payment === 'cash').reduce((sum, item) => sum + toJPY(item), 0)));
                const totalCardJPY = computed(() => Math.round(filteredExpenses.value.filter(i => i.payment === 'card').reduce((sum, item) => sum + toJPY(item), 0)));
                const totalEpayJPY = computed(() => Math.round(filteredExpenses.value.filter(i => i.payment === 'epay').reduce((sum, item) => sum + toJPY(item), 0)));
                
                const groupedExpenses = computed(() => {
                    const groups = {};
                    filteredExpenses.value.forEach(item => {
                        if (!groups[item.date]) { groups[item.date] = { items: [], dailyTotalJPY: 0 }; }
                        groups[item.date].items.push(item);
                        groups[item.date].dailyTotalJPY += toJPY(item);
                    });
                    return groups;
                });

                const saveExpense = async () => {
                    if (!expenseForm.value.amount || !expenseForm.value.name) { alert("請輸入金額及消費項目"); return; }
                    if (isEditingExpense.value) {
                        await updateDoc(doc(db, "expenses", editingExpenseId.value), expenseForm.value);
                        isEditingExpense.value = false; editingExpenseId.value = null;
                        showSuccessToast('✅ 已更新一筆');
                    } else {
                        await addDoc(collection(db, "expenses"), expenseForm.value);
                        showSuccessToast('✅ 已新增一筆');
                    }
                    expenseForm.value = { category: '飲食', name: '', date: new Date().toISOString().split('T')[0], amount: '', currency: 'JPY', payment: 'cash', payer: 'Kyle' };
                    expenseMode.value = 'list';
                };
                const editExpense = (item) => { isEditingExpense.value = true; editingExpenseId.value = item.id; expenseForm.value = { ...item }; expenseMode.value = 'input'; };
                const cancelEditExpense = () => { isEditingExpense.value = false; editingExpenseId.value = null; expenseForm.value = { category: '飲食', name: '', date: new Date().toISOString().split('T')[0], amount: '', currency: 'JPY', payment: 'cash', payer: 'Kyle' }; expenseMode.value = 'list'; };
                const removeExpense = async (id) => { if (confirm('確定刪除此筆消費？')) await deleteDoc(doc(db, "expenses", id)); };

                // --- 3. Journal (Real-time + Storage) ---
                const journalEntries = ref([]);
                onMounted(() => {
                    if (!db) return;
                    const q = query(collection(db, "journal"), orderBy("date", "desc"));
                    onSnapshot(q, (snapshot) => {
                        journalEntries.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                });

                const showJournalModal = ref(false); const isEditingJournal = ref(false); const editingJournalId = ref(null);
                const journalForm = ref({ date: '', author: 'Kyle', text: '', photos: [] }); // photos are URLs now
                const journalFiles = ref([]); // Temp storage for files before upload

                const openJournalModal = () => { const now = new Date(); journalForm.value = { date: now.toISOString().split('T')[0], author: 'Kyle', text: '', photos: [] }; journalFiles.value = []; isEditingJournal.value = false; showJournalModal.value = true; };
                const editJournal = (entry) => { isEditingJournal.value = true; editingJournalId.value = entry.id; journalForm.value = { ...entry }; journalFiles.value = []; showJournalModal.value = true; };
                const deleteJournal = async (id) => { if (confirm('確定要刪除這篇日記嗎？')) await deleteDoc(doc(db, "journal", id)); };

                const handleJournalPhotos = (event) => {
                    const files = Array.from(event.target.files);
                    // Just preview locally first is tricky with mixed URLs and Files. 
                    // Strategy: Upload immediately for simplicity in this architecture
                    files.forEach(async (file) => {
                        showSuccessToast('⏳ 上傳中...');
                        const url = await uploadFile(file, 'journal_photos');
                        journalForm.value.photos.push(url);
                        showSuccessToast('✅ 上傳成功');
                    });
                };
                const removeJournalPhoto = (index) => { journalForm.value.photos.splice(index, 1); };

                const saveJournal = async () => {
                    if (!journalForm.value.text) return;
                    const now = new Date();
                    const entryData = {
                        date: journalForm.value.date,
                        time: isEditingJournal.value ? journalForm.value.time : `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`,
                        author: journalForm.value.author,
                        text: journalForm.value.text,
                        photos: journalForm.value.photos
                    };
                    if (isEditingJournal.value) { await updateDoc(doc(db, "journal", editingJournalId.value), entryData); }
                    else { await addDoc(collection(db, "journal"), entryData); }
                    showJournalModal.value = false;
                };

                // --- 4. Vouchers (Real-time + Storage) ---
                const voucherList = ref([]);
                onMounted(() => {
                    if (!db) return;
                    onSnapshot(collection(db, "vouchers"), (snapshot) => {
                        voucherList.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                });
                const showVoucherModal = ref(false); const isEditingVoucher = ref(false); const editingVoucherId = ref(null);
                const voucherForm = ref({ title: '', fileName: '', fileUrl: '', fileType: 'image' });

                const openVoucherModal = () => { isEditingVoucher.value = false; voucherForm.value = { title: '', fileName: '', fileUrl: '', fileType: 'image' }; showVoucherModal.value = true; };
                const handleVoucherFile = async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        showSuccessToast('⏳ 上傳中...');
                        voucherForm.value.fileName = file.name;
                        voucherForm.value.fileType = file.type.includes('pdf') ? 'pdf' : 'image';
                        voucherForm.value.fileUrl = await uploadFile(file, 'vouchers');
                        showSuccessToast('✅ 上傳成功');
                    }
                };
                const saveVoucher = async () => {
                    if (!voucherForm.value.title) { alert('請輸入標題'); return; }
                    if (isEditingVoucher.value) { await updateDoc(doc(db, "vouchers", editingVoucherId.value), voucherForm.value); }
                    else { await addDoc(collection(db, "vouchers"), voucherForm.value); }
                    showVoucherModal.value = false;
                };
                const deleteVoucher = async (id) => { if(confirm('確定刪除？')) await deleteDoc(doc(db, "vouchers", id)); };

                // --- 5. Packing & Shopping (Real-time + Storage) ---
                const prepTab = ref('packing'); const packingFilter = ref('all');
                
                // Packing Categories (Structure kept in code, items in DB)
                // To simplify: We will store "packingItems" as a flat collection with "categoryId"
                const packingCategories = ref([
                    { id: 'cat_docs', title: '重要證件' },
                    { id: 'cat_clothes', title: '衣物類' },
                    { id: 'cat_elec', title: '電子產品' },
                    { id: 'cat_med', title: '藥品/護理' },
                    { id: 'cat_other', title: '其他雜項' }
                ]);
                const packingItems = ref([]);
                onMounted(() => {
                    if (!db) return;
                    onSnapshot(collection(db, "packingItems"), (snapshot) => {
                        packingItems.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                });

                // Computed Packing List Structure
                const filteredPackingList = computed(() => {
                    return packingCategories.value.map(cat => {
                        const items = packingItems.value.filter(i => i.categoryId === cat.id);
                        const filteredItems = packingFilter.value === 'all' ? items : items.filter(i => i.owner === packingFilter.value);
                        return { ...cat, items: filteredItems };
                    }).filter(cat => packingFilter.value === 'all' ? true : cat.items.length > 0);
                });
                
                const packingProgress = computed(() => {
                    const items = packingFilter.value === 'all' ? packingItems.value : packingItems.value.filter(i => i.owner === packingFilter.value);
                    if (items.length === 0) return 0;
                    const checked = items.filter(i => i.checked).length;
                    return Math.round((checked / items.length) * 100);
                });

                const togglePackingCheck = async (catId, itemId, currentStatus) => {
                    await updateDoc(doc(db, "packingItems", itemId), { checked: !currentStatus });
                };

                const showPackingModal = ref(false); const isEditingPacking = ref(false); const editingPackingId = ref(null); const editingCategoryId = ref(null);
                const packingForm = ref({ text: '', owner: 'Kyle', image: null });

                const openPackingModal = (catId, itemId = null) => {
                    editingCategoryId.value = catId;
                    if (itemId) {
                        isEditingPacking.value = true; editingPackingId.value = itemId;
                        const item = packingItems.value.find(i => i.id === itemId);
                        packingForm.value = { text: item.text, owner: item.owner, image: item.image };
                    } else {
                        isEditingPacking.value = false; packingForm.value = { text: '', owner: 'Kyle', image: null };
                    }
                    showPackingModal.value = true;
                };

                const handlePackingImage = async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        showSuccessToast('⏳ 上傳中...');
                        packingForm.value.image = await uploadFile(file, 'packing');
                        showSuccessToast('✅ 上傳成功');
                    }
                };

                const savePackingItem = async () => {
                    if (!packingForm.value.text) return;
                    const data = { categoryId: editingCategoryId.value, text: packingForm.value.text, owner: packingForm.value.owner, image: packingForm.value.image };
                    if (isEditingPacking.value) { await updateDoc(doc(db, "packingItems", editingPackingId.value), data); }
                    else { await addDoc(collection(db, "packingItems"), { ...data, checked: false }); }
                    showPackingModal.value = false;
                };
                const deletePackingItem = async (catId, itemId) => { if(confirm('刪除？')) await deleteDoc(doc(db, "packingItems", itemId)); };
                const addCategory = () => { const name = prompt("新增類別 (僅本地暫時顯示，重新整理後需修改程式碼以永久保存)"); if(name) packingCategories.value.push({id: 'cat_'+Date.now(), title: name}); };
                const removeCategory = (id) => { alert("類別為固定結構，請只刪除項目"); };

                // Shopping
                const shoppingList = ref([]);
                onMounted(() => {
                    if (!db) return;
                    onSnapshot(collection(db, "shoppingItems"), (snapshot) => {
                        shoppingList.value = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    });
                });
                const filteredShoppingList = computed(() => packingFilter.value === 'all' ? shoppingList.value : shoppingList.value.filter(i => i.owner === packingFilter.value));
                const toggleShoppingCheck = async (id, status) => { await updateDoc(doc(db, "shoppingItems", id), { bought: !status }); };
                
                const showShoppingModal = ref(false); const isEditingShopping = ref(false); const editingShoppingId = ref(null);
                const shoppingForm = ref({ name: '', note: '', owner: 'Kyle', image: null });
                const openShoppingModal = (item = null) => {
                    if (item) { isEditingShopping.value = true; editingShoppingId.value = item.id; shoppingForm.value = { ...item }; }
                    else { isEditingShopping.value = false; shoppingForm.value = { name: '', note: '', owner: 'Kyle', image: null }; }
                    showShoppingModal.value = true;
                };
                const handleShoppingImage = async (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        showSuccessToast('⏳ 上傳中...');
                        shoppingForm.value.image = await uploadFile(file, 'shopping');
                        showSuccessToast('✅ 上傳成功');
                    }
                };
                const saveShoppingItem = async () => {
                    if (!shoppingForm.value.name) return;
                    if (isEditingShopping.value) { await updateDoc(doc(db, "shoppingItems", editingShoppingId.value), shoppingForm.value); }
                    else { await addDoc(collection(db, "shoppingItems"), { ...shoppingForm.value, bought: false }); }
                    showShoppingModal.value = false;
                };
                const deleteShoppingItem = async (id) => { if(confirm('刪除？')) await deleteDoc(doc(db, "shoppingItems", id)); };

                // Helpers
                const getCategoryIcon = (cat) => ({ sightseeing: 'fas fa-camera', flight: 'fas fa-plane', transport: 'fas fa-train', food: 'fas fa-utensils', shopping: 'fas fa-shopping-bag', other: 'fas fa-sticky-note' }[cat] || 'fas fa-circle');
                const getCategoryColor = (cat) => ({ sightseeing: 'bg-emerald-400', flight: 'bg-sky-500', transport: 'bg-blue-500', food: 'bg-orange-400', shopping: 'bg-pink-400', other: 'bg-slate-400' }[cat] || 'bg-slate-400');
                const getTransportIcon = (mode) => ({ walk: 'fa-walking', train: 'fa-subway', taxi: 'fa-taxi', plane: 'fa-plane', bus: 'fa-bus' }[mode] || 'fa-car');
                const getExpenseIcon = (cat) => ({ '飲食': 'fas fa-utensils', '交通': 'fas fa-bus', '住宿': 'fas fa-bed', '門票': 'fas fa-ticket-alt', '購物': 'fas fa-shopping-bag', '其他': 'fas fa-comment-dots' }[cat]);
                const getExpenseColor = (cat) => ({ '飲食': 'bg-orange-400', '交通': 'bg-blue-500', '住宿': 'bg-indigo-500', '門票': 'bg-pink-500', '購物': 'bg-emerald-400', '其他': 'bg-slate-400' }[cat]);

                // Exchange
                const exchange = ref({ jpy: 1000, mop: 0, rate: 0.054 }); 
                const calculateMOP = () => { if(exchange.value.jpy === '') { exchange.value.mop = ''; return; } exchange.value.mop = (parseFloat(exchange.value.jpy) * exchange.value.rate).toFixed(1); };
                const calculateJPY = () => { if(exchange.value.mop === '') { exchange.value.jpy = ''; return; } exchange.value.jpy = (parseFloat(exchange.value.mop) / exchange.value.rate).toFixed(0); };
                calculateMOP();

                onMounted(() => {
                    const snowContainer = document.getElementById('snow-container');
                    for(let i=0; i<30; i++) { const flake = document.createElement('div'); flake.classList.add('snowflake'); const size = Math.random() * 5 + 2 + 'px'; flake.style.width = size; flake.style.height = size; flake.style.left = Math.random() * 100 + 'vw'; flake.style.animationDuration = Math.random() * 5 + 5 + 's'; flake.style.animationDelay = Math.random() * 5 + 's'; snowContainer.appendChild(flake); }
                    if(currentTab.value === 'schedule') initSortable();
                });

                return {
                    isLoading,
                    currentTab, selectedDayIndex, scheduleData, currentDaySchedule, bookingCategory, weatherForecast, currentDayWeather, countdown, isRealTimeWeather,
                    showScheduleModal, isEditingSchedule, scheduleForm, openScheduleModal, editScheduleItem, saveSchedule, removeScheduleItem, isSaving,
                    flightData, showFlightModal, flightForm, editFlight, saveFlight,
                    hotelData, showHotelModal, hotelForm, openHotelModal, saveHotel,
                    tourData, showTourModal, tourForm, openTourModal, saveTour,
                    voucherList, showVoucherModal, isEditingVoucher, voucherForm, openVoucherModal, handleVoucherFile, saveVoucher, deleteVoucher, 
                    showPreviewModal, previewSrc, previewType, openMediaPreview,
                    expenseMode, expenseFilter, expenseList, isEditingExpense, expenseForm, saveExpense, editExpense, cancelEditExpense, removeExpense, 
                    totalExpensesJPY, totalCashJPY, totalCardJPY, totalEpayJPY, groupedExpenses, mopToJpyRate,
                    journalEntries, showJournalModal, isEditingJournal, journalForm, openJournalModal, editJournal, deleteJournal, saveJournal, handleJournalPhotos, removeJournalPhoto,
                    exchange, calculateMOP, calculateJPY,
                    prepTab, packingFilter, filteredPackingList, packingProgress, addCategory, removeCategory, togglePackingCheck,
                    showPackingModal, isEditingPacking, packingForm, openPackingModal, handlePackingImage, savePackingItem, deletePackingItem, 
                    shoppingList, filteredShoppingList, showShoppingModal, isEditingShopping, shoppingForm, openShoppingModal, handleShoppingImage, saveShoppingItem, deleteShoppingItem, toggleShoppingCheck,
                    getCategoryIcon, getCategoryColor, getTransportIcon, getExpenseIcon, getExpenseColor, restaurantData,
                    isMusicPlaying, toggleMusic, withAuth, showPasswordModal, passwordInput, verifyPassword,
                    showOutfitModal, outfitForm, openOutfitModal, saveOutfit, showToast, toastMessage,
                    changeDay, listKey, dateScrollContainer
                };
            }
        }).mount('#app');
    </script>
</body>
</html>